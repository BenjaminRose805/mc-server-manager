{
  "id": "snapshot_1771049188703_pdf88dv2s",
  "approvalId": "approval_1771049140798_9kk1p27wc",
  "approvalTitle": "Updated tech.md â€” added pino-roll dep, data/logs/ storage, updated known limitations",
  "version": 3,
  "timestamp": "2026-02-14T06:06:28.703Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Technology Stack\n\n## Project Type\n\nSelf-hosted web + desktop application. Monorepo with 4 npm workspace packages: backend (API server), frontend (React SPA), electron (desktop wrapper), shared (TypeScript types).\n\n## Core Technologies\n\n### Primary Language\n- **Language**: TypeScript 5.7+ (strict mode everywhere)\n- **Runtime**: Node.js (ES2022 target)\n- **Module System**: ES Modules (`.js` extensions required in backend imports)\n\n### Backend (`packages/backend/`)\n\n| Technology | Version | Purpose |\n|-----------|---------|---------|\n| Express | 4.x | HTTP API server |\n| ws | 8.x | WebSocket server (single endpoint: `/ws`) |\n| better-sqlite3 | 12.x | SQLite database (synchronous API, WAL mode) |\n| Zod | 3.x | Request validation (all route handlers) |\n| Pino | 9.x | Structured logging (stdout + file via pino-roll) |\n| pino-roll | 0.2.x | Log file rotation (daily, 7-file retention) |\n| nanoid | 5.x | ID generation |\n| argon2 | 0.44.x | Password hashing (argon2id) |\n| jsonwebtoken | 9.x | JWT access tokens (HS256, 15min expiry) |\n| express-rate-limit | 8.x | Rate limiting |\n| helmet | 8.x | Security headers |\n| cors | 2.x | CORS configuration |\n| @root/acme | 3.x | Let's Encrypt ACME client (TLS provisioning) |\n| node-forge | 1.x | Self-signed TLS certificate generation |\n| nat-upnp | 1.x | UPnP port forwarding |\n| adm-zip | 0.5.x | ZIP file handling (modpacks) |\n| yauzl-promise | 4.x | ZIP extraction (modpacks) |\n| smol-toml | 1.x | TOML parsing (mod metadata) |\n\n### Frontend (`packages/frontend/`)\n\n| Technology | Version | Purpose |\n|-----------|---------|---------|\n| React | 19.x | UI framework |\n| Vite | 6.x | Build tool + dev server (port 5173, proxies to backend) |\n| Tailwind CSS | 4.x | Styling (dark theme: slate-800/900) |\n| Zustand | 5.x | State management (stores write directly from WS events) |\n| React Router | 7.x | Client-side routing |\n| @tanstack/react-virtual | 3.x | Virtualized list rendering (console, message lists) |\n| lucide-react | 0.563.x | Icons |\n| sonner | 2.x | Toast notifications |\n| clsx + tailwind-merge | latest | Conditional class name utility (`cn()` helper) |\n\n### Electron (`packages/electron/`)\n\n| Technology | Version | Purpose |\n|-----------|---------|---------|\n| Electron | 33.x | Desktop shell (window, tray, backend lifecycle) |\n| electron-builder | 25.x | Desktop packaging (Windows NSIS, macOS DMG, Linux AppImage/DEB) |\n| safeStorage API | built-in | OS-level credential encryption |\n| contextBridge | built-in | Secure IPC (contextIsolation: true, nodeIntegration: false) |\n| globalShortcut | built-in | Global keyboard shortcuts (push-to-talk, future use) |\n\n### Shared (`shared/`)\n\n| Technology | Purpose |\n|-----------|---------|\n| TypeScript | Shared type definitions consumed by all packages |\n| @mc-server-manager/shared | Package name, single `src/index.ts` barrel export |\n\n## Application Architecture\n\n### Core Pattern\n\n```\nRoutes (HTTP) --> Services (business logic) --> Models (SQLite)\n                        |\n                        +---> ServerManager --> ServerProcess (child_process.spawn)\n                        +---> File I/O (server.properties, JARs, mods)\n\nWebSocket Server ---> Same services, different transport\n```\n\n- **Routes**: Express routers with Zod validation. Thin -- delegate to services.\n- **Services**: Business logic singletons. The only layer that touches models.\n- **Models**: Raw SQL with prepared statements via better-sqlite3. Map snake_case DB columns to camelCase TypeScript.\n- **No ORM**: Intentional. Raw SQL is preferred for this project's complexity level.\n- **No DI container**: Services are singletons imported directly. No IoC framework.\n\n### State Management\n\n- **Backend**: Singleton `ServerManager` holds `Map<serverId, ServerProcess>`. In-memory presence via `PresenceManager` EventEmitter.\n- **Frontend**: Zustand stores are the source of truth. WebSocket events write directly to store at module initialization.\n\n### Real-time Communication\n\n- Single WebSocket endpoint: `ws://localhost:3001/ws`\n- Auth via first message: `{ type: 'auth', token: '...' }` (NOT query params)\n- Client -> Server: `subscribe`, `unsubscribe`, `command`, `chat:send`, `chat:typing`\n- Server -> Client: `console`, `console:history`, `status`, `stats`, `error`, `chat:message`, `chat:typing`, `presence:update`, `friend:*`\n- All messages JSON with `type` discriminator field\n\n### Authentication Flow\n\n```\nSetup (first user) or Register (invite code) or Login\n  --> JWT access token (15min, HS256) + refresh token (30 days, SHA-256 hashed in DB)\n  --> Access token in Authorization header for REST\n  --> Access token sent as first WS message for WebSocket\n  --> Auto-refresh 1 minute before expiry via React AuthContext\n  --> Single-user mode: skip all auth if no users exist in DB\n```\n\n### Electron Desktop Flow\n\n```\nElectron main process starts\n  --> Spawns backend (child_process.fork or spawn)\n  --> Waits for backend to be ready (HTTP health check)\n  --> Creates BrowserWindow loading frontend URL\n  --> Registers IPC handlers (auth, launcher, Java)\n  --> Sets up system tray (close-to-tray behavior)\n  --> On quit: gracefully stops all MC servers via backend, then exits\n```\n\n### Microsoft Auth (Electron only)\n\n```\nUser clicks \"Sign In\"\n  --> Renderer: window.electronAPI.msAuthStart()\n  --> Main process: Microsoft device code flow (OAuth2)\n  --> User authenticates on microsoft.com\n  --> Main process: Xbox Live -> XSTS -> Minecraft Services -> Profile\n  --> Credentials stored via safeStorage (OS keychain encryption)\n  --> Renderer polls via window.electronAPI.msAuthPoll()\n```\n\n## Data Storage\n\n- **Primary**: SQLite via better-sqlite3 (file: `data/mc-manager.db`)\n- **Logs**: Pino JSON logs in `data/logs/app.log` (daily rotation, 7-day retention via pino-roll). Frontend logs are shipped to the same file via `POST /api/log`.\n- **Mode**: WAL (Write-Ahead Logging) for concurrent read/write\n- **Migrations**: 9 numbered SQL files in `packages/backend/migrations/` (001-009)\n  - 001: servers table\n  - 002: settings key-value store\n  - 003: mods (installed_mods table)\n  - 004: mod side field\n  - 005: modpacks\n  - 006: launcher instances\n  - 007: launcher accounts\n  - 008: client mods (instance_id on installed_mods)\n  - 009: multi-user (users, invitations, refresh_tokens, server_permissions tables)\n- **Credentials**: Encrypted via Electron safeStorage in `{userData}/secure-storage.json`\n- **Server files**: `data/servers/{nanoid}/` (server.properties, JARs, world data, mods/)\n\n## Development Environment\n\n### Build & Dev\n\n```bash\nnpm install                    # Install all workspace dependencies\nnpm run dev                    # Both servers concurrently (backend + frontend)\nnpm run dev -w backend         # tsx watch on port 3001\nnpm run dev -w frontend        # Vite on port 5173\nnpm run build                  # shared -> backend -> frontend (order matters)\nnpm run build -w shared        # Must build first (TypeScript project references)\n```\n\n### Build Order (enforced by TS project references)\n1. `shared/` -- types consumed by all packages\n2. `packages/backend/` -- references shared\n3. `packages/frontend/` -- references shared\n4. `packages/electron/` -- references shared + backend\n\n### Code Quality\n\n- **TypeScript**: Strict mode, `tsconfig.base.json` shared config\n- **No linter configured**: (consider adding ESLint in future)\n- **No formatter configured**: (consider adding Prettier in future)\n- **No automated tests**: All testing is manual. This is a known gap.\n\n### Version Control\n- **VCS**: Git\n- **Branching**: Feature branches off main\n- **Commit style**: Conventional-ish (no strict enforcement)\n\n## Technical Decisions & Rationale\n\n### Decision Log\n\n1. **stdin for MC commands (not RCON)**: Universal across all server types. RCON requires additional setup and doesn't work with all server JARs.\n\n2. **Ring buffer (1000 lines) for console**: Avoids unbounded memory. Minecraft can emit hundreds of lines/sec during world generation. Combined with @tanstack/react-virtual for efficient rendering.\n\n3. **better-sqlite3 (synchronous) over async alternatives**: Simplicity. WAL mode handles concurrent reads. The app is single-process Node.js, not a distributed system.\n\n4. **Zustand over Redux/Context**: Minimal boilerplate. Direct store mutations from WS events at module level (no React tree dependency). Perfect for the event-driven architecture.\n\n5. **No ORM**: Raw SQL is simpler for this project's scale. Prepared statements + thin model functions provide enough abstraction.\n\n6. **Electron over Tauri**: Single language (TypeScript). Tauri was originally chosen but removed because maintaining Rust alongside TypeScript doubled the toolchain complexity. Electron's safeStorage provides equivalent OS-level encryption. The migration was completed in the `electron-migration` spec.\n\n7. **JWT + refresh tokens over sessions-only**: Stateless access tokens reduce DB lookups on every request. Refresh tokens in DB allow revocation. 15-minute access token expiry limits exposure from token theft.\n\n8. **No external auth providers (yet)**: Self-hosted philosophy. Microsoft auth is only for Minecraft account linking (game launching), not for app login.\n\n9. **Tailwind CSS 4 (no component library)**: Hand-built components give full control over the dark theme aesthetic. No runtime CSS-in-JS overhead. Consistent with the \"minimal dependencies\" principle.\n\n10. **Single WebSocket endpoint**: All real-time communication (console, status, chat, presence, friends) multiplexed on one WS connection with `type` discriminator. Simpler than multiple endpoints; subscription model controls what data flows.\n\n## Known Limitations\n\n- **No automated tests**: All verification is manual or build-based. High-risk area.\n- **Single-node only**: The app assumes one machine. No clustering, no distributed state.\n- **SQLite concurrency**: WAL mode helps but won't scale to hundreds of concurrent writers.\n- **No hot reload for Electron**: Changes to main process require restart.\n- **Console buffer is volatile**: 1000-line ring buffer is lost on server restart. Application logs persist to `data/logs/` but MC server console output is not persisted beyond the ring buffer.\n- **No code linting or formatting**: No ESLint/Prettier configured. Consistency relies on convention and AI agents following AGENTS.md.\n",
  "fileStats": {
    "size": 10347,
    "lines": 216,
    "lastModified": "2026-02-14T06:05:14.185Z"
  },
  "comments": []
}