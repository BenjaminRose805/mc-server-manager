{
  "id": "snapshot_1771010648448_hj4mbehu3",
  "approvalId": "approval_1771010578112_5x6aw7kbv",
  "approvalTitle": "Steering: structure.md - Codebase organization, conventions, patterns",
  "version": 2,
  "timestamp": "2026-02-13T19:24:08.448Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Project Structure\n\n## Directory Organization\n\n```\nmc-server-manager/\n├── package.json                 # Root workspace config, dev/build/lint scripts\n├── tsconfig.base.json           # Shared TS config (ES2022, strict, bundler resolution)\n├── AGENTS.md                    # AI agent instructions (project overview, conventions)\n├── PLAN.md                      # Architecture document and phased build plan\n│\n├── packages/\n│   ├── backend/                 # Express + WebSocket API server\n│   │   ├── package.json\n│   │   ├── tsconfig.json        # References shared/\n│   │   ├── AGENTS.md            # Backend-specific AI instructions\n│   │   ├── migrations/          # Numbered SQL files (001-009)\n│   │   │   ├── 001_initial.sql          # servers table\n│   │   │   ├── 002_settings.sql         # settings key-value store\n│   │   │   ├── 003_mods.sql             # installed_mods table\n│   │   │   ├── 004_mod_side.sql         # mod side field\n│   │   │   ├── 005_modpacks.sql         # modpack tracking\n│   │   │   ├── 006_launcher_instances.sql  # game instances\n│   │   │   ├── 007_launcher_accounts.sql   # Microsoft accounts\n│   │   │   ├── 008_client_mods.sql      # client mod support (instance_id)\n│   │   │   └── 009_multi_user.sql       # users, invitations, refresh_tokens, server_permissions\n│   │   └── src/\n│   │       ├── index.ts         # HTTP/HTTPS server creation, WS setup, startup\n│   │       ├── app.ts           # Express app: middleware + route mounting\n│   │       ├── config.ts        # Environment config (port, host, TLS, data dir)\n│   │       ├── db.ts            # Database singleton (better-sqlite3 init + migrations)\n│   │       ├── routes/          # Express routers (one file per domain)\n│   │       │   ├── servers.ts           # /api/servers/* CRUD + start/stop/command\n│   │       │   ├── auth.ts              # /api/auth/* setup/register/login/refresh/logout\n│   │       │   ├── users.ts             # /api/users/* profile + admin management\n│   │       │   ├── invitations.ts       # /api/invitations/* CRUD\n│   │       │   ├── launcher.ts          # /api/launcher/* instances/prepare/java\n│   │       │   ├── mods.ts              # /api/servers/:id/mods/* server mod management\n│   │       │   ├── instance-mods.ts     # /api/launcher/instances/:id/mods/* client mods\n│   │       │   ├── modpacks.ts          # /api/modpacks/* import/export\n│   │       │   ├── versions.ts          # /api/versions/* Mojang version manifest\n│   │       │   ├── downloads.ts         # /api/downloads/* JAR download jobs\n│   │       │   ├── system.ts            # /api/system/* Java, info, settings\n│   │       │   ├── acme.ts              # /api/acme/* Let's Encrypt challenges\n│   │       │   ├── logs.ts              # /api/servers/:id/logs\n│   │       │   └── validation.ts        # Shared Zod schemas\n│   │       ├── services/        # Business logic singletons\n│   │       │   ├── server-manager.ts    # Core: ServerProcess orchestrator\n│   │       │   ├── process.ts           # ServerProcess class (child_process.spawn)\n│   │       │   ├── console-buffer.ts    # Ring buffer (1000 lines)\n│   │       │   ├── auth.ts              # Password hashing (argon2id)\n│   │       │   ├── jwt.ts              # JWT generation/verification\n│   │       │   ├── session.ts           # Refresh token lifecycle\n│   │       │   ├── brute-force.ts       # Login attempt tracking\n│   │       │   ├── database.ts          # DB init + migration runner\n│   │       │   ├── settings.ts          # App settings service\n│   │       │   ├── java.ts              # Java detection + Adoptium download\n│   │       │   ├── tls.ts              # TLS/HTTPS (Let's Encrypt, self-signed)\n│   │       │   ├── upnp.ts             # UPnP port forwarding\n│   │       │   ├── mod-manager.ts       # Mod CRUD + Modrinth API\n│   │       │   ├── mod-loader-service.ts # Fabric/Forge loader installation\n│   │       │   ├── mod-jar-inspector.ts # JAR metadata extraction (fabric.mod.json, etc.)\n│   │       │   ├── modpack-manager.ts   # .mrpack import/export\n│   │       │   ├── modpack-parser.ts    # Modpack format parsing\n│   │       │   ├── modpack-update-checker.ts # Modpack version checking\n│   │       │   ├── search-orchestrator.ts # Modrinth search coordination\n│   │       │   ├── instance-service.ts  # Game instance management\n│   │       │   ├── version-service.ts   # Minecraft version resolution\n│   │       │   ├── library-service.ts   # Game library downloads\n│   │       │   ├── asset-service.ts     # Game asset downloads\n│   │       │   ├── download.ts          # JAR download with progress\n│   │       │   ├── event-bus.ts         # Internal event bus\n│   │       │   ├── server-setup.ts      # Server directory initialization\n│   │       │   ├── properties.ts        # server.properties parser/writer\n│   │       │   └── versions.ts          # Mojang version manifest cache\n│   │       ├── models/          # Raw SQL data access (prepared statements)\n│   │       │   ├── server.ts            # servers table CRUD\n│   │       │   ├── user.ts              # users table CRUD\n│   │       │   ├── invitation.ts        # invitations table CRUD\n│   │       │   ├── server-permission.ts # server_permissions table CRUD\n│   │       │   ├── mod.ts               # installed_mods table CRUD\n│   │       │   ├── modpack.ts           # modpack tracking\n│   │       │   ├── instance.ts          # launcher instances table CRUD\n│   │       │   └── account.ts           # launcher accounts table CRUD\n│   │       ├── middleware/      # Express middleware\n│   │       │   ├── auth.ts              # requireAuth, requireRole, requireServerPermission\n│   │       │   ├── rate-limit.ts        # Rate limiting rules\n│   │       │   ├── cors-config.ts       # CORS configuration\n│   │       │   └── security.ts          # Helmet security headers\n│   │       ├── utils/           # Utilities\n│   │       │   └── errors.ts            # AppError, NotFoundError, ConflictError, etc.\n│   │       └── ws/              # WebSocket handlers\n│   │\n│   ├── frontend/                # React SPA\n│   │   ├── package.json\n│   │   ├── tsconfig.json\n│   │   ├── AGENTS.md            # Frontend-specific AI instructions\n│   │   ├── vite.config.ts       # Proxy /api and /ws to backend port 3001\n│   │   ├── index.html\n│   │   └── src/\n│   │       ├── main.tsx         # Entry: providers (AuthProvider), render\n│   │       ├── App.tsx          # Routing: React Router, ProtectedRoute wrapping\n│   │       ├── index.css        # Single line: @import \"tailwindcss\"\n│   │       ├── pages/           # Page components (default exports)\n│   │       │   ├── Dashboard.tsx        # Server grid with status cards\n│   │       │   ├── ServerDetail.tsx     # Tabbed: Console, Settings, Mods\n│   │       │   ├── CreateServer.tsx     # 4-step creation wizard\n│   │       │   ├── Mods.tsx             # Mod search/browse (Modrinth)\n│   │       │   ├── Launcher.tsx         # Game instances overview\n│   │       │   ├── InstanceDetail.tsx   # Instance config + launch\n│   │       │   ├── Login.tsx            # Login form\n│   │       │   ├── Register.tsx         # Invite code registration\n│   │       │   ├── Setup.tsx            # First-run owner account creation\n│   │       │   ├── Admin.tsx            # User/invitation management\n│   │       │   └── AppSettings.tsx      # App configuration\n│   │       ├── components/      # Reusable components (named exports)\n│   │       │   ├── Layout.tsx           # Sidebar + main content shell\n│   │       │   ├── Console.tsx          # Virtualized terminal + command input\n│   │       │   ├── ServerCard.tsx       # Dashboard status card\n│   │       │   ├── ServerControls.tsx   # Start/Stop/Restart/Kill buttons\n│   │       │   ├── ServerStats.tsx      # Real-time stats display\n│   │       │   ├── StatusBadge.tsx      # Colored status indicator\n│   │       │   ├── PropertiesForm.tsx   # server.properties grouped editor\n│   │       │   ├── ModList.tsx          # Mod listing component\n│   │       │   ├── ModFilterBar.tsx     # Mod search/filter controls\n│   │       │   ├── mod-badges.tsx       # Mod status badges\n│   │       │   ├── LogViewer.tsx        # Log display component\n│   │       │   ├── DeleteServerDialog.tsx # Confirmation dialog\n│   │       │   ├── ErrorBoundary.tsx    # Global error boundary\n│   │       │   ├── ProtectedRoute.tsx   # Auth guard for routes\n│   │       │   └── launcher/            # Game launcher components\n│   │       │       ├── AccountManager.tsx       # Microsoft account management\n│   │       │       ├── LaunchButton.tsx          # Game launch button\n│   │       │       ├── InstanceCard.tsx          # Instance preview card\n│   │       │       ├── InstanceGrid.tsx          # Instance grid layout\n│   │       │       ├── CreateInstanceWizard.tsx  # Instance creation flow\n│   │       │       └── DownloadProgress.tsx      # Download progress bar\n│   │       ├── stores/          # Zustand stores\n│   │       │   └── serverStore.ts       # Server state + WS event wiring\n│   │       ├── api/             # API clients + WebSocket\n│   │       │   ├── client.ts            # Fetch wrapper (BASE_URL, auth headers)\n│   │       │   ├── ws.ts               # WebSocket singleton + auto-reconnect\n│   │       │   ├── auth.ts             # Auth API (setup, login, register, refresh)\n│   │       │   ├── users.ts            # User management API\n│   │       │   └── invitations.ts      # Invitation API\n│   │       ├── contexts/        # React contexts\n│   │       │   └── AuthContext.tsx       # Auth state, token refresh, login/logout\n│   │       ├── utils/           # Utility functions\n│   │       │   ├── desktop.ts           # isDesktop(), getBackendBaseUrl() (Electron detection)\n│   │       │   └── ...\n│   │       ├── types/           # Ambient type declarations\n│   │       │   └── electron.d.ts        # window.electronAPI interface\n│   │       ├── hooks/           # Custom React hooks\n│   │       │   └── useConsole.ts        # Per-server WS subscription lifecycle\n│   │       └── lib/\n│   │           └── utils.ts             # cn() utility (clsx + tailwind-merge)\n│   │\n│   └── electron/                # Electron desktop app\n│       ├── package.json         # electron-builder config embedded\n│       ├── tsconfig.json\n│       └── src/\n│           ├── main.ts          # Window creation, tray, backend lifecycle, shutdown\n│           ├── preload.ts       # contextBridge: exposes electronAPI to renderer\n│           ├── ipc.ts           # ipcMain.handle registration for all channels\n│           ├── tray.ts          # System tray setup\n│           ├── auth.ts          # Microsoft OAuth device code flow (ported from Rust)\n│           ├── launcher.ts      # Minecraft game process spawning + tracking\n│           └── secure-storage.ts # safeStorage encryption for credentials\n│\n├── shared/                      # Shared TypeScript types\n│   ├── package.json             # @mc-server-manager/shared\n│   ├── tsconfig.json\n│   └── src/\n│       └── index.ts             # ALL shared types, interfaces, constants, utilities\n│\n├── data/                        # Runtime data (gitignored)\n│   ├── mc-manager.db            # SQLite database\n│   └── servers/                 # Individual MC server directories (nanoid-named)\n│\n├── plans/                       # Architecture planning documents\n│   └── EPIC-*.md\n│\n└── .spec-workflow/              # Spec workflow system\n    ├── templates/               # Default templates (auto-managed)\n    ├── user-templates/          # Custom project-specific templates\n    ├── steering/                # Product/tech/structure steering docs\n    │   ├── product.md\n    │   ├── tech.md\n    │   └── structure.md\n    └── specs/                   # Feature specifications\n        └── {spec-name}/\n            ├── requirements.md\n            ├── design.md\n            ├── tasks.md\n            └── Implementation Logs/\n```\n\n## Naming Conventions\n\n### Files\n- **All source files**: `kebab-case.ts` / `kebab-case.tsx` (e.g., `server-manager.ts`, `console-buffer.ts`)\n- **React pages**: `PascalCase.tsx` (e.g., `Dashboard.tsx`, `ServerDetail.tsx`) -- default exports\n- **React components**: `PascalCase.tsx` (e.g., `AccountManager.tsx`) -- named exports\n- **Exception**: `mod-badges.tsx` uses kebab-case (lowercase component file)\n- **Migrations**: `NNN_description.sql` (e.g., `001_initial.sql`, `009_multi_user.sql`)\n- **Types**: Declared in `shared/src/index.ts`, not in separate `.d.ts` files (except `electron.d.ts` for ambient window types)\n\n### Code\n- **Interfaces/Types**: `PascalCase` (e.g., `ServerProcess`, `LauncherAccount`)\n- **Functions/Variables**: `camelCase` (e.g., `detectJava`, `serverManager`)\n- **Constants**: `UPPER_SNAKE_CASE` for true constants (e.g., `MS_CLIENT_ID`), `camelCase` for configured values\n- **Database columns**: `snake_case` (e.g., `created_at`, `server_id`, `is_active`)\n- **API routes**: `kebab-case` (e.g., `/api/servers/:id/properties`, `/api/auth/logout-all`)\n- **WebSocket message types**: `colon:separated` (e.g., `chat:send`, `presence:update`)\n- **IPC channels**: `kebab-case` (e.g., `ms-auth-start`, `launch-game`)\n\n## Import Patterns\n\n### Import Order (all packages)\n1. Node.js built-ins (`node:fs`, `node:path`, `node:crypto`)\n2. External dependencies (`express`, `zod`, `pino`)\n3. Workspace packages (`@mc-server-manager/shared`)\n4. Internal absolute imports (`@/utils/...` in frontend via Vite alias)\n5. Relative imports (`./errors.js`, `../models/user.js`)\n\n### Backend-specific\n- **`.js` extensions required** in all relative imports (ES module resolution)\n- Example: `import { db } from '../db.js'` NOT `import { db } from '../db'`\n\n### Frontend-specific\n- **`@/` alias** maps to `src/` (configured in Vite)\n- Example: `import { isDesktop } from '@/utils/desktop'`\n- No `.js` extensions needed (Vite handles resolution)\n\n### Shared package\n- Import as: `import type { ServerProcess } from '@mc-server-manager/shared'`\n- Use `import type` when importing only types (tree-shaking friendly)\n\n## Code Structure Patterns\n\n### Backend Route File\n```typescript\nimport { Router } from 'express'\nimport { z } from 'zod'\nimport { requireAuth, requireAdminOrOwner } from '../middleware/auth.js'\nimport { someService } from '../services/some-service.js'\n\nconst router = Router()\n\nconst createSchema = z.object({\n  name: z.string().min(1).max(100),\n})\n\nrouter.post('/', requireAuth, async (req, res, next) => {\n  try {\n    const data = createSchema.parse(req.body)\n    const result = someService.create(data)\n    res.status(201).json(result)\n  } catch (err) {\n    next(err)\n  }\n})\n\nexport default router\n```\n\n### Backend Model File\n```typescript\nimport { db } from '../db.js'\nimport { nanoid } from 'nanoid'\nimport type { SomeType } from '@mc-server-manager/shared'\n\nexport function createSomething(data: CreateInput): SomeType {\n  const id = nanoid()\n  const stmt = db.prepare(`INSERT INTO table_name (id, field) VALUES (?, ?)`)\n  stmt.run(id, data.field)\n  return getSomethingById(id)!\n}\n\nexport function getSomethingById(id: string): SomeType | null {\n  const stmt = db.prepare(`SELECT * FROM table_name WHERE id = ?`)\n  const row = stmt.get(id) as any\n  if (!row) return null\n  return {\n    id: row.id,\n    fieldName: row.field_name,  // snake_case -> camelCase mapping\n    createdAt: row.created_at,\n  }\n}\n```\n\n### Frontend Zustand Store\n```typescript\nimport { create } from 'zustand'\nimport type { SomeType } from '@mc-server-manager/shared'\n\ninterface SomeStore {\n  items: SomeType[]\n  activeId: string | null\n  setItems: (items: SomeType[]) => void\n  addItem: (item: SomeType) => void\n  setActive: (id: string | null) => void\n}\n\nexport const useSomeStore = create<SomeStore>((set) => ({\n  items: [],\n  activeId: null,\n  setItems: (items) => set({ items }),\n  addItem: (item) => set((s) => ({ items: [...s.items, item] })),\n  setActive: (activeId) => set({ activeId }),\n}))\n```\n\n### Frontend Page\n```typescript\nimport { useEffect, useState } from 'react'\nimport { SomeComponent } from '@/components/some/SomeComponent'\nimport { fetchItems } from '@/api/some'\n\nexport default function SomePage() {\n  const [items, setItems] = useState([])\n\n  useEffect(() => {\n    fetchItems().then(setItems)\n  }, [])\n\n  return (\n    <div className=\"p-6\">\n      <h1 className=\"text-2xl font-bold text-white mb-4\">Page Title</h1>\n      <SomeComponent items={items} />\n    </div>\n  )\n}\n```\n\n### Electron IPC Pattern\n```typescript\n// Main process (ipc.ts): register handler\nipcMain.handle('some-action', async (event, arg1: string) => {\n  return await doSomething(arg1)\n})\n\n// Preload (preload.ts): expose via contextBridge\ncontextBridge.exposeInMainWorld('electronAPI', {\n  someAction: (arg1: string) => ipcRenderer.invoke('some-action', arg1),\n})\n\n// Renderer (component): call via window.electronAPI\nconst result = await window.electronAPI.someAction('value')\n```\n\n## Module Boundaries\n\n### Dependency Direction (strict)\n```\nshared/          <-- imported by all packages (types only, no runtime code)\n  ^\npackages/backend/   <-- never imports from frontend or electron\n  ^\npackages/frontend/  <-- never imports from backend or electron directly\n  ^                     (communicates via HTTP/WS only)\npackages/electron/  <-- imports from shared; calls backend via HTTP\n                        exposes API to frontend via contextBridge\n```\n\n### Key Boundaries\n- **Frontend -- Backend**: HTTP REST + WebSocket only. No shared runtime code.\n- **Frontend -- Electron**: `window.electronAPI` via contextBridge only. No direct `require('electron')`.\n- **Electron -- Backend**: HTTP fetch from main process. Backend doesn't know about Electron.\n- **Services -- Routes**: Routes are thin; business logic lives in services.\n- **Models -- Services**: Models are pure data access; no business logic in models.\n\n## Code Size Guidelines\n\n- **File size**: Aim for under 300 lines. Split if exceeding 500.\n- **Function size**: Aim for under 50 lines. Extract helpers if exceeding 80.\n- **Component size**: One component per file. Split into sub-components if the JSX exceeds 150 lines.\n- **Route files**: One domain per file (servers.ts, auth.ts, users.ts). Split CRUD from specialized endpoints if the file gets large.\n\n## Documentation Standards\n\n- **No JSDoc required** on internal functions (TypeScript types serve as docs)\n- **JSDoc on public/exported functions** that have non-obvious behavior\n- **Inline comments** for \"why\", not \"what\" (the code says what, comments say why)\n- **AGENTS.md** files are the primary documentation for AI agents (root + per-package)\n- **No README.md files per package** -- AGENTS.md covers the whole project\n",
  "fileStats": {
    "size": 20582,
    "lines": 387,
    "lastModified": "2026-02-13T19:22:54.118Z"
  },
  "comments": []
}