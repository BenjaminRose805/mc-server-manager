{
  "id": "snapshot_1771126437356_bqbu0t1b4",
  "approvalId": "approval_1771126437330_4oekm0u1i",
  "approvalTitle": "Tasks: Launcher Download Progress",
  "version": 1,
  "timestamp": "2026-02-15T03:33:57.356Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n- [ ] 1. Add shared types and remove dead code in shared package\n  - Files: `shared/src/index.ts` (modify)\n  - Add `PreparePhase` type alias and `PrepareJob` interface. Remove the dead `DownloadProgressInfo` interface (line ~890, confirmed zero imports).\n  - Purpose: Foundation types for the async prepare job system, and dead code cleanup.\n  - _Leverage: `shared/src/index.ts` — existing `DownloadJob`/`DownloadJobStatus` types (line ~171) for structural reference, existing `PrepareResponse` interface (line ~897) which `PrepareJob.result` references._\n  - _Requirements: REQ-1 (job type), REQ-5 (dead code removal)_\n  - _Prompt: Implement the task for spec launcher-download-progress, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: TypeScript Developer | Task: Read `shared/src/index.ts` to understand existing type patterns. (1) Add the following types after the `PrepareResponse` interface (around line 905): `export type PreparePhase = \"pending\" | \"version\" | \"libraries\" | \"assets\" | \"completed\" | \"failed\";` and `export interface PrepareJob { id: string; instanceId: string; mcVersion: string; phase: PreparePhase; progress: number; phaseCurrent: number; phaseTotal: number; result: PrepareResponse | null; error?: string; createdAt: number; }`. (2) Remove the `DownloadProgressInfo` interface (line ~890-895) — it has zero imports anywhere in the codebase. | Restrictions: Do NOT remove or rename any other existing types or exports. Do NOT add implementation code — types only. Follow existing naming conventions. | _Leverage: `shared/src/index.ts` for `DownloadJob` (line 178) as structural reference and `PrepareResponse` (line 897) which is referenced by `PrepareJob.result`. | Success: `npm run build -w shared` passes. `PreparePhase` and `PrepareJob` are exported. `DownloadProgressInfo` is gone. All other existing types unchanged. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 2. Thread AbortSignal through VersionService, AssetService, and LibraryService\n  - Files: `packages/backend/src/services/version-service.ts` (modify), `packages/backend/src/services/asset-service.ts` (modify), `packages/backend/src/services/library-service.ts` (modify)\n  - Add an optional `signal?: AbortSignal` parameter to download methods and pass it to all `fetch()` calls.\n  - Purpose: Enable cancellation of in-flight HTTP requests when a prepare job is cancelled.\n  - _Leverage: `packages/backend/src/services/version-service.ts` — `downloadVersionJson()` (line 60) and `downloadGameJar()` (line 99) each call `fetch()`. `packages/backend/src/services/asset-service.ts` — `downloadAssets()` (line 77) and private `downloadAsset()` (line 118) each call `fetch()`. `packages/backend/src/services/library-service.ts` — `downloadLibraries()` (line 52) and private `downloadArtifact()` (line 222) each call `fetch()`._\n  - _Requirements: REQ-3 (cancellation)_\n  - _Prompt: Implement the task for spec launcher-download-progress, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer | Task: Read the three service files to understand their fetch patterns. Add an optional `signal?: AbortSignal` parameter to these methods: (1) `VersionService.downloadVersionJson(versionId: string, signal?: AbortSignal)` — pass `{ signal }` to both `fetch()` calls (manifest fetch at line 37 and version JSON fetch at line 77). (2) `VersionService.downloadGameJar(versionId: string, signal?: AbortSignal)` — pass `{ signal }` to the `fetch()` call at line 132. Also pass signal to the internal `downloadVersionJson` call. (3) `AssetService.downloadAssets(versionJson, onProgress?, signal?)` — pass signal through to private `downloadAsset()`. In `downloadAsset()`, add `signal?: AbortSignal` parameter and pass `{ signal }` to `fetch()` at line 130. (4) `LibraryService.downloadLibraries(versionJson, onProgress?, signal?)` — pass signal through to private `downloadLibrary()` and `downloadArtifact()`. In `downloadArtifact()`, add `signal?: AbortSignal` and pass `{ signal }` to `fetch()` at line 228. For all fetch calls that already have an options object, merge signal into it: `fetch(url, { ...existingOpts, signal })`. For those with no options, just pass `fetch(url, { signal })`. | Restrictions: All new parameters MUST be optional — existing callers must continue to work unchanged. Do NOT change any existing function signatures in a breaking way. Do NOT rename methods. Use `.js` extension in any new imports. | Success: All three files compile (`lsp_diagnostics` clean). Existing callers (the `POST /prepare/:id` route in `launcher.ts`) continue to work. When signal is undefined, behavior is identical to before. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 3. Create prepare service\n  - Files: `packages/backend/src/services/prepare-service.ts` (new)\n  - In-memory job store, one-per-instance guard, AbortController management, async runPrepare orchestration, TTL cleanup.\n  - Purpose: Core business logic for async game preparation with progress tracking and cancellation.\n  - _Leverage: `packages/backend/src/services/download.ts` — exact same pattern: `jobs` Map, `activeServerDownloads` Map, `abortControllers` Map, `startDownload()`, `cancelDownload()`, `runDownload()`, `cleanupOldJobs()`. `packages/backend/src/services/version-service.ts` — `VersionService` class (instantiated in launcher.ts line 15). `packages/backend/src/services/asset-service.ts` — `AssetService` class (instantiated in launcher.ts line 16). `packages/backend/src/services/library-service.ts` — `LibraryService` class (instantiated in launcher.ts line 17). `packages/backend/src/services/instance-service.ts` — `getInstanceById()` for looking up instance. `packages/backend/src/config.ts` — `config.dataDir` for constructing paths._\n  - _Requirements: REQ-1 (async job with progress), REQ-3 (cancellation), REQ-4 (one-per-instance guard)_\n  - _Prompt: Implement the task for spec launcher-download-progress, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer | Task: Read `packages/backend/src/services/download.ts` FIRST — you will mirror its exact structure. Then read `packages/backend/src/routes/launcher.ts` lines 14-17 to see how VersionService, AssetService, LibraryService are instantiated. Create `packages/backend/src/services/prepare-service.ts` with: (1) Internal state: `const jobs = new Map<string, PrepareJob>()`, `const activeInstancePrepares = new Map<string, string>()` (instanceId -> jobId), `const abortControllers = new Map<string, AbortController>()` (jobId -> controller), `const JOB_TTL_MS = 60 * 60 * 1000`. (2) Service class instances: Instantiate `VersionService`, `AssetService`, `LibraryService` with `config.dataDir` (same as launcher.ts does). (3) Export `getPrepareJob(jobId: string): PrepareJob | undefined`. (4) Export `startPrepare(instanceId: string, mcVersion: string): PrepareJob` — create job with `nanoid(12)`, check one-per-instance guard (throw `ConflictError` if active job exists for this instance), create AbortController, fire-and-forget `runPrepare()`. (5) Export `cancelPrepare(jobId: string): boolean` — abort controller, return true/false. (6) Export `cleanupOldPrepareJobs(): void` — delete completed/failed jobs older than TTL. (7) Internal `async function runPrepare(job, instanceId, mcVersion, signal)`: Phase \"version\": set `job.phase = \"version\"`, call `versionService.downloadVersionJson(mcVersion, signal)` and `versionService.downloadGameJar(mcVersion, signal)`, set `job.progress = 5`. Phase \"libraries\": set `job.phase = \"libraries\"`, call `libraryService.downloadLibraries(versionJson, (current, total) => { job.phaseCurrent = current; job.phaseTotal = total; job.progress = 5 + Math.round((current / total) * 25); }, signal)`. Phase \"assets\": set `job.phase = \"assets\"`, reset phaseCurrent/phaseTotal, call `assetService.downloadAssets(versionJson, (current, total) => { job.phaseCurrent = current; job.phaseTotal = total; job.progress = 30 + Math.round((current / total) * 70); }, signal)`. On success: build PrepareResponse (classpath, mainClass, assetIndex, assetsDir, versionId, gameJarPath — same as launcher.ts lines 140-153), set `job.result`, `job.phase = \"completed\"`, `job.progress = 100`, clean up maps. On error: set `job.phase = \"failed\"`, `job.error`, clean up maps. On abort: same as error with `error = \"Cancelled\"`. Import types from `@mc-server-manager/shared`. Use `nanoid` for job IDs. Use `logger` from `../utils/logger.js`. Use `ConflictError` from `../utils/errors.js`. Use `path` from `node:path` for building assetsDir. Use `.js` extensions in all imports. | Restrictions: Do NOT import from routes. Do NOT create HTTP endpoints — that's the next task. Do NOT modify existing services. Mirror `download.ts` structure exactly. | Success: File compiles (`lsp_diagnostics` clean). Exports all 4 public functions. Uses the same map/guard/abort/TTL pattern as download.ts. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 4. Update launcher routes for async prepare\n  - Files: `packages/backend/src/routes/launcher.ts` (modify)\n  - Replace blocking `POST /prepare/:id` with async job kickoff, add `GET /prepare/jobs/:jobId` and `DELETE /prepare/jobs/:jobId`.\n  - Purpose: HTTP API for starting, polling, and cancelling prepare jobs.\n  - _Leverage: `packages/backend/src/routes/downloads.ts` — exact same route structure (POST to start returns 202, GET to poll, DELETE to cancel). `packages/backend/src/routes/launcher.ts` — existing route file to modify (current `POST /prepare/:id` handler at line 126)._\n  - _Requirements: REQ-1 (async job API), REQ-2 (polling endpoint), REQ-3 (cancel endpoint), REQ-4 (conflict on duplicate)_\n  - _Prompt: Implement the task for spec launcher-download-progress, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer with Express expertise | Task: Read `packages/backend/src/routes/downloads.ts` FIRST to understand the route pattern (POST returns 202, GET polls, DELETE cancels). Then read `packages/backend/src/routes/launcher.ts` to see the current `POST /prepare/:id` handler (lines 126-156). (1) Replace the existing `launcherRouter.post(\"/prepare/:id\", ...)` handler: Instead of calling versionService/libraryService/assetService directly and blocking, import `startPrepare` from `../services/prepare-service.js` and call `const job = startPrepare(instance.id, instance.mcVersion)`. Return `res.status(202).json(job)`. Keep the `instanceService.getInstanceById()` check. (2) Add `launcherRouter.get(\"/prepare/jobs/:jobId\", ...)`: Import `getPrepareJob` from prepare-service. Look up job, throw `NotFoundError(\"Prepare job\", req.params.jobId)` if not found, return `res.json(job)`. (3) Add `launcherRouter.delete(\"/prepare/jobs/:jobId\", ...)`: Import `cancelPrepare` from prepare-service. Look up job (throw NotFoundError if missing), call cancelPrepare, throw `AppError(\"Prepare job is not in progress or already completed\", 409, \"NOT_CANCELLABLE\")` if not cancellable, return `res.json({ message: \"Prepare cancelled\", jobId: req.params.jobId })`. (4) Remove unused imports: After replacing the handler, the route file no longer directly uses `VersionService`, `AssetService`, `LibraryService`, `path`, or `config` — remove those imports. Also remove the service instantiations on lines 15-17 (`const versionService = ...`, `const assetService = ...`, `const libraryService = ...`). Keep all other existing routes unchanged. | Restrictions: Do NOT change any other routes in this file (instances CRUD, accounts, java, versions). Do NOT remove route imports that are still used. Use `.js` extensions. Use existing error classes from `../utils/errors.js`. | Success: File compiles. `POST /prepare/:id` returns 202 with a PrepareJob. `GET /prepare/jobs/:jobId` returns the job. `DELETE /prepare/jobs/:jobId` cancels. All other routes still work. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 5. Update Electron launcher to accept PrepareResponse instead of calling prepare\n  - Files: `packages/electron/src/launcher.ts` (modify), `packages/electron/src/ipc.ts` (modify), `packages/electron/src/preload.cts` (modify), `packages/frontend/src/types/electron.d.ts` (modify)\n  - Change `launchGame()` to accept a `PrepareResponse` parameter instead of calling `POST /prepare/:id` internally.\n  - Purpose: The frontend now handles preparation (start job → poll → get result). Electron just spawns the game with the prepared data.\n  - _Leverage: `packages/electron/src/launcher.ts` — current `launchGame()` (line 61) calls prepare internally then spawns Java. `packages/electron/src/ipc.ts` — `launch-game` handler (line 54). `packages/electron/src/preload.cts` — `launchGame` bridge (line 16). `packages/frontend/src/types/electron.d.ts` — `launchGame` type (line 21)._\n  - _Requirements: REQ-1 (frontend controls preparation), REQ-5 (clean up dead flow)_\n  - _Prompt: Implement the task for spec launcher-download-progress, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Full-Stack TypeScript Developer | Task: Read all 4 files listed. The goal: `launchGame()` currently calls `POST /api/launcher/prepare/:id` to get classpath/assets/etc, then spawns Java. Since the frontend now handles preparation and gets a `PrepareResponse`, we pass that data directly to Electron. (1) In `packages/electron/src/launcher.ts`: Change `launchGame(instanceId: string, accountId: string)` signature to `launchGame(instanceId: string, accountId: string, prepareResult: PrepareResponse)`. Remove the `fetchJson` call that fetches `PrepareResponse` from the prepare endpoint (line 83-85). Instead use `prepareResult` directly for `prepareRes.classpath`, `prepareRes.assetsDir`, `prepareRes.mainClass`, `prepareRes.assetIndex`, `prepareRes.gameJarPath`. Still need to fetch instance and account data (lines 71-78) — keep those. Still need `resolveJavaPath(instance)` — keep that. Import `PrepareResponse` from `@mc-server-manager/shared`. (2) In `packages/electron/src/ipc.ts`: Update the `launch-game` handler (line 54-59) to pass `args.prepareResult` as the third argument: `launcher.launchGame(args.instanceId as string, args.accountId as string, args.prepareResult as PrepareResponse)`. Import `PrepareResponse` from `@mc-server-manager/shared`. (3) In `packages/electron/src/preload.cts`: Update line 16-17: `launchGame: (instanceId: string, accountId: string, prepareResult: unknown) => ipcRenderer.invoke(\"launch-game\", { instanceId, accountId, prepareResult })`. Use `unknown` for prepareResult in preload (it's serialized across IPC). (4) In `packages/frontend/src/types/electron.d.ts`: Update line 21: `launchGame(instanceId: string, accountId: string, prepareResult: PrepareResponse): Promise<GameProcess>;`. Add `PrepareResponse` to the import from `@mc-server-manager/shared` on line 1. | Restrictions: Do NOT remove the instance/account fetches — still needed for javaPath, username, uuid, etc. Do NOT change the auth flow. Keep `resolveJavaPath()` and `fetchJson()` helpers. Use `.js` extensions in launcher.ts and ipc.ts imports. | Success: All 4 files compile. `launchGame` accepts PrepareResponse as third param. No more internal call to `POST /prepare/:id` from Electron. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 6. Update frontend API client and InstanceDetail polling logic\n  - Files: `packages/frontend/src/api/client.ts` (modify), `packages/frontend/src/pages/InstanceDetail.tsx` (modify)\n  - Change `prepareLaunch()` return type, add `getPrepareStatus()` and `cancelPrepare()`, rewrite `handleLaunch()` with polling loop.\n  - Purpose: Frontend drives preparation via async job polling and feeds real data to the DownloadProgress component.\n  - _Leverage: `packages/frontend/src/api/client.ts` — existing `startDownload()` (line 218), `getDownloadStatus()` (line 225) for API method patterns. `packages/frontend/src/pages/CreateServer.tsx` lines 1110-1208 — exact polling pattern (refs, setInterval, cleanup, cancel handler) to replicate. `packages/frontend/src/pages/InstanceDetail.tsx` — current `handleLaunch()` (line 500), `preparing` state (line 446), `DownloadProgress` rendering (line 701). `packages/frontend/src/components/launcher/DownloadProgress.tsx` — props interface: `{ visible, progress: { phase, current, total, currentFile? }, onCancel? }`._\n  - _Requirements: REQ-1 (progress data), REQ-2 (frontend progress display), REQ-3 (cancel), REQ-5 (remove hardcoded props)_\n  - _Prompt: Implement the task for spec launcher-download-progress, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: React Frontend Developer | Task: Read `packages/frontend/src/pages/CreateServer.tsx` lines 1110-1208 FIRST — this is the exact polling pattern you will replicate. Then read the current `InstanceDetail.tsx` `handleLaunch()` at line 500 and the DownloadProgress rendering at line 701. (1) In `packages/frontend/src/api/client.ts`: Change `prepareLaunch` to return `PrepareJob` instead of `PrepareResponse` — update the return type and import `PrepareJob` from `@mc-server-manager/shared`. The URL stays the same. Add two new methods: `getPrepareStatus(jobId)` that GETs `/api/launcher/prepare/jobs/{jobId}` and returns a PrepareJob, and `cancelPrepare(jobId)` that DELETEs `/api/launcher/prepare/jobs/{jobId}`. (2) In `packages/frontend/src/pages/InstanceDetail.tsx`: Add imports: `PrepareJob` from `@mc-server-manager/shared`, `useRef` and `useEffect` (already imported — verify). Add state/refs: a `prepareJobRef` (string or null ref) for job ID, a `pollRef` (interval ref) for poll interval, and a `prepareProgress` state (object with phase, current, total — or null). Add cleanup effect: `useEffect(() => { return () => { if (pollRef.current) clearInterval(pollRef.current); }; }, [])`. Rewrite `handleLaunch()`: call `const job = await api.prepareLaunch(id)`, store `prepareJobRef.current = job.id`, set `setPreparing(true)`, start polling with `pollRef.current = setInterval(async () => { try { const j = await api.getPrepareStatus(prepareJobRef.current!); const displayPhase = j.phase === \"pending\" ? \"version\" : j.phase === \"completed\" || j.phase === \"failed\" ? \"assets\" : j.phase; setPrepareProgress({ phase: displayPhase as \"version\" | \"libraries\" | \"assets\", current: j.phaseCurrent, total: j.phaseTotal }); if (j.phase === \"completed\") { clearInterval(pollRef.current!); pollRef.current = null; setPreparing(false); setPrepareProgress(null); if (isDesktop() && j.result) { await window.electronAPI!.launchGame(id, selectedAccountId!, j.result); toast.success(\"Game launched!\"); } else { toast.info(\"Game files prepared. Launch requires the desktop app.\"); } } else if (j.phase === \"failed\") { clearInterval(pollRef.current!); pollRef.current = null; setPreparing(false); setPrepareProgress(null); toast.error(j.error || \"Preparation failed\"); } } catch (err) { logger.warn(\"Prepare status poll failed\", { error: err instanceof Error ? err.message : String(err) }); } }, 500)`. Add cancel handler: `const handlePrepareCancel = async () => { if (!prepareJobRef.current) return; try { await api.cancelPrepare(prepareJobRef.current); if (pollRef.current) { clearInterval(pollRef.current); pollRef.current = null; } setPreparing(false); setPrepareProgress(null); toast.info(\"Preparation cancelled\"); } catch (err) { toast.error(err instanceof Error ? err.message : \"Failed to cancel\"); } }`. Replace the DownloadProgress rendering (line 701-704): `<DownloadProgress visible={preparing} progress={prepareProgress || { phase: \"version\", current: 0, total: 0 }} onCancel={handlePrepareCancel} />`. Remove the old `try/catch/finally` around `await api.prepareLaunch(id)` — it's replaced by the polling pattern. The `setPreparing(true)` goes before polling starts, `setPreparing(false)` happens inside poll callbacks. Import `isDesktop` from `@/utils/desktop` if not already imported. Import `PrepareResponse` from `@mc-server-manager/shared` for the `launchGame` call type. | Restrictions: Do NOT change any other functionality in InstanceDetail.tsx (instance loading, settings, mods tabs, account selection, etc.). Do NOT modify the DownloadProgress component itself. Follow the CreateServer.tsx polling pattern exactly. | Success: Clicking Play starts a prepare job, progress overlay shows real phase/counts, cancel button works, game launches on completion (Electron) or shows info message (browser). `lsp_diagnostics` clean on both files. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 7. Verification and final cleanup\n  - Files: Various (verify, minor fixes only)\n  - Run full build, verify no dead references, confirm integration.\n  - Purpose: Ensure everything compiles and the old blocking flow is fully replaced.\n  - _Leverage: Build commands in root `package.json`. `grep` for dead references._\n  - _Requirements: REQ-5 (dead code cleanup), all requirements (integration verification)_\n  - _Prompt: Implement the task for spec launcher-download-progress, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Senior Developer | Task: (1) Run `npm run build -w shared && npm run build -w backend && npm run build -w frontend` — all must pass with zero errors. If any fail, fix the specific compile error. (2) Grep the codebase for `DownloadProgressInfo` — should have zero results in source files (coverage HTML is fine to ignore). (3) Grep for any remaining references to the old synchronous prepare response pattern (e.g., `Promise<PrepareResponse>` in client.ts should now be `Promise<PrepareJob>`). (4) Verify `packages/backend/src/routes/launcher.ts` no longer imports `VersionService`, `AssetService`, `LibraryService`, `path`, or `config` unless still needed by other routes. (5) Verify `packages/electron/src/launcher.ts` no longer calls `POST /api/launcher/prepare/`. (6) Check for any TODO/FIXME comments added during this spec's implementation. | Restrictions: Do NOT make functional changes — verification and minor fixes only (missing imports, unused imports, type mismatches from integration). If build fails, fix the minimal issue. | Success: Full build passes. Zero references to `DownloadProgressInfo` in source. No orphaned imports. No TODOs from this spec. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n",
  "fileStats": {
    "size": 23170,
    "lines": 58,
    "lastModified": "2026-02-15T03:33:53.551Z"
  },
  "comments": []
}