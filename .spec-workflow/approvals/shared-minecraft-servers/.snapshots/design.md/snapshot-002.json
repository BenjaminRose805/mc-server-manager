{
  "id": "snapshot_1770856757392_u74t3zhii",
  "approvalId": "approval_1770856708331_020o3ftx4",
  "approvalTitle": "EPIC-7: Shared Minecraft Servers â€” Design Document",
  "version": 2,
  "timestamp": "2026-02-12T00:39:17.392Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document -- Shared Minecraft Servers\n\n## Overview\n\nEnable Minecraft server sharing within a community: server owners toggle sharing, set display names and descriptions, and grant per-user permissions (view, join, manage, admin). Community members browse shared servers in a live-updating card grid, join with one click (or clipboard copy), and -- if authorized -- manage servers remotely. Whitelists are automatically synced based on permissions. All real-time updates use the existing WebSocket infrastructure with new broadcast logic. Data is stored in the existing SQLite database with two schema additions (sharing fields on `servers`, new `server_permissions` table).\n\n## Steering Document Alignment\n\nNo steering docs exist. This design follows existing project conventions (Express routes, Zod validation, SQLite models with prepared statements, Zustand stores, Tailwind UI, WebSocket message protocol with `type` discriminator).\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **WebSocket server (packages/backend/src/ws/)**: Already handles real-time messaging for console output and server status. Extended with permission-aware broadcasting to community members. Same connection, same protocol pattern.\n- **WebSocket client (packages/frontend/src/api/ws.ts)**: `WsClient` with auto-reconnect. Extended to handle shared server status and player events for the browser page.\n- **ServerManager singleton (packages/backend/src/services/server-manager.ts)**: Already tracks server processes, status, and player lists. Extended with a broadcast method that filters by permission.\n- **ServerProcess class (packages/backend/src/services/process.ts)**: Already manages Java child processes and stdin command sending. Reused directly for whitelist commands.\n- **Auth middleware (packages/backend/src/middleware/auth.ts)**: All new routes require `requireAuth`. New `requireServerPermission` middleware follows same pattern.\n- **Error classes (packages/backend/src/utils/errors.ts)**: `NotFoundError`, `ForbiddenError`, `UnauthorizedError` used in permission checks and route handlers.\n- **Zod validation**: All new route handlers use Zod schemas following existing patterns.\n- **Pino logger**: Existing logger for whitelist sync and permission events.\n- **Zustand store pattern (packages/frontend/src/stores/serverStore.ts)**: Pattern reused for community server state in the existing store or a new slice.\n- **Console UI (packages/frontend/src/components/)**: Existing console components reused for shared server console access -- no new console UI needed.\n\n### Integration Points\n- **`servers` table**: Extended with sharing columns (shared, shared_name, shared_description, shared_at).\n- **`users` table (Epic 5)**: Foreign key target for server_permissions. Optional `minecraft_username` and `minecraft_uuid` columns for whitelist sync.\n- **Express app (app.ts or index.ts)**: Mount new routes for community servers and server sharing.\n- **Frontend routing (App.tsx)**: Add `/community/servers` route for the server browser page.\n\n## Architecture\n\n### Server Sharing Data Flow\n\n```\nOwner toggles \"Share\" in server settings\n  --> PUT /api/servers/:id/sharing { shared: true, sharedName, sharedDescription }\n  --> Backend updates servers table (shared=1, shared_name, shared_description, shared_at)\n  --> If enabling: WhitelistSyncService.syncAll() adds all users with \"join\" permission to whitelist.json\n  --> Server now appears in GET /api/community/servers responses\n  --> WebSocket broadcasts status changes to all users with \"view\" permission\n```\n\n### One-Click Join Flow\n\n```\nMember clicks \"Join\" in server browser\n  --> POST /api/community/servers/:id/join\n  --> Backend verifies user has \"join\" permission via middleware\n  --> Backend returns { address, port, version, requiresMods }\n  --> Frontend receives connection info:\n      - If Tauri + Epic 3: IPC call to launch Minecraft client\n      - Otherwise: copy address:port to clipboard, show toast\n  --> Backend: WhitelistSyncService ensures user is on whitelist\n```\n\n### Whitelist Sync Flow\n\n```\nUser granted \"join\" permission (or higher)\n  --> WhitelistSyncService.addUser(server, mcUsername, mcUuid)\n  --> Read whitelist.json, add entry if not present, write back\n  --> If server running: send \"whitelist add <username>\" via stdin\n  --> If server running: send \"whitelist reload\" via stdin\n\nUser permission revoked (drops below \"join\")\n  --> WhitelistSyncService.removeUser(server, mcUsername, mcUuid)\n  --> Read whitelist.json, remove entry, write back\n  --> If server running: send \"whitelist remove <username>\" + \"whitelist reload\"\n```\n\n### Permission-Gated WebSocket Broadcasting\n\n```\nServer status changes (start, stop, player join/leave)\n  --> ServerManager detects change (existing behavior)\n  --> If server is shared: query server_permissions for all users with \"view\" or higher\n  --> Broadcast status/stats event to those users' WebSocket connections\n  --> Each client's store updates, re-renders server browser card\n```\n\n### Modular Design Principles\n- **Permission hierarchy in code**: A numeric mapping (view=1, join=2, manage=3, admin=4) with a `hasPermission(userLevel, requiredLevel)` utility for clean comparisons.\n- **Middleware composition**: `requireServerPermission(level)` is a reusable middleware factory that composes with `requireAuth` on any route.\n- **Fire-and-forget whitelist sync**: Permission changes return immediately; whitelist sync runs asynchronously with error logging but no blocking.\n- **Unified server model**: Sharing fields are columns on the existing `servers` table, not a separate table, keeping queries simple.\n\n## Components and Interfaces\n\n### Component 1: Server Permission Model (`packages/backend/src/models/server-permission.ts`)\n- **Purpose**: CRUD for server_permissions table -- grant, revoke, query by server, query by user, check permission level\n- **Interfaces**: `getServerPermission(serverId, userId)`, `grantPermission(serverId, userId, permission, grantedBy)`, `revokePermission(serverId, userId)`, `listServerPermissions(serverId)`, `listUserPermissions(userId)`, `hasPermission(userLevel, requiredLevel)`\n- **Dependencies**: Database module, nanoid, shared types\n- **Reuses**: Existing model patterns (prepared statements, snake_case to camelCase mapping)\n\n### Component 2: Server Permission Middleware (`packages/backend/src/middleware/server-permission.ts`)\n- **Purpose**: Express middleware factory that checks a user's permission level for a server before allowing route access\n- **Interfaces**: `requireServerPermission(requiredLevel: ServerPermissionLevel)` returns middleware function\n- **Dependencies**: Server permission model, auth middleware (Epic 5), error classes\n- **Reuses**: Error classes (UnauthorizedError, ForbiddenError), middleware composition pattern from auth.ts\n\n### Component 3: Whitelist Sync Service (`packages/backend/src/services/whitelist-sync.ts`)\n- **Purpose**: Manages Minecraft server whitelists based on community permissions -- adds/removes users from whitelist.json and sends runtime commands to running servers\n- **Interfaces**: `addUser(server, mcUsername, mcUuid)`, `removeUser(server, mcUsername, mcUuid)`, `syncAll(server, authorizedUsers[])`\n- **Dependencies**: ServerManager (for sending stdin commands), fs module, logger\n- **Reuses**: ServerProcess.sendCommand() for runtime whitelist updates\n\n### Component 4: Community Servers Routes (`packages/backend/src/routes/community-servers.ts`)\n- **Purpose**: REST API for browsing shared servers and joining\n- **Endpoints**: `GET /api/community/servers` (list all shared), `GET /api/community/servers/:id` (detail), `POST /api/community/servers/:id/join` (get connection info)\n- **Dependencies**: Auth middleware, server permission middleware/model, ServerManager, database\n- **Reuses**: Route handler patterns, Zod validation\n\n### Component 5: Server Sharing Routes (`packages/backend/src/routes/server-sharing.ts`)\n- **Purpose**: REST API for managing sharing settings and permissions\n- **Endpoints**: `PUT /api/servers/:id/sharing` (toggle sharing, set name/description), `GET /api/servers/:id/permissions` (list), `PUT /api/servers/:id/permissions/:userId` (grant/update), `DELETE /api/servers/:id/permissions/:userId` (revoke)\n- **Dependencies**: Auth middleware, server permission middleware/model, whitelist sync service, Zod\n- **Reuses**: Route handler patterns\n\n### Component 6: Community Servers API Client (`packages/frontend/src/api/community-servers.ts`)\n- **Purpose**: Frontend fetch wrappers for all community server and sharing endpoints\n- **Interfaces**: `listSharedServers()`, `getSharedServer(id)`, `joinServer(id)`, `updateSharingSettings(id, settings)`, `listServerPermissions(id)`, `grantServerPermission(serverId, userId, permission)`, `revokeServerPermission(serverId, userId)`\n- **Dependencies**: API client base (BASE_URL, auth headers)\n- **Reuses**: Existing fetch pattern from api/client.ts\n\n### Component 7: Server Browser Page (`packages/frontend/src/pages/ServerBrowser.tsx`)\n- **Purpose**: Main community server browser page with card grid layout\n- **Dependencies**: Community servers API client, ServerCard component, Zustand store\n- **Reuses**: Page layout patterns, Loader2 spinner from lucide-react\n\n### Component 8: Server Card Component (`packages/frontend/src/components/ServerCard.tsx`)\n- **Purpose**: Card displaying a shared server's status, player count, permission level, and action buttons (Join, Manage)\n- **Dependencies**: Community servers API, shared types, lucide-react icons, sonner toasts\n- **Reuses**: Tailwind card patterns, status color mapping from existing server UI\n\n### Component 9: Server Sharing Settings Panel (`packages/frontend/src/components/ServerSharingSettings.tsx`)\n- **Purpose**: UI for toggling sharing, editing display name and description, viewing permission count\n- **Dependencies**: Community servers API, shared types, sonner toasts\n- **Reuses**: Tailwind form patterns\n\n### Component 10: Server Permissions Manager (`packages/frontend/src/components/ServerPermissionsManager.tsx`)\n- **Purpose**: UI for listing, granting, and revoking per-user permissions on a server\n- **Dependencies**: Community servers API, shared types, lucide-react icons, sonner toasts\n- **Reuses**: Tailwind list/table patterns\n\n### Component 11: WebSocket Broadcasting Extension (modify `packages/backend/src/services/server-manager.ts`)\n- **Purpose**: Broadcast server status and player changes to all community members with view permission\n- **Interfaces**: `broadcastToAuthorizedUsers(serverId, event)` helper method\n- **Dependencies**: Server permission model (listServerPermissions), WebSocket server\n- **Reuses**: Existing WebSocket broadcast infrastructure\n\n## Data Models\n\n### servers table (ALTER -- add sharing columns)\n\n```sql\nALTER TABLE servers ADD COLUMN shared INTEGER DEFAULT 0 NOT NULL;\nALTER TABLE servers ADD COLUMN shared_name TEXT;\nALTER TABLE servers ADD COLUMN shared_description TEXT;\nALTER TABLE servers ADD COLUMN shared_at INTEGER;\n\nCREATE INDEX idx_servers_shared ON servers(shared) WHERE shared = 1;\n```\n\nFields:\n- `shared`: Boolean (0/1) -- whether visible to community members\n- `shared_name`: Display name for the server browser (may differ from internal name)\n- `shared_description`: Description shown in browser (at most 500 characters)\n- `shared_at`: Unix timestamp when sharing was enabled\n\n### server_permissions table (NEW)\n\n```sql\nCREATE TABLE server_permissions (\n  id TEXT PRIMARY KEY,\n  server_id TEXT NOT NULL,\n  user_id TEXT NOT NULL,\n  permission TEXT NOT NULL CHECK(permission IN ('view', 'join', 'manage', 'admin')),\n  granted_by TEXT NOT NULL,\n  granted_at INTEGER NOT NULL,\n  FOREIGN KEY (server_id) REFERENCES servers(id) ON DELETE CASCADE,\n  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n  FOREIGN KEY (granted_by) REFERENCES users(id),\n  UNIQUE(server_id, user_id)\n);\n\nCREATE INDEX idx_server_permissions_server ON server_permissions(server_id);\nCREATE INDEX idx_server_permissions_user ON server_permissions(user_id);\n```\n\nPermission levels (hierarchical -- each includes all lower):\n- `view` (1): See server in browser, view status and players\n- `join` (2): Join the server (auto-added to whitelist)\n- `manage` (3): Start/stop/restart, edit server.properties, view console\n- `admin` (4): Full control (delete, change sharing settings, grant permissions)\n\n### Shared TypeScript Types\n\n```typescript\n// Server sharing types\nexport type ServerPermissionLevel = 'view' | 'join' | 'manage' | 'admin';\n\nexport interface ServerPermission {\n  id: string;\n  serverId: string;\n  userId: string;\n  permission: ServerPermissionLevel;\n  grantedBy: string;\n  grantedAt: number;\n}\n\nexport interface SharedServerInfo {\n  id: string;\n  sharedName: string;\n  sharedDescription: string | null;\n  status: ServerStatus;\n  playerCount: number;\n  maxPlayers: number;\n  version: string;\n  type: ServerType;\n  onlinePlayers: string[];\n  myPermission: ServerPermissionLevel | null;\n  sharedAt: number;\n}\n\nexport interface ServerSharingSettings {\n  shared: boolean;\n  sharedName: string;\n  sharedDescription: string | null;\n}\n\nexport interface GrantPermissionRequest {\n  userId: string;\n  permission: ServerPermissionLevel;\n}\n\nexport interface JoinServerResponse {\n  address: string;\n  port: number;\n  version: string;\n  requiresMods: boolean;\n}\n\n// WebSocket message types (server -> client)\n// SharedServerStatusEvent: type 'shared:status', serverId, status\n// SharedServerStatsEvent: type 'shared:stats', serverId, playerCount, maxPlayers, onlinePlayers\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **User without permission attempts to join a server**\n   - **Handling**: `requireServerPermission('join')` middleware throws ForbiddenError (403).\n   - **User Impact**: \"Requires join permission for this server\" error. UI disables the Join button for users without join permission.\n\n2. **User attempts to manage permissions without admin permission**\n   - **Handling**: `requireServerPermission('admin')` middleware throws ForbiddenError (403).\n   - **User Impact**: Permission management UI not shown. API returns 403 if bypassed.\n\n3. **Server not found or not shared**\n   - **Handling**: Community server routes return 404 NotFoundError.\n   - **User Impact**: \"Server not found or not shared\" message.\n\n4. **Whitelist sync fails (file I/O or command error)**\n   - **Handling**: Errors are caught and logged via Pino. Permission change still succeeds (fire-and-forget).\n   - **User Impact**: No visible error. Permission is granted but whitelist may be out of sync. Admin can manually trigger sync.\n\n5. **Whitelist sync skipped (no Minecraft account linked)**\n   - **Handling**: WhitelistSyncService checks for minecraft_username and minecraft_uuid. If missing, logs a warning and returns without action.\n   - **User Impact**: Permission is granted but user is not whitelisted. They will see \"not whitelisted\" when trying to connect in Minecraft.\n\n6. **Duplicate permission grant**\n   - **Handling**: SQL uses `ON CONFLICT(server_id, user_id) DO UPDATE` for upsert behavior. No error thrown.\n   - **User Impact**: Permission level is updated silently. No duplicate entries.\n\n7. **WebSocket disconnect during server browser viewing**\n   - **Handling**: Auto-reconnect (existing). On reconnect, client re-fetches shared server list for current state.\n   - **User Impact**: Brief stale data, then automatic refresh.\n\n8. **Corrupted whitelist.json**\n   - **Handling**: WhitelistSyncService catches JSON parse errors, logs a warning, and treats the file as empty (rebuilds from scratch on next sync).\n   - **User Impact**: No visible error. Whitelist is rebuilt correctly.\n\n## File Structure\n\n### New Files\n```\npackages/backend/migrations/008_shared_servers.sql             # Sharing columns + permissions table\npackages/backend/src/models/server-permission.ts                # Permission CRUD and hierarchy logic\npackages/backend/src/middleware/server-permission.ts            # Express permission middleware\npackages/backend/src/services/whitelist-sync.ts                 # Whitelist auto-sync service\npackages/backend/src/routes/community-servers.ts                # Community server browser API\npackages/backend/src/routes/server-sharing.ts                   # Sharing settings + permission management API\npackages/frontend/src/api/community-servers.ts                  # Frontend API client for shared servers\npackages/frontend/src/pages/ServerBrowser.tsx                   # Server browser page\npackages/frontend/src/components/ServerCard.tsx                 # Server card component\npackages/frontend/src/components/ServerSharingSettings.tsx      # Sharing settings panel\npackages/frontend/src/components/ServerPermissionsManager.tsx   # Permission management UI\n```\n\n### Modified Files\n```\nshared/src/index.ts                                             # Export shared server types, permission types\npackages/backend/src/index.ts (or app.ts)                       # Mount community server and sharing routes\npackages/backend/src/services/server-manager.ts                 # Add broadcastToAuthorizedUsers for shared servers\npackages/frontend/src/App.tsx                                   # Add /community/servers route\npackages/frontend/src/stores/serverStore.ts                     # Handle shared server WebSocket events (optional)\npackages/frontend/src/api/ws.ts                                 # Handle shared:status and shared:stats events\n```\n\n## Dependencies\n\n### New Backend npm Packages\n- None required. All functionality uses existing packages (ws, express, better-sqlite3, zod, nanoid, pino, fs).\n\n### New Frontend npm Packages\n- None required. All functionality uses existing packages (react, zustand, sonner, lucide-react, @tanstack/react-virtual for potential future use).\n\n## Testing Strategy\n\n### Unit Testing\n- No automated test framework exists. Manual verification.\n- Key verification: permission hierarchy logic (hasPermission utility), whitelist JSON read/write, permission middleware access control.\n\n### Integration Testing\n- **Sharing toggle**: Enable sharing on a server, verify it appears in community server list. Disable sharing, verify it disappears.\n- **Permission lifecycle**: Grant \"join\" permission to a user. Verify they can call the join endpoint. Revoke permission. Verify 403 on join attempt.\n- **Permission hierarchy**: Grant \"admin\" permission. Verify the user can access join, manage, and admin endpoints. Grant only \"view\". Verify the user cannot join.\n- **Whitelist sync on grant**: Grant \"join\" permission. Verify whitelist.json contains the user's entry. If server is running, verify \"whitelist add\" command was sent.\n- **Whitelist sync on revoke**: Revoke permission. Verify whitelist.json no longer contains the user. If server is running, verify \"whitelist remove\" was sent.\n- **Full whitelist sync**: Enable sharing with 3 users having \"join\" permission. Verify all 3 are in whitelist.json.\n- **Join flow (no Epic 3)**: Click Join on a running server. Verify address is copied to clipboard with toast notification.\n- **Server browser updates**: Start a shared server. Verify server browser updates status from \"stopped\" to \"starting\" to \"running\" in real time via WebSocket.\n- **Permission-gated controls**: Log in as a user with \"manage\" permission. Verify start/stop buttons are visible. Log in as \"view\" user. Verify no control buttons.\n- **Shared console access**: Log in as \"admin\" user. Subscribe to shared server console. Verify console output streams. Log in as \"manage\" user. Verify console subscription is denied.\n\n### End-to-End Testing\n- Full sharing flow: Create a server, enable sharing, grant permissions to 2 users, verify browser shows server, User A (join) clicks Join and gets address, User B (admin) accesses console and sends a command.\n- Permission revocation flow: Revoke User A's permission. Verify they can no longer join. Verify whitelist.json updated. Re-grant and verify access restored.\n",
  "fileStats": {
    "size": 20011,
    "lines": 341,
    "lastModified": "2026-02-12T00:31:54.260Z"
  },
  "comments": []
}