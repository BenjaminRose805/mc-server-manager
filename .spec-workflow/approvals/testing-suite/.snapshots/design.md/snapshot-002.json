{
  "id": "snapshot_1771116816180_9izngs6m6",
  "approvalId": "approval_1771116260688_nh94pjw55",
  "approvalTitle": "Testing Suite - Design Document",
  "version": 2,
  "timestamp": "2026-02-15T00:53:36.180Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design establishes a Vitest-based testing suite across the MC Server Manager monorepo. The suite covers three testable packages — `shared`, `backend`, and `frontend` — with package-specific configurations, shared test utilities, and an initial set of tests targeting the highest-value code paths.\n\nThe architecture uses Vitest workspaces to orchestrate per-package test runs from a single root command, supertest for backend HTTP integration tests against the exported Express `app`, Testing Library for frontend component tests in a happy-dom environment, and in-memory SQLite databases for backend test isolation.\n\nElectron is explicitly excluded from this spec — its testing requires Electron-specific tooling (Playwright Electron or Spectron) and is a separate concern.\n\n## Steering Document Alignment\n\n- **tech.md**: \"No automated tests: All verification is manual or build-based. High-risk area.\" — this spec directly addresses that gap.\n- **tech.md**: \"No DI container: Services are singletons imported directly. No IoC framework.\" — the design works within this constraint by using supertest integration tests (which exercise real singletons) rather than requiring DI refactoring.\n- **product.md**: \"Reliability of server management (zero orphaned processes, clean shutdown)\" — testing the ConsoleBuffer, error classes, properties parser, and API routes provides automated regression coverage for the server management core.\n- **structure.md**: File naming (`kebab-case.ts`), import conventions (`.js` extensions in backend), and module boundaries are all respected.\n\n## Code Reuse Analysis\n\n### Existing Code to Leverage\n\n- **`packages/backend/src/app.ts`**: Exports `app` (Express instance) separately from server startup — supertest can use it directly without starting an HTTP server.\n- **`packages/backend/src/services/database.ts`**: `initDatabase()` accepts the DB path from `config.dbPath` which is environment-variable driven (`DB_PATH`). Tests override this to use `:memory:` or temp file databases.\n- **`packages/backend/src/services/jwt.ts`**: `generateAccessToken()` creates valid JWTs — test helpers reuse this to create authenticated test requests.\n- **`packages/backend/src/utils/errors.ts`**: Error class hierarchy is small and self-contained — directly testable.\n- **`packages/backend/src/services/console-buffer.ts`**: `ConsoleBuffer` class is pure (no external dependencies beyond `Date`) — directly testable.\n- **`packages/backend/src/routes/validation.ts`**: Zod schemas are exported and can be tested independently of routes.\n- **`shared/src/index.ts`**: Pure utility functions (`compareMcVersions`, `getMinJavaForMcVersion`, `getJavaMajorVersion`, `checkJavaMcCompat`) have zero dependencies — trivially testable.\n\n### Integration Points\n\n- **Backend test setup** must call `initDatabase()` with a `:memory:` SQLite database and run all migrations before route tests. The `config` module reads `DB_PATH` from environment — tests set `process.env.DB_PATH = ':memory:'` before importing config.\n- **Auth middleware** (`requireAuth`) checks `isMultiUserMode()` which calls `countUsers()`. In single-user mode (no users in DB), auth is skipped. Tests for authenticated endpoints must first insert a user into the test database.\n- **Frontend tests** must mock the `@/api/client` module and `@/api/ws` module to prevent real HTTP/WebSocket connections.\n\n### Shared Types Already Available\n\n- `ServerWithStatus`, `Server`, `ServerStatus`, `ServerType` — for mock data factories\n- `CreateServerRequest`, `UpdateServerRequest` — for API request test payloads\n- `WsMessage`, `WsSubscribe`, `WsCommand` — for WebSocket protocol testing (future)\n- `UserRole`, `JWTPayload` — for auth test helpers\n\n## Architecture\n\n```\nvitest.workspace.ts                    (root: orchestrates all packages)\n     |\n     +-- shared/vitest.config.ts       (env: node, tests: utility functions)\n     |\n     +-- packages/backend/vitest.config.ts  (env: node, tests: HTTP integration + unit)\n     |       |\n     |       +-- src/test-utils/\n     |       |     +-- db.ts           (in-memory SQLite setup/teardown)\n     |       |     +-- auth.ts         (JWT token generation for tests)\n     |       |     +-- factories.ts    (mock data factories)\n     |       |\n     |       +-- src/**/*.test.ts      (co-located test files)\n     |\n     +-- packages/frontend/vitest.config.ts (env: happy-dom, tests: components + stores)\n             |\n             +-- src/test-utils/\n             |     +-- setup.ts        (Testing Library cleanup, jest-dom matchers)\n             |     +-- render.ts       (custom render with providers)\n             |     +-- factories.ts    (mock ServerWithStatus, etc.)\n             |\n             +-- src/**/*.test.ts(x)   (co-located test files)\n```\n\n### Design Principles Applied\n\n- **Single File Responsibility**: Each test file tests one module. Test utilities are organized by concern (db, auth, factories).\n- **Transport Separation**: Backend integration tests exercise the HTTP layer via supertest; backend unit tests exercise services/utilities directly. They are separate test files.\n- **No Application Code Changes**: This spec adds only test infrastructure and test files. Zero changes to existing application source code. No DI refactoring required.\n\n## Components and Interfaces\n\n### Component 1: Root Vitest Workspace (`vitest.workspace.ts`)\n\n- **Purpose**: Orchestrate test runs across all packages from a single command.\n- **Interface**:\n  ```typescript\n  import { defineWorkspace } from 'vitest/config'\n\n  export default defineWorkspace([\n    'shared/vitest.config.ts',\n    'packages/backend/vitest.config.ts',\n    'packages/frontend/vitest.config.ts',\n  ])\n  ```\n- **Dependencies**: `vitest`\n- **Reuses**: Nothing — new file at project root.\n\n### Component 2: Shared Package Test Config (`shared/vitest.config.ts`)\n\n- **Purpose**: Configure Vitest for the shared types package (Node environment).\n- **Interface**:\n  ```typescript\n  import { defineConfig } from 'vitest/config'\n\n  export default defineConfig({\n    test: {\n      name: 'shared',\n      environment: 'node',\n      globals: true,\n      include: ['src/**/*.test.ts'],\n      coverage: {\n        provider: 'v8',\n        include: ['src/**/*.ts'],\n        exclude: ['src/**/*.test.ts'],\n      },\n    },\n  })\n  ```\n- **Dependencies**: `vitest`\n- **Reuses**: Nothing — new file.\n\n### Component 3: Backend Test Config (`packages/backend/vitest.config.ts`)\n\n- **Purpose**: Configure Vitest for backend (Node environment, setup file for DB).\n- **Interface**:\n  ```typescript\n  import { defineConfig } from 'vitest/config'\n\n  export default defineConfig({\n    test: {\n      name: 'backend',\n      environment: 'node',\n      globals: true,\n      setupFiles: ['./src/test-utils/setup.ts'],\n      include: ['src/**/*.test.ts'],\n      coverage: {\n        provider: 'v8',\n        include: ['src/**/*.ts'],\n        exclude: [\n          'src/**/*.test.ts',\n          'src/test-utils/**',\n        ],\n      },\n    },\n  })\n  ```\n- **Dependencies**: `vitest`, `supertest`, `@types/supertest`\n- **Reuses**: Nothing — new file.\n\n### Component 4: Backend Test Setup (`packages/backend/src/test-utils/setup.ts`)\n\n- **Purpose**: Global test setup — set environment variables before any module loads, silence logger.\n- **Interface**:\n  ```typescript\n  // Set env vars BEFORE any app modules are imported\n  process.env.DB_PATH = ':memory:'\n  process.env.LOG_LEVEL = 'silent'\n  process.env.MC_MIGRATIONS_DIR = new URL('../../migrations', import.meta.url).pathname\n  ```\n- **Dependencies**: None (runs before test files)\n- **Reuses**: Environment variable conventions from `packages/backend/src/config.ts`\n\n### Component 5: Backend DB Test Helper (`packages/backend/src/test-utils/db.ts`)\n\n- **Purpose**: Initialize and tear down an in-memory SQLite database for each test suite.\n- **Interface**:\n  ```typescript\n  import { initDatabase, closeDatabase, getDb } from '../services/database.js'\n\n  /**\n   * Initialize a fresh in-memory database with all migrations.\n   * Call in beforeAll() or beforeEach().\n   */\n  export function setupTestDb(): void\n\n  /**\n   * Close the test database connection.\n   * Call in afterAll() or afterEach().\n   */\n  export function teardownTestDb(): void\n\n  /**\n   * Get the test database instance (convenience re-export).\n   */\n  export { getDb } from '../services/database.js'\n  ```\n- **Dependencies**: `../services/database.js`\n- **Reuses**: Existing `initDatabase()` / `closeDatabase()` functions directly.\n\n### Component 6: Backend Auth Test Helper (`packages/backend/src/test-utils/auth.ts`)\n\n- **Purpose**: Create test users and generate JWT tokens for authenticated supertest requests.\n- **Interface**:\n  ```typescript\n  import type { UserRole } from '@mc-server-manager/shared'\n\n  interface TestUser {\n    id: string\n    username: string\n    role: UserRole\n    token: string\n  }\n\n  /**\n   * Create a user in the test DB and return user info + valid JWT.\n   * Requires setupTestDb() to have been called first.\n   */\n  export function createTestUser(overrides?: {\n    username?: string\n    role?: UserRole\n  }): TestUser\n\n  /**\n   * Create an owner user (convenience wrapper).\n   */\n  export function createTestOwner(): TestUser\n  ```\n- **Dependencies**: `../services/jwt.js`, `../models/user.js`, `nanoid`\n- **Reuses**: Existing `generateAccessToken()` from `services/jwt.ts`, existing `createUser()` from `models/user.ts`.\n\n### Component 7: Backend Mock Data Factories (`packages/backend/src/test-utils/factories.ts`)\n\n- **Purpose**: Generate valid test data for servers and other entities.\n- **Interface**:\n  ```typescript\n  import type { CreateServerRequest } from '@mc-server-manager/shared'\n\n  /**\n   * Build a valid CreateServerRequest with sensible defaults.\n   * All fields can be overridden.\n   */\n  export function buildCreateServerRequest(\n    overrides?: Partial<CreateServerRequest>\n  ): CreateServerRequest\n  ```\n- **Dependencies**: `@mc-server-manager/shared`\n- **Reuses**: Shared type definitions.\n\n### Component 8: Frontend Test Config (`packages/frontend/vitest.config.ts`)\n\n- **Purpose**: Configure Vitest for frontend (happy-dom, React plugin, path aliases).\n- **Interface**:\n  ```typescript\n  import { defineConfig } from 'vitest/config'\n  import react from '@vitejs/plugin-react'\n\n  export default defineConfig({\n    plugins: [react()],\n    test: {\n      name: 'frontend',\n      environment: 'happy-dom',\n      globals: true,\n      setupFiles: ['./src/test-utils/setup.ts'],\n      include: ['src/**/*.test.{ts,tsx}'],\n      coverage: {\n        provider: 'v8',\n        include: ['src/**/*.{ts,tsx}'],\n        exclude: [\n          'src/**/*.test.{ts,tsx}',\n          'src/test-utils/**',\n          'src/main.tsx',\n          'src/vite-env.d.ts',\n        ],\n      },\n    },\n    resolve: {\n      alias: {\n        '@': new URL('./src', import.meta.url).pathname,\n      },\n    },\n  })\n  ```\n- **Dependencies**: `vitest`, `happy-dom`, `@vitejs/plugin-react` (already installed)\n- **Reuses**: Path alias config from existing `vite.config.ts`.\n\n### Component 9: Frontend Test Setup (`packages/frontend/src/test-utils/setup.ts`)\n\n- **Purpose**: Register Testing Library jest-dom matchers and automatic cleanup.\n- **Interface**:\n  ```typescript\n  import '@testing-library/jest-dom/vitest'\n  import { cleanup } from '@testing-library/react'\n  import { afterEach } from 'vitest'\n\n  afterEach(() => {\n    cleanup()\n  })\n  ```\n- **Dependencies**: `@testing-library/jest-dom`, `@testing-library/react`\n- **Reuses**: Nothing — standard Testing Library setup.\n\n### Component 10: Frontend Custom Render (`packages/frontend/src/test-utils/render.ts`)\n\n- **Purpose**: Wrap components with required providers (MemoryRouter) for testing.\n- **Interface**:\n  ```typescript\n  import type { RenderOptions } from '@testing-library/react'\n  import type { ReactElement } from 'react'\n\n  interface CustomRenderOptions extends Omit<RenderOptions, 'wrapper'> {\n    initialRoute?: string\n  }\n\n  /**\n   * Render with MemoryRouter wrapper.\n   * Use instead of bare `render()` when component uses React Router.\n   */\n  export function renderWithRouter(\n    ui: ReactElement,\n    options?: CustomRenderOptions\n  ): ReturnType<typeof import('@testing-library/react').render>\n  ```\n- **Dependencies**: `@testing-library/react`, `react-router`\n- **Reuses**: Existing React Router setup pattern from `App.tsx`.\n\n### Component 11: Frontend Mock Data Factories (`packages/frontend/src/test-utils/factories.ts`)\n\n- **Purpose**: Generate valid mock data for frontend components.\n- **Interface**:\n  ```typescript\n  import type { ServerWithStatus, Server } from '@mc-server-manager/shared'\n\n  /**\n   * Build a ServerWithStatus object with sensible defaults.\n   * All fields can be overridden via the overrides parameter.\n   */\n  export function buildServer(\n    overrides?: Partial<ServerWithStatus>\n  ): ServerWithStatus\n\n  /**\n   * Build an array of servers with sequential names.\n   */\n  export function buildServerList(count: number): ServerWithStatus[]\n  ```\n- **Dependencies**: `@mc-server-manager/shared`\n- **Reuses**: Shared type definitions.\n\n## Data Models\n\nNo new data models. This spec adds only test infrastructure — no database schema changes.\n\n## API Endpoints\n\nNo new API endpoints. This spec tests existing endpoints, it does not create new ones.\n\n## WebSocket Events\n\nNo new WebSocket events. WebSocket testing is not in scope for this initial spec.\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Test database initialization failure**\n   - **Handling**: `setupTestDb()` throws if migrations fail. Test suite aborts with a clear error indicating which migration failed.\n   - **User Impact**: Developer sees a migration error in test output and can fix the SQL.\n\n2. **Missing environment variable in test setup**\n   - **Handling**: `setup.ts` sets all required env vars (`DB_PATH`, `LOG_LEVEL`, `MC_MIGRATIONS_DIR`) before any imports. If setup file fails to load, Vitest reports the setup error with file path.\n   - **User Impact**: Clear error pointing to setup file.\n\n## Verification Strategy\n\n### Build Verification\n\n- `npm run build` must pass with zero errors after implementation (test files are excluded from `tsc` compilation by the `include` patterns in each `tsconfig.json`).\n- `npm test` must pass with zero errors — this is the primary verification.\n\n### Manual Testing Checklist\n\n1. `npm test` from project root -> all packages' tests run, all pass\n2. `npm test -w @mc-server-manager/shared` -> only shared tests run\n3. `npm run test -w @mc-server-manager/backend` -> only backend tests run\n4. `npm run test -w @mc-server-manager/frontend` -> only frontend tests run\n5. `npm run test:coverage` -> coverage report generated with HTML output\n6. Modify a shared utility function to return wrong result -> `npm test` fails with clear message\n7. Modify a backend route response shape -> integration test fails\n8. Modify a component's rendered text -> component test fails\n\n## Implementation Order\n\n1. **Root config + shared package tests** — Foundation. No dependencies. Proves Vitest works in the monorepo. Delivers immediate value (shared utility tests).\n2. **Backend test infrastructure** — Config, setup file, DB helper, auth helper, data factories. Depends on (1) for root workspace config.\n3. **Backend unit tests** — ConsoleBuffer, error classes, Zod schemas, properties parser. Depends on (2) for test infrastructure.\n4. **Backend integration tests** — Supertest route tests for core server CRUD. Depends on (2) for DB/auth helpers.\n5. **Frontend test infrastructure** — Config, setup file, custom render, data factories. Depends on (1) for root workspace config.\n6. **Frontend unit tests** — Zustand store tests. Depends on (5) for test infrastructure.\n7. **Frontend component tests** — StatusBadge, ServerCard. Depends on (5) for setup + factories.\n8. **Root scripts + verification** — Add `test`, `test:watch`, `test:coverage` scripts to root and per-package `package.json`. Verify everything works end-to-end. Depends on all previous steps.\n\nEach step can be verified independently before proceeding to the next.\n",
  "fileStats": {
    "size": 16229,
    "lines": 388,
    "lastModified": "2026-02-15T00:44:14.992Z"
  },
  "comments": []
}