{
  "id": "snapshot_1770856760015_9zk5ggyrd",
  "approvalId": "approval_1770856709333_xq6an8be9",
  "approvalTitle": "EPIC-8: Voice Communication â€” Design Document",
  "version": 2,
  "timestamp": "2026-02-12T00:39:20.015Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document -- Voice Communication\n\n## Overview\n\nAdd LiveKit-based voice channels to MC Server Manager. Users create voice channels, join them to communicate with low-latency audio via WebRTC. LiveKit runs as a sidecar Go binary managed by Tauri, handling all WebRTC complexity (SFU, TURN, codec negotiation). The backend generates short-lived JWT tokens for LiveKit access. The frontend uses the livekit-client SDK to connect, publish microphone audio, and subscribe to remote audio tracks. Push-to-talk is implemented via Tauri global shortcuts. Audio-only for v1.\n\n## Steering Document Alignment\n\nNo steering docs exist. This design follows existing project conventions (Express routes, Zod validation, SQLite models, Zustand stores, Tailwind UI) and adds LiveKit as a new infrastructure component managed identically to the backend sidecar.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **Auth middleware (`packages/backend/src/middleware/auth.ts`)**: All voice routes require `requireAuth`. Token generation validates user session.\n- **Error classes (`packages/backend/src/utils/errors.ts`)**: `NotFoundError` for missing channels, `ValidationError` for bad input. Standard Express error middleware catches these.\n- **Zod validation**: All voice route handlers use Zod schemas following existing patterns.\n- **Settings model**: LiveKit credentials and port configuration stored in existing `settings` key-value table. Reuse `getSetting`/`setSetting` functions.\n- **Zustand store pattern (`packages/frontend/src/stores/serverStore.ts`)**: Pattern for new `voiceStore.ts`. LiveKit room events write directly to store.\n- **Pino logger**: Existing logger for LiveKit lifecycle and voice event logging.\n- **Tauri sidecar pattern (`packages/desktop/src-tauri/src/lib.rs`)**: LiveKit sidecar follows the identical spawn/kill pattern as the backend sidecar.\n- **API client pattern (`packages/frontend/src/api/client.ts`)**: Voice API client follows existing fetch wrapper patterns with Authorization header.\n\n### Integration Points\n- **`users` table**: Foreign key target for voice_channels.created_by. User identity and display name used in LiveKit tokens.\n- **Express app (`app.ts`)**: Mount new voice routes at `/api/voice`.\n- **Tauri `lib.rs`**: Add LiveKit sidecar spawn alongside backend sidecar. Add to AppState. Update quit handler.\n- **Tauri `tauri.conf.json`**: Register livekit-server in externalBin array.\n- **Backend `index.ts`**: Generate LiveKit config YAML on startup, ensure credentials exist.\n- **Frontend routing**: Voice UI components integrated into existing layout.\n\n## Architecture\n\n### LiveKit Data Flow\n\n```\nUser clicks \"Join Voice Channel\"\n  --> Frontend: POST /api/voice/token with channelId\n  --> Backend: validates session, validates channel exists\n  --> Backend: generates LiveKit JWT (livekit-server-sdk AccessToken)\n  --> Backend: returns token + wsUrl to frontend\n  --> Frontend: room = new Room(); room.connect(wsUrl, token)\n  --> Frontend: room.localParticipant.setMicrophoneEnabled(true)\n  --> LiveKit SFU: forwards audio tracks to all room participants\n  --> Remote participants: receive audio via WebRTC, auto-attached to DOM\n```\n\n### Sidecar Lifecycle\n\n```\nTauri app starts\n  --> spawn backend sidecar (port 3001)\n  --> backend writes livekit-config.yaml (credentials, ports)\n  --> spawn livekit-server sidecar (reads config, port 7880)\n  --> LiveKit ready for WebRTC connections\n\nTauri app quits\n  --> kill LiveKit sidecar first\n  --> kill backend sidecar (stops MC servers)\n  --> exit\n```\n\n### Token Security Model\n\n```\nFrontend (no LiveKit credentials)\n  --> POST /api/voice/token (with session cookie/JWT)\n  --> Backend (holds API key + secret)\n  --> generates scoped LiveKit JWT (room-specific, 6h TTL)\n  --> Frontend uses token to connect to LiveKit\n  --> LiveKit validates token signature against configured API key\n```\n\n## Components and Interfaces\n\n### Component 1: LiveKit Config Service (`packages/backend/src/services/livekit-config.ts`)\n- **Purpose**: Generate LiveKit YAML configuration file and manage API credentials\n- **Interfaces**: `generateLiveKitConfig(config, outputPath)`, `generateApiCredentials()`, `ensureLiveKitCredentials()`\n- **Dependencies**: Node fs, crypto, settings model\n- **Reuses**: Settings model for credential storage\n\n### Component 2: Voice Channel Model (`packages/backend/src/models/voice-channel.ts`)\n- **Purpose**: CRUD for voice_channels table\n- **Interfaces**: `getAllVoiceChannels()`, `getVoiceChannelById(id)`, `createVoiceChannel(name, createdBy, options)`, `updateVoiceChannel(id, updates)`, `deleteVoiceChannel(id)`\n- **Dependencies**: Database module, nanoid\n- **Reuses**: Existing model patterns (prepared statements, snake_case columns)\n\n### Component 3: Voice Token Service (`packages/backend/src/services/voice-token.ts`)\n- **Purpose**: Generate LiveKit access tokens for authenticated users\n- **Interfaces**: `generateVoiceToken(userId, username, channelId): Promise with token and wsUrl`\n- **Dependencies**: livekit-server-sdk AccessToken, settings model, voice channel model\n- **Reuses**: Settings model for API credentials\n\n### Component 4: Voice Routes (`packages/backend/src/routes/voice.ts`)\n- **Purpose**: REST API for voice channel CRUD and token generation\n- **Endpoints**: `GET /api/voice/channels`, `POST /api/voice/channels`, `PATCH /api/voice/channels/:id`, `DELETE /api/voice/channels/:id`, `POST /api/voice/token`\n- **Dependencies**: Voice channel model, voice token service, auth middleware, Zod\n- **Reuses**: Route handler patterns, Zod validation, auth middleware\n\n### Component 5: Voice Store (`packages/frontend/src/stores/voiceStore.ts`)\n- **Purpose**: Zustand store for voice state -- channels, current room, participants, mute/deafen, connection status\n- **Interfaces**: `setChannels`, `joinChannel(channelId, token, wsUrl)`, `leaveChannel`, `toggleMute`, `toggleDeafen`, `setParticipantSpeaking`, `setParticipantAudioLevel`\n- **Dependencies**: Zustand, livekit-client Room\n- **Reuses**: Store pattern from serverStore.ts\n\n### Component 6: Voice API Client (`packages/frontend/src/api/voice.ts`)\n- **Purpose**: Frontend API layer for voice endpoints\n- **Interfaces**: `getVoiceChannels()`, `createVoiceChannel(name, options)`, `deleteVoiceChannel(id)`, `getVoiceToken(channelId)`\n- **Dependencies**: API client base\n- **Reuses**: Fetch wrapper patterns from existing API clients\n\n### Component 7: VoiceChannelList Component (`packages/frontend/src/components/voice/VoiceChannelList.tsx`)\n- **Purpose**: Sidebar listing all voice channels with join/leave buttons, active participants, and audio controls\n- **Dependencies**: voiceStore, voice API client, lucide-react icons (Volume2, VolumeX, Headphones, Mic, MicOff, PhoneOff, Plus)\n- **Reuses**: Tailwind dark theme patterns, lucide-react icons\n\n### Component 8: VoiceSettings Component (`packages/frontend/src/components/voice/VoiceSettings.tsx`)\n- **Purpose**: Audio device selection UI (input/output device dropdowns)\n- **Dependencies**: livekit-client Room.getLocalDevices, voiceStore\n- **Reuses**: Tailwind form patterns\n\n### Component 9: Push-to-Talk Hook (`packages/frontend/src/hooks/usePushToTalk.ts`)\n- **Purpose**: Listen for Tauri global shortcut events and toggle microphone\n- **Dependencies**: @tauri-apps/api/event, voiceStore\n- **Reuses**: Tauri event listener pattern\n\n### Component 10: LiveKit Download Script (`packages/desktop/scripts/download-livekit.ts`)\n- **Purpose**: Download platform-specific LiveKit server binary during build\n- **Dependencies**: Node fetch, fs, child_process (for rustc target detection)\n- **Reuses**: None (new build script)\n\n### Component 11: Tauri LiveKit Sidecar (modify `packages/desktop/src-tauri/src/lib.rs`)\n- **Purpose**: Spawn and manage LiveKit server process lifecycle\n- **Dependencies**: Tauri shell plugin, existing AppState\n- **Reuses**: Backend sidecar spawn pattern\n\n## Data Models\n\n### voice_channels table\n\n```sql\nCREATE TABLE IF NOT EXISTS voice_channels (\n  id TEXT PRIMARY KEY,\n  name TEXT NOT NULL,\n  description TEXT,\n  max_participants INTEGER NOT NULL DEFAULT 50,\n  position INTEGER NOT NULL DEFAULT 0,\n  created_by TEXT NOT NULL,\n  created_at INTEGER NOT NULL,\n  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE\n);\n```\n\n### LiveKit settings (in existing settings table)\n\nSettings keys stored as key-value pairs in the existing `settings` table:\n- `livekit_api_key` -- API key for token generation (auto-generated)\n- `livekit_api_secret` -- API secret for token signing (auto-generated)\n- `livekit_port` -- WebSocket port (default 7880)\n- `livekit_rtc_tcp_port` -- RTC TCP port (default 7881)\n- `livekit_rtc_port_range_start` -- UDP port range start (default 50000)\n- `livekit_rtc_port_range_end` -- UDP port range end (default 60000)\n- `livekit_domain` -- Optional domain for TURN server (remote access)\n\n### Shared TypeScript Types\n\n```typescript\n// Voice channel types\nexport interface VoiceChannel {\n  id: string;\n  name: string;\n  description: string | null;\n  maxParticipants: number;\n  position: number;\n  createdBy: string;\n  createdAt: number;\n}\n\nexport interface CreateVoiceChannelRequest {\n  name: string;\n  description?: string;\n  maxParticipants?: number;\n  position?: number;\n}\n\nexport interface UpdateVoiceChannelRequest {\n  name?: string;\n  description?: string;\n  maxParticipants?: number;\n  position?: number;\n}\n\nexport interface VoiceTokenRequest {\n  channelId: string;\n}\n\nexport interface VoiceTokenResponse {\n  token: string;\n  wsUrl: string;\n}\n\n// Voice participant (frontend only, derived from LiveKit events)\nexport interface VoiceParticipant {\n  identity: string;\n  name: string;\n  isSpeaking: boolean;\n  isMuted: boolean;\n  audioLevel: number;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Token request for non-existent channel**\n   - **Handling**: Return 404 NotFoundError. Voice route checks channel exists before generating token.\n   - **User Impact**: \"Voice channel not found\" error toast.\n\n2. **LiveKit credentials not configured**\n   - **Handling**: Return 500 Error with message \"LiveKit credentials not configured\". Should not happen in normal flow since credentials are auto-generated.\n   - **User Impact**: Voice features unavailable, error shown in UI.\n\n3. **LiveKit server not running or unreachable**\n   - **Handling**: LiveKit client SDK connection fails. Frontend catches error, sets error state in voiceStore.\n   - **User Impact**: \"Failed to join voice channel\" error toast. User can retry.\n\n4. **WebRTC not supported in browser/webview**\n   - **Handling**: Check for `navigator.mediaDevices.getUserMedia` at runtime. If unavailable, disable voice features.\n   - **User Impact**: Voice channel join buttons disabled with tooltip explaining incompatibility.\n\n5. **Microphone permission denied**\n   - **Handling**: LiveKit SDK throws on setMicrophoneEnabled. Frontend catches and shows error.\n   - **User Impact**: \"Microphone access denied\" error toast. User can still listen (subscribe) but not speak.\n\n6. **LiveKit sidecar fails to start**\n   - **Handling**: Tauri logs the error. Backend generates config but LiveKit does not start. Token generation succeeds but frontend connection fails.\n   - **User Impact**: Voice features unavailable until app restart. Clear error in UI.\n\n7. **Unexpected LiveKit sidecar termination**\n   - **Handling**: Tauri logs termination code and signal. Active voice connections drop. Frontend receives Disconnected event, resets voice store.\n   - **User Impact**: \"Disconnected from voice channel\" notification. User can rejoin manually.\n\n## File Structure\n\n### New Files\n```\npackages/desktop/scripts/download-livekit.ts                 # Download LiveKit binary\npackages/backend/migrations/009_voice_channels.sql           # Voice channels table + settings\npackages/backend/src/services/livekit-config.ts              # LiveKit config generation\npackages/backend/src/services/voice-token.ts                 # LiveKit token generation\npackages/backend/src/models/voice-channel.ts                 # Voice channel CRUD model\npackages/backend/src/routes/voice.ts                         # Voice REST API\npackages/frontend/src/stores/voiceStore.ts                   # Voice Zustand store\npackages/frontend/src/api/voice.ts                           # Voice API client\npackages/frontend/src/components/voice/VoiceChannelList.tsx  # Voice channel sidebar\npackages/frontend/src/components/voice/VoiceSettings.tsx     # Audio device selection\npackages/frontend/src/hooks/usePushToTalk.ts                 # Push-to-talk hook\nshared/src/index.ts                                          # (modify) Add voice types\n```\n\n### Modified Files\n```\npackages/backend/src/index.ts                                # Generate LiveKit config on startup\npackages/backend/src/app.ts                                  # Mount voice routes\npackages/backend/src/services/settings.ts                    # ensureLiveKitCredentials()\npackages/backend/package.json                                # Add livekit-server-sdk\npackages/frontend/package.json                               # Add livekit-client\npackages/frontend/src/App.tsx                                # Integrate voice UI\npackages/desktop/src-tauri/src/lib.rs                        # LiveKit sidecar + global shortcut\npackages/desktop/src-tauri/tauri.conf.json                   # Add livekit-server to externalBin\npackages/desktop/src-tauri/Cargo.toml                        # Add global-shortcut plugin\npackages/desktop/package.json                                # Add download-livekit script\n```\n\n## Dependencies\n\n### New Backend npm Packages\n- `livekit-server-sdk` (^2.7.0) -- Server-side LiveKit JWT generation. Required for token endpoint.\n\n### New Frontend npm Packages\n- `livekit-client` (^2.6.0) -- LiveKit WebRTC client SDK. Required for connecting to rooms and managing audio tracks.\n\n### New Rust Crates (Tauri)\n- `tauri-plugin-global-shortcut` (2.x) -- Global keyboard shortcuts for push-to-talk.\n\n### External Binary\n- `livekit-server` (1.7.2+) -- LiveKit SFU binary, downloaded per-platform via build script. Bundled as Tauri sidecar.\n\n## Testing Strategy\n\n### Unit Testing\n- No automated test framework exists. Manual verification.\n- Key verification: token generation with correct grants, voice channel CRUD, config YAML generation.\n\n### Integration Testing\n- **LiveKit startup**: Tauri spawns LiveKit, config.yaml generated, server listens on port 7880.\n- **Voice channel CRUD**: Create, list, update, delete channels via REST API.\n- **Token generation**: Backend generates valid JWT, frontend can connect to LiveKit with it.\n- **Join/leave flow**: Join channel, see participant list update, leave channel, participant removed.\n- **Audio transmission**: Speak into mic, other participants hear audio with low latency (at most 200ms).\n- **Mute/deafen**: Mute stops outgoing audio, deafen stops incoming audio, UI reflects state.\n- **Speaking indicators**: Active speakers show green pulsing indicator in real-time.\n- **Push-to-talk**: Ctrl+Space unmutes while held, re-mutes on release (even when app unfocused).\n- **Device selection**: Switch input/output devices without disconnecting from room.\n- **Graceful shutdown**: Close app, LiveKit process killed, voice connections dropped cleanly.\n\n### End-to-End Testing\n- Full voice flow: Authenticate, create channel, join channel, verify audio works between two participants, mute/unmute, leave channel, delete channel.\n- Multi-participant: 5+ users in same channel, all audio streams working, speaking indicators correct.\n- Cross-platform: Test on macOS (WKWebView), Windows (WebView2), Linux (WebKitGTK 4.1+).\n- Error recovery: Kill LiveKit mid-session, verify frontend shows error, rejoin works after restart.\n",
  "fileStats": {
    "size": 15769,
    "lines": 312,
    "lastModified": "2026-02-12T00:31:56.409Z"
  },
  "comments": []
}