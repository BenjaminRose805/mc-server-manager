{
  "id": "snapshot_1771012554845_d29gyjugx",
  "approvalId": "approval_1771012554833_4m0fhbzu0",
  "approvalTitle": "Tasks: Electron Desktop Builds CI/CD",
  "version": 1,
  "timestamp": "2026-02-13T19:55:54.845Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n- [ ] 1. Create macOS entitlements file\n  - Files: `packages/electron/build/entitlements.mac.plist` (new)\n  - Create the macOS entitlements plist required for hardened runtime. Grants JIT, unsigned executable memory, dyld environment variables, and library validation exemption — all required for Electron apps.\n  - Purpose: Foundation for macOS code signing. Referenced by electron-builder config.\n  - _Leverage: Design document entitlements section in `.spec-workflow/specs/electron-desktop-builds/design.md` Component 3_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec electron-desktop-builds, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: DevOps Engineer with macOS code signing experience | Task: (1) Create the directory `packages/electron/build/` if it doesn't exist. (2) Create `packages/electron/build/entitlements.mac.plist` with the following XML content — a standard Apple property list granting these entitlements: `com.apple.security.cs.allow-jit` (true), `com.apple.security.cs.allow-unsigned-executable-memory` (true), `com.apple.security.cs.allow-dyld-environment-variables` (true), `com.apple.security.cs.disable-library-validation` (true). Use the standard Apple plist DTD header. | Restrictions: Do NOT add any entitlements beyond these four — they are the minimum required for Electron. Do NOT modify any other files in this task. | Success: File exists at `packages/electron/build/entitlements.mac.plist`, is valid XML, contains exactly the four entitlements listed. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 2. Update electron-builder configuration\n  - Files: `packages/electron/package.json` (modify)\n  - Update the `build` section: change `publish` from `null` to GitHub provider with draft releases, set `npmRebuild` to `true` (remove `nodeGypRebuild: false`), add entitlements references to mac section, add `notarize` field to mac section. Update `scripts`: simplify `dist:win` to remove the manual `prebuild-install` hack (just `electron-builder --win`).\n  - Purpose: Make electron-builder config CI-compatible while preserving local builds\n  - _Leverage: Current `packages/electron/package.json` build section, design document Component 2 in `.spec-workflow/specs/electron-desktop-builds/design.md`_\n  - _Requirements: REQ-1, REQ-2, REQ-3, REQ-4, REQ-5, REQ-8_\n  - _Prompt: Implement the task for spec electron-desktop-builds, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Electron/DevOps Engineer | Task: Read `packages/electron/package.json` to understand the current build configuration. Make these specific changes: (1) In `build.publish`: change from `null` to `{ \"provider\": \"github\", \"releaseType\": \"draft\" }`. (2) In `build`: change `\"npmRebuild\": false` to `\"npmRebuild\": true`. Remove the `\"nodeGypRebuild\": false` line. (3) In `build.mac`: add `\"entitlements\": \"build/entitlements.mac.plist\"` and `\"entitlementsInherit\": \"build/entitlements.mac.plist\"`. (4) In `scripts.dist:win`: change from the long command with `cd ../../node_modules/better-sqlite3 && npx prebuild-install...` to simply `\"electron-builder --win\"`. Keep all other config unchanged (targets, files, extraResources, asar, nsis, linux, win sections). | Restrictions: Do NOT change platform targets (nsis, dmg, AppImage, deb). Do NOT change file patterns or extraResources. Do NOT change appId or productName. Do NOT add or remove dependencies. Keep the `dist` and `rebuild` scripts unchanged. | Success: `packages/electron/package.json` is valid JSON. The `build.publish` is set to GitHub provider. `npmRebuild` is true. `nodeGypRebuild` line is removed. Mac entitlements are referenced. `dist:win` script is simplified. All other config is unchanged. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 3. Create GitHub Actions workflow file\n  - Files: `.github/workflows/build-electron.yml` (new)\n  - Create the complete GitHub Actions workflow with 4 jobs: build-linux, build-macos, build-windows (parallel), and release (sequential after all builds). Each build job: checks out code, sets up Node.js with npm caching, caches Electron/electron-builder, runs `npm ci`, runs `npx electron-builder install-app-deps` from the electron package, runs the full build chain (`npm run build`), then runs electron-builder with `--publish never`. Conditional code signing on macOS and Windows. The release job downloads all artifacts and creates a draft GitHub Release using softprops/action-gh-release.\n  - Purpose: The main deliverable — automated cross-platform builds on tag push\n  - _Leverage: Design document Component 1 in `.spec-workflow/specs/electron-desktop-builds/design.md`, root `package.json` build scripts, `packages/electron/package.json` for electron-builder config_\n  - _Requirements: REQ-1, REQ-2, REQ-3, REQ-4, REQ-5, REQ-6, REQ-7_\n  - _Prompt: Implement the task for spec electron-desktop-builds, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Senior DevOps Engineer with GitHub Actions and Electron expertise | Task: Read `.spec-workflow/specs/electron-desktop-builds/design.md` for the full architecture. Read `packages/electron/package.json` for the electron-builder config (targets, output directory). Read root `package.json` for the build scripts. Create `.github/workflows/build-electron.yml` with the following structure: **Triggers**: `push.tags: ['v*']` and `workflow_dispatch: {}`. **Permissions**: `contents: write`. **Jobs**: (1) `build-linux` on `ubuntu-latest`: checkout@v4, setup-node@v4 with node-version 22 and cache 'npm', cache Electron binaries (`~/.cache/electron` and `~/.cache/electron-builder`) keyed on `${{ runner.os }}-electron-${{ hashFiles('**/package-lock.json') }}`, run `npm ci`, run `npm run build` (builds shared+backend+frontend), run `npm run build -w @mc-server-manager/electron` (builds electron TypeScript), run `npx electron-builder install-app-deps` with working-directory `packages/electron`, run `npx electron-builder --linux --publish never` with working-directory `packages/electron`, upload-artifact@v4 with name `linux-artifacts` and path `packages/electron/release/*.AppImage` + `packages/electron/release/*.deb`. (2) `build-macos` on `macos-latest`: same as linux but run `npx electron-builder --mac --publish never`, add conditional code signing env vars (`CSC_LINK: ${{ secrets.MAC_CERTIFICATE }}`, `CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTIFICATE_PASSWORD }}`) on the electron-builder step ONLY if `secrets.MAC_CERTIFICATE` is not empty (use `if` condition or env fallback), add notarization env vars (`APPLE_ID: ${{ secrets.APPLE_ID }}`, `APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}`, `APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}`) conditionally, upload `packages/electron/release/*.dmg` as `macos-artifacts`. (3) `build-windows` on `windows-latest`: same as linux but run `npx electron-builder --win --publish never`, add conditional signing env vars (`WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}`, `WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}`), upload `packages/electron/release/*.exe` as `windows-artifacts`. (4) `release` on `ubuntu-latest` with `needs: [build-linux, build-macos, build-windows]` and `if: startsWith(github.ref, 'refs/tags/v')`: download-artifact@v4 for all three artifact names into a `release-assets/` directory, then use `softprops/action-gh-release@v2` with `draft: true`, `generate_release_notes: true`, and `files: release-assets/**/*`. Add good YAML comments explaining each section, especially the code signing conditionals and the native module rebuild step. | Restrictions: Do NOT use matrix strategy — use separate jobs per platform for clarity and per-platform signing logic. Do NOT hardcode secrets — always reference `${{ secrets.* }}`. Do NOT use `--publish always` — use `--publish never` in build steps (the release job handles publishing). Do NOT skip the `electron-builder install-app-deps` step — this is critical for native module compilation. Use Node.js 22 (LTS). | Success: The YAML file is valid. It has 4 jobs. Build jobs are independent (fail-independently). Release job depends on all 3. Code signing is conditional (workflow succeeds without signing secrets). Caching is configured for npm and Electron. The workflow triggers on v* tags and workflow_dispatch. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 4. Verification and build test\n  - Files: Various (read-only verification)\n  - Verify the workflow YAML is valid, electron-builder config is valid JSON, entitlements file is valid XML. Run `npm run build` to confirm TypeScript compilation still succeeds. Verify local electron-builder config works by dry-running the dist script if possible.\n  - Purpose: Ensure everything is correct before pushing\n  - _Leverage: Root `package.json` build scripts_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec electron-desktop-builds, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Senior Developer / QA | Task: (1) Read `.github/workflows/build-electron.yml` and verify it has: 4 jobs (build-linux, build-macos, build-windows, release), triggers on push tags v* and workflow_dispatch, permissions contents write, Node.js 22, npm caching, Electron caching, `electron-builder install-app-deps` in each build job, conditional code signing env vars, release job with needs and if condition, softprops/action-gh-release with draft true. (2) Read `packages/electron/package.json` and verify: `build.publish` is `{ \"provider\": \"github\", \"releaseType\": \"draft\" }`, `npmRebuild` is true, `nodeGypRebuild` is removed, `mac.entitlements` and `mac.entitlementsInherit` reference `build/entitlements.mac.plist`, `scripts.dist:win` is `electron-builder --win` (no prebuild-install hack). (3) Read `packages/electron/build/entitlements.mac.plist` and verify it has exactly 4 entitlements. (4) Run `npm run build` from root — must succeed with zero errors. (5) Verify no secrets or credentials are hardcoded anywhere in the new files (grep for any suspicious strings). | Restrictions: Do NOT make changes unless build is broken. This is verification only. If build fails, fix the specific TypeScript/config issue. | Success: All 4 verifications pass, `npm run build` exits 0, no hardcoded secrets found. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n",
  "fileStats": {
    "size": 10818,
    "lines": 34,
    "lastModified": "2026-02-13T19:55:50.046Z"
  },
  "comments": []
}