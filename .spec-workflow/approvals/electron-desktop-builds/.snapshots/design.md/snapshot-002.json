{
  "id": "snapshot_1771012470995_h7229yog0",
  "approvalId": "approval_1771012096943_lkufkb0vf",
  "approvalTitle": "Design: Electron Desktop Builds CI/CD",
  "version": 2,
  "timestamp": "2026-02-13T19:54:30.995Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis spec adds a GitHub Actions workflow that automatically builds, optionally signs, and publishes Electron desktop installers for Windows, macOS, and Linux. The workflow triggers on `v*` tag pushes and manual dispatch. It handles the monorepo build chain (shared -> backend -> frontend -> electron), rebuilds native modules (better-sqlite3, argon2) per platform, and publishes artifacts to draft GitHub Releases.\n\nThis is purely CI/CD infrastructure -- no application runtime code changes. The deliverables are: one workflow YAML file, updated electron-builder configuration, a macOS entitlements file, and cleanup of the existing native module hacks.\n\n## Steering Document Alignment\n\nPer `product.md`: \"Automated cross-platform desktop builds via GitHub Actions\" is in the near-term vision and \"Cross-platform desktop builds\" is a success metric. Per `tech.md`: electron-builder 25.x is the packaging tool, with targets for NSIS (Windows), DMG (macOS x64+arm64), and AppImage+DEB (Linux x64). Per `structure.md`: the electron package lives at `packages/electron/` with build config embedded in its `package.json`.\n\n## Code Reuse Analysis\n\n### Existing Code to Leverage\n\n- **`packages/electron/package.json` (build section)**: Already has complete electron-builder config with platform targets, asar settings, extraResources mappings, and NSIS options. The CI workflow will invoke this config as-is with minimal modifications.\n- **`package.json` (root)**: Has `build:electron:win`, `build:electron:mac`, `build:electron:linux` scripts that chain the full build. The workflow will call a simplified version of these.\n- **`packages/electron/release/builder-debug.yml`**: Debug output from a previous local Windows build. Confirms the NSIS installer pipeline works. This file is gitignored and irrelevant to CI.\n\n### Integration Points\n\n- **GitHub Actions**: New `.github/workflows/build-electron.yml` triggers on tag push and workflow_dispatch.\n- **electron-builder publish config**: Currently `\"publish\": null`. Will be changed to GitHub provider so electron-builder can upload artifacts to releases.\n- **npm workspaces**: `npm ci` at root installs all workspace dependencies. Build scripts already handle the shared -> backend -> frontend -> electron chain.\n\n### Shared Types Already Available\n\nNo shared types are affected. This spec does not touch runtime code.\n\n## Architecture\n\n```\nDeveloper pushes v* tag\n        |\n        v\nGitHub Actions triggers build-electron.yml\n        |\n        +----> [ubuntu-latest]  --> npm ci --> build all --> electron-builder --linux --> upload\n        |\n        +----> [macos-latest]   --> npm ci --> build all --> electron-builder --mac   --> upload\n        |\n        +----> [windows-latest] --> npm ci --> build all --> electron-builder --win   --> upload\n        |\n        v\nAll 3 jobs complete\n        |\n        v\n[ubuntu-latest] Release job --> Download all artifacts --> Create/update draft GitHub Release\n```\n\n### Design Principles Applied\n\n- **Separate jobs per platform**: Each OS builds natively (no cross-compilation). Native modules compile against the target platform's Electron headers. Code signing secrets are scoped per platform.\n- **Dedicated release job**: A fourth job (`release`) runs after all builds succeed, downloads artifacts, and creates a single draft release. This avoids race conditions from three jobs publishing simultaneously.\n- **Graceful degradation**: Code signing is optional. When secrets are missing, signing steps are skipped using GitHub Actions conditional expressions (`if: env.MAC_CERTIFICATE != ''`).\n\n## Components and Interfaces\n\n### Component 1: Workflow File (`.github/workflows/build-electron.yml`)\n\n- **Purpose**: GitHub Actions workflow that orchestrates cross-platform Electron builds and release publishing.\n- **Structure**:\n\n```yaml\nname: Build Electron App\n\non:\n  push:\n    tags: ['v*']\n  workflow_dispatch: {}\n\npermissions:\n  contents: write  # Needed for release creation\n\njobs:\n  build-linux:\n    runs-on: ubuntu-latest\n    # Steps: checkout, setup-node, cache, npm ci, build chain, \n    # electron-builder install-app-deps, electron-builder --linux --publish never,\n    # upload-artifact\n\n  build-macos:\n    runs-on: macos-latest\n    # Steps: same as linux, plus conditional code signing + notarization\n    # env: CSC_LINK, CSC_KEY_PASSWORD, APPLE_ID, APPLE_APP_SPECIFIC_PASSWORD, APPLE_TEAM_ID\n\n  build-windows:\n    runs-on: windows-latest\n    # Steps: same as linux, plus conditional code signing\n    # env: WIN_CSC_LINK, WIN_CSC_KEY_PASSWORD\n\n  release:\n    runs-on: ubuntu-latest\n    needs: [build-linux, build-macos, build-windows]\n    if: startsWith(github.ref, 'refs/tags/v')\n    # Steps: download all artifacts, create/update draft release with softprops/action-gh-release\n```\n\n- **Dependencies**: GitHub Actions runners, actions/checkout@v4, actions/setup-node@v4, actions/cache@v4, actions/upload-artifact@v4, actions/download-artifact@v4, softprops/action-gh-release@v2\n- **Reuses**: Root `package.json` build scripts\n\n### Component 2: Updated electron-builder Config (`packages/electron/package.json`)\n\n- **Purpose**: Update the `build` section to support CI publishing and fix native module handling.\n- **Changes**:\n\n```jsonc\n{\n  \"build\": {\n    // CHANGE: Enable publish to GitHub\n    \"publish\": {\n      \"provider\": \"github\",\n      \"releaseType\": \"draft\"\n    },\n    // CHANGE: Enable native module rebuild (remove the disable flags)\n    \"npmRebuild\": true,\n    // KEEP: Everything else stays the same (targets, asar, extraResources, etc.)\n  },\n  \"scripts\": {\n    // CHANGE: Remove the prebuild-install hack from dist:win\n    \"dist:win\": \"electron-builder --win\",\n    // KEEP: dist, rebuild unchanged\n  }\n}\n```\n\n- **Dependencies**: No new dependencies\n- **Reuses**: All existing electron-builder config (targets, files, extraResources)\n\n### Component 3: macOS Entitlements (`packages/electron/build/entitlements.mac.plist`)\n\n- **Purpose**: Required for macOS hardened runtime. Grants permissions Electron apps need to function.\n- **Content**:\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n<plist version=\"1.0\">\n<dict>\n  <key>com.apple.security.cs.allow-jit</key>\n  <true/>\n  <key>com.apple.security.cs.allow-unsigned-executable-memory</key>\n  <true/>\n  <key>com.apple.security.cs.allow-dyld-environment-variables</key>\n  <true/>\n  <key>com.apple.security.cs.disable-library-validation</key>\n  <true/>\n</dict>\n</plist>\n```\n\n- **Dependencies**: Referenced by electron-builder mac config via `entitlements` and `entitlementsInherit` keys\n- **Reuses**: Standard Electron entitlements\n\n## Data Models\n\nNo new data models. This spec does not touch the database or shared types.\n\n## API Endpoints\n\nNo new API endpoints. This spec does not touch the backend HTTP/WS server.\n\n## WebSocket Events\n\nNo new WebSocket events. This spec is infrastructure only.\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Native module compilation failure**\n   - **Handling**: The `electron-builder install-app-deps` step will fail with a non-zero exit code, logging the compiler error output.\n   - **User Impact**: GitHub Actions marks the job as failed. Developer sees the exact compilation error in the workflow logs.\n\n2. **Code signing secrets missing**\n   - **Handling**: Conditional `if` expressions skip signing steps entirely. The build produces unsigned installers.\n   - **User Impact**: None -- the workflow succeeds. Unsigned installers are uploaded.\n\n3. **macOS notarization failure (Apple service issue)**\n   - **Handling**: electron-builder's notarization step will fail with Apple's error response.\n   - **User Impact**: macOS build job fails. The developer can re-run the workflow or check Apple's service status.\n\n4. **GitHub Release already exists for tag**\n   - **Handling**: `softprops/action-gh-release` with `draft: true` will update the existing draft release rather than creating a duplicate.\n   - **User Impact**: None -- idempotent behavior.\n\n5. **One platform build fails, others succeed**\n   - **Handling**: Each platform is an independent job. The `release` job requires all three to succeed (`needs: [build-linux, build-macos, build-windows]`), so no partial release is created. Individual platform artifacts are still uploaded to the workflow run.\n   - **User Impact**: Developer sees which platform failed. Successful platforms' artifacts are still downloadable from the workflow run (not from a release).\n\n## Verification Strategy\n\n### Build Verification\n\n- The workflow YAML must pass GitHub Actions syntax validation (no YAML errors on push)\n- `npm run build` must pass locally with zero errors after electron-builder config changes\n- Local `npm run dist -w @mc-server-manager/electron -- --linux` (or `--win`/`--mac` depending on dev machine) must still work\n\n### Manual Testing Checklist\n\n1. Push a test tag `v0.0.0-test.1` -> workflow triggers, all 3 platform jobs start\n2. Linux job completes -> produces `.AppImage` and `.deb` in workflow artifacts\n3. macOS job completes -> produces `.dmg` files (x64 + arm64) in workflow artifacts\n4. Windows job completes -> produces `.exe` NSIS installer in workflow artifacts\n5. Release job runs -> draft GitHub Release created with all artifacts attached\n6. Trigger `workflow_dispatch` manually (no tag) -> builds complete, artifacts uploaded, NO release created\n7. Re-push same tag -> draft release is updated (not duplicated)\n8. Run without signing secrets -> builds succeed with unsigned installers\n9. Local `build:electron:win` / `build:electron:mac` / `build:electron:linux` scripts still work\n\n## Implementation Order\n\n1. **macOS entitlements file** -- No dependencies. Create `packages/electron/build/entitlements.mac.plist`. Pure file creation.\n2. **electron-builder config updates** -- Update `packages/electron/package.json`: change `publish` from `null` to GitHub provider, set `npmRebuild: true`, remove `prebuild-install` hack from `dist:win`, add entitlements references to `mac` section. Verify local build still works.\n3. **GitHub Actions workflow** -- Create `.github/workflows/build-electron.yml` with all 4 jobs (build-linux, build-macos, build-windows, release). This is the main deliverable. Depends on (1) and (2) being committed.\n4. **Verification** -- Push a test tag and validate all jobs. Confirm artifacts and draft release.\n\nEach step can be verified independently before proceeding to the next.\n",
  "fileStats": {
    "size": 10520,
    "lines": 220,
    "lastModified": "2026-02-13T19:48:12.135Z"
  },
  "comments": []
}