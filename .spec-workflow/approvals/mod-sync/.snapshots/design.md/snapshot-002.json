{
  "id": "snapshot_1770856761855_nm6qhdytc",
  "approvalId": "approval_1770856710340_h5zixq7qu",
  "approvalTitle": "EPIC-9: Mod Sync â€” Design Document",
  "version": 2,
  "timestamp": "2026-02-12T00:39:21.855Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document -- Server-Client Mod Synchronization\n\n## Overview\n\nEnable automatic mod synchronization when a user joins a shared Minecraft server. The host's backend generates a canonical mod manifest from its installed mods (Epic 2 data). The client fetches this manifest, compares it to the local instance's mods (Epic 4 data), computes a diff, and presents a confirmation dialog. After confirmation, missing mods are downloaded from trusted sources (Modrinth CDN or the community server), verified by SHA-1 hash, and installed. Incompatible mods are disabled. The game then launches and auto-connects.\n\n## Steering Document Alignment\n\nNo steering docs exist. This design follows existing project conventions (Express routes, Zod validation, SQLite models, Zustand stores, Tailwind UI, WebSocket message protocol with `type` discriminator). It builds on Epic 2 (server mods), Epic 4 (client mods), and Epic 7 (community/shared server infrastructure).\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **ModModel (`packages/backend/src/models/mod.ts`)**: From Epic 2 -- provides `getByServerId()` to list installed server mods with hashes, Modrinth IDs, file names, and side metadata. Core data source for manifest generation.\n- **ServerModel (`packages/backend/src/models/server.ts`)**: Provides server name, version, and jar type for manifest metadata.\n- **Community routes (`packages/backend/src/routes/community.ts`)**: From Epic 7 -- existing route file where manifest and mod download endpoints are added. Already has auth/access checking patterns.\n- **CommunityService (`packages/backend/src/services/community-service.ts`)**: From Epic 7 -- provides `checkServerAccess()` for authorization checks.\n- **InstalledMod type (`shared/src/index.ts`)**: From Epic 4 -- the client-side mod type used for diff comparison against manifest mods.\n- **Error classes (`packages/backend/src/utils/errors.ts`)**: NotFoundError, ForbiddenError for endpoint error handling.\n- **Zod validation**: All new route handlers use Zod schemas following existing patterns.\n- **Pino logger**: Existing logger for manifest generation and download logging.\n- **Tailwind component patterns**: Existing dialog/modal patterns reused for ModSyncDialog.\n- **lucide-react icons**: Download, AlertTriangle, Check, X icons for sync dialog sections.\n\n### Integration Points\n- **`installed_mods` table (Epic 2)**: Source data for manifest generation -- mod name, version, hash, Modrinth ID, side, file name.\n- **Client instance mod list (Epic 4)**: Local mods fetched via API for diff computation against the manifest.\n- **SharedServerCard component (Epic 7)**: The \"Join\" button is modified to trigger the sync flow before launching.\n- **Community server access control (Epic 7)**: Manifest and mod download endpoints reuse the same access checking.\n- **Express app (`app.ts`)**: No new route mounting needed -- endpoints are added to existing community routes.\n- **Shared types (`shared/src/index.ts`)**: New types exported alongside existing types.\n\n## Architecture\n\n### Sync Protocol Flow\n\n```\nUser clicks \"Join\" on shared server\n  |\n  +--> Frontend: GET /api/community/servers/:id/mod-manifest\n  |      +--> Backend: Read installed_mods for server from DB\n  |      +--> Backend: Build ServerModManifest with download URLs\n  |      +--> Backend: Return manifest JSON\n  |\n  +--> Frontend: Fetch local instance mods from client DB\n  |\n  +--> Frontend: Compute ModSyncDiff (client-side, in-memory)\n  |      +--> Compare by hash (exact match) and Modrinth ID (version match)\n  |      +--> Categorize: toInstall, toUpdate, toRemove, toDisable, toKeep\n  |\n  +--> Frontend: Show ModSyncDialog (if changes needed)\n  |      +--> User reviews changes and confirms or cancels\n  |\n  +--> Frontend: Download mods (parallel, concurrency=5)\n  |      +--> Validate URL against trusted domain whitelist\n  |      +--> Download file bytes\n  |      +--> Compute SHA-1, compare to manifest hash\n  |      +--> Write file to instance mods/ directory\n  |      +--> Update installed_mods DB record\n  |\n  +--> Frontend: Disable incompatible mods (.jar to .jar.disabled)\n  |\n  +--> Frontend: Launch Minecraft with instance, auto-connect to server\n```\n\n### Manifest Generation Flow (Backend)\n\n```\nGET /api/community/servers/:id/mod-manifest\n  |\n  +--> Auth: Verify user has access to this shared server\n  |\n  +--> ModManifestService.generateManifest(serverId)\n  |      +--> ServerModel.getById(serverId) -- get server metadata\n  |      +--> ModModel.getByServerId(serverId) -- get all installed mods\n  |      +--> For each enabled mod:\n  |      |      +--> If has modrinthId + versionId: CDN URL\n  |      |      +--> Else: community server file endpoint URL\n  |      |      +--> Categorize by side: required (server/both) or optional (client)\n  |      +--> Return ServerModManifest\n  |\n  +--> Response: JSON manifest\n```\n\n### Diff Computation Flow (Frontend)\n\n```\ncomputeDiff(manifest, localMods)\n  |\n  +--> Build lookup maps:\n  |      +--> localByHash: Map of fileHash to InstalledMod\n  |      +--> localByModrinthId: Map of modrinthId to InstalledMod\n  |      +--> manifestByHash: Map of fileHash to ManifestMod\n  |      +--> manifestByModrinthId: Map of modrinthId to ManifestMod\n  |\n  +--> For each required manifest mod:\n  |      +--> Hash match in local? --> skip (already installed)\n  |      +--> Modrinth ID match? --> toUpdate (version differs)\n  |      +--> No match? --> toInstall\n  |\n  +--> For each local mod not matched above:\n  |      +--> In incompatibleMods list? --> toDisable\n  |      +--> Side is \"client\"? --> toKeep\n  |      +--> Side is \"server\"/\"both\"? --> toRemove\n  |      +--> Unknown side? --> toKeep (safe default)\n  |\n  +--> Return ModSyncDiff\n```\n\n## Components and Interfaces\n\n### Component 1: ModManifestService (`packages/backend/src/services/mod-manifest-service.ts`)\n- **Purpose**: Generate a ServerModManifest from a server's installed mods. Reads the mod database, builds download URLs, categorizes mods by side.\n- **Interfaces**: `generateManifest(serverId: string): Promise<ServerModManifest>`, private `getDownloadUrl(mod, serverId): string`, private `detectLoader(server): ModLoaderInfo`\n- **Dependencies**: ModModel (Epic 2), ServerModel, NotFoundError\n- **Reuses**: Existing model query patterns, Modrinth CDN URL format from Epic 2\n\n### Component 2: Manifest API Endpoint (added to `packages/backend/src/routes/community.ts`)\n- **Purpose**: Expose the mod manifest and mod file downloads via REST API\n- **Endpoints**: `GET /api/community/servers/:id/mod-manifest`, `GET /api/community/servers/:serverId/mods/:hash/download`\n- **Dependencies**: ModManifestService, CommunityService (access checks), ModModel, path module\n- **Reuses**: Existing community route patterns, access control from Epic 7\n\n### Component 3: ModSyncService (`packages/frontend/src/services/mod-sync-service.ts`)\n- **Purpose**: Client-side service that compares a server manifest with local instance mods, producing a ModSyncDiff. Also provides download size estimation and formatting.\n- **Interfaces**: `computeDiff(manifest: ServerModManifest, localMods: InstalledMod[]): ModSyncDiff`, `estimateDownloadSize(diff: ModSyncDiff): number`, `formatSize(bytes: number): string`\n- **Dependencies**: Shared types (ServerModManifest, ModSyncDiff, InstalledMod, ManifestMod)\n- **Reuses**: None (new pure logic service)\n\n### Component 4: ModDownloadService (`packages/frontend/src/services/mod-download-service.ts`)\n- **Purpose**: Download mod files from trusted sources, verify SHA-1 hashes, install to client instance. Manages parallel downloads with concurrency limiting and progress reporting.\n- **Interfaces**: `downloadAndInstall(instanceId: string, mods: ManifestMod[], onProgress: (progress: ModSyncProgress) => void): Promise<ModDownloadResult>`, private `downloadFile(url: string): Promise<Uint8Array>`, private `isTrustedUrl(url: string): boolean`, private `computeSHA1(data: Uint8Array): string`, private `installMod(instanceId, mod, fileData): Promise<void>`\n- **Dependencies**: ManifestMod, ModSyncProgress types, Tauri invoke API (for file system operations)\n- **Reuses**: Tauri HTTP client for downloads (bypasses CORS), Tauri file system for mod installation\n\n### Component 5: ModSyncDialog (`packages/frontend/src/components/community/ModSyncDialog.tsx`)\n- **Purpose**: Confirmation dialog showing the mod sync diff grouped by category (install, update, remove, disable, keep). Displays download size estimate and confirm/cancel buttons.\n- **Props**: `manifest: ServerModManifest`, `diff: ModSyncDiff`, `onConfirm: () => void`, `onCancel: () => void`\n- **Dependencies**: ModSyncService (for size formatting), lucide-react icons, shared types\n- **Reuses**: Tailwind dialog/modal patterns, lucide-react icons\n\n### Component 6: ModSyncProgressDialog (`packages/frontend/src/components/community/ModSyncProgressDialog.tsx`)\n- **Purpose**: Progress overlay during mod download/install. Shows current phase, mod name, progress bar, and error messages.\n- **Props**: `progress: ModSyncProgress`\n- **Dependencies**: ModSyncProgress type, lucide-react Loader2 icon\n- **Reuses**: Tailwind progress bar patterns\n\n### Component 7: Join Flow Integration (modified `packages/frontend/src/components/community/SharedServerCard.tsx`)\n- **Purpose**: Wire the sync flow into the existing \"Join\" button. On click: fetch manifest, compute diff, show dialog or launch directly, handle sync confirmation and progress.\n- **Dependencies**: ModSyncService, ModDownloadService, ModSyncDialog, ModSyncProgressDialog, community API client\n- **Reuses**: Existing SharedServerCard from Epic 7, client instance store from Epic 4\n\n## Data Models\n\nNo new database tables are needed. This epic reads from existing tables (installed_mods from Epic 2, client instance mods from Epic 4, community server data from Epic 7).\n\n### Shared TypeScript Types\n\nAdded to `shared/src/index.ts`:\n\n```typescript\n// Mod loader type (may already exist from Epic 2)\n// type ModLoader = 'fabric' | 'forge' | 'neoforge' | 'quilt';\n\ninterface ServerModManifest {\n  serverId: string;\n  serverName: string;\n  mcVersion: string;\n  loader: ModLoader;\n  loaderVersion: string;\n  requiredMods: ManifestMod[];\n  optionalMods: ManifestMod[];\n  incompatibleMods: string[];  // Modrinth project IDs that must NOT be installed\n  generatedAt: string;         // ISO timestamp\n}\n\ninterface ManifestMod {\n  modrinthId: string | null;   // null for non-Modrinth mods\n  fileName: string;\n  fileHash: string;            // SHA-1\n  fileSize: number;\n  downloadUrl: string;         // Modrinth CDN or community server URL\n  name: string;\n  version: string;\n  side: 'server' | 'client' | 'both';\n}\n\ninterface ModSyncDiff {\n  toInstall: ManifestMod[];\n  toUpdate: Array<{\n    current: InstalledMod;\n    target: ManifestMod;\n  }>;\n  toRemove: InstalledMod[];\n  toDisable: InstalledMod[];\n  toKeep: InstalledMod[];\n  optionalAvailable: ManifestMod[];\n}\n\ninterface ModSyncProgress {\n  phase: 'downloading' | 'verifying' | 'installing' | 'complete' | 'error';\n  currentMod: string | null;\n  completed: number;\n  total: number;\n  error: string | null;\n}\n\ninterface ModSyncResult {\n  success: boolean;\n  installed: number;\n  updated: number;\n  removed: number;\n  disabled: number;\n  errors: string[];\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Server not found or no access**\n   - **Handling**: Manifest endpoint returns 403 ForbiddenError or 404 NotFoundError.\n   - **User Impact**: Toast error \"No access to this server\" or \"Server not found\".\n\n2. **Hash mismatch after download**\n   - **Handling**: Downloaded file is deleted. Error recorded for that mod. Other downloads continue.\n   - **User Impact**: Progress dialog shows error. Sync result lists failed mods. User can retry.\n\n3. **Download failure (network error)**\n   - **Handling**: Error recorded for that specific mod. Other parallel downloads continue unaffected.\n   - **User Impact**: Progress dialog shows error for that mod. Partial sync result shown with option to retry.\n\n4. **Untrusted download URL**\n   - **Handling**: Download rejected immediately with security error. File is not downloaded.\n   - **User Impact**: Error shown: \"Untrusted download URL\" for the specific mod.\n\n5. **No compatible client instance**\n   - **Handling**: Join flow checks for a client instance matching the server's Minecraft version before fetching manifest.\n   - **User Impact**: Toast error \"No compatible client instance found for version X.Y.Z\".\n\n6. **Path traversal in mod file download**\n   - **Handling**: Backend resolves the file path and verifies it is within the server directory. Returns 403 if not.\n   - **User Impact**: Never seen by legitimate users. Blocks malicious requests.\n\n7. **Stale manifest**\n   - **Handling**: Manifest includes `generatedAt` timestamp. Future enhancement: warn if manifest is older than 1 hour.\n   - **User Impact**: Rare edge case where host updates mods after manifest was generated.\n\n8. **Mod file not found on server**\n   - **Handling**: Mod download endpoint returns 404. Treated as a download failure.\n   - **User Impact**: Error for that specific mod in sync results.\n\n## File Structure\n\n### New Files\n```\npackages/backend/src/services/mod-manifest-service.ts        # Manifest generation service\npackages/frontend/src/services/mod-sync-service.ts            # Diff computation service\npackages/frontend/src/services/mod-download-service.ts        # Download + hash verify service\npackages/frontend/src/components/community/ModSyncDialog.tsx   # Sync confirmation dialog\npackages/frontend/src/components/community/ModSyncProgressDialog.tsx  # Progress overlay\n```\n\n### Modified Files\n```\nshared/src/index.ts                                            # Add mod sync types\npackages/backend/src/routes/community.ts                       # Add manifest + download endpoints\npackages/frontend/src/components/community/SharedServerCard.tsx # Wire sync into Join button\n```\n\n## Dependencies\n\n### New Backend npm Packages\n- None required. All functionality uses existing packages (express, better-sqlite3, path, crypto).\n\n### New Frontend npm Packages\n- None required. Uses existing Tauri invoke API for file system operations and HTTP downloads. SHA-1 computed via Web Crypto API or Tauri backend.\n\n## Testing Strategy\n\n### Unit Testing\n- No automated test framework exists. Manual verification.\n- Key verification: diff computation logic (all 5 categories), hash verification, URL validation.\n\n### Integration Testing\n- **No changes needed**: Join a server where local mods already match the manifest. Verify no dialog appears and game launches directly.\n- **Install required mod**: Server requires Sodium, client does not have it. Dialog shows \"Install 1 mod\". Confirm. Mod downloaded, verified, installed. Game launches.\n- **Update mod version**: Client has Sodium 0.5.0, server requires 0.6.0. Dialog shows \"Update 1 mod\" with version change. Old version replaced.\n- **Remove extra server mod**: Client has a server-side mod not in manifest. Dialog shows \"Remove 1 mod\" with warning. Mod disabled.\n- **Disable incompatible mod**: Client has a minimap mod marked incompatible by server. Dialog shows \"Disable 1 incompatible mod\". Mod renamed to .jar.disabled.\n- **Keep client-only mod**: Client has OptiFine (client-only). Dialog shows \"Keep 1 client-only mod\" in collapsible section.\n- **Hash mismatch**: Simulate corrupted download. Verify file is deleted, error shown, mod not installed.\n- **Untrusted URL**: Manifest contains URL from untrusted domain. Verify download is rejected with security error.\n- **Cancel sync**: Open sync dialog, click Cancel. Verify no changes made.\n- **Large modpack**: Server with 50+ mods. Progress dialog shows phases. All mods installed successfully.\n- **Non-Modrinth mod**: Server has custom mod without Modrinth ID. Downloaded from community server file endpoint.\n\n### End-to-End Testing\n- Full flow: Host adds mods to server via Epic 2, shares server via Epic 7, player clicks Join, sync dialog appears, player confirms, mods sync, game launches and connects.\n",
  "fileStats": {
    "size": 16108,
    "lines": 301,
    "lastModified": "2026-02-12T00:32:50.454Z"
  },
  "comments": []
}