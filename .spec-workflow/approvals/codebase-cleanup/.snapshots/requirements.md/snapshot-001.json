{
  "id": "snapshot_1771193116510_ploq3r6h9",
  "approvalId": "approval_1771193116471_bgk5s3c0n",
  "approvalTitle": "Codebase Cleanup Requirements",
  "version": 1,
  "timestamp": "2026-02-15T22:05:16.510Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nAs MC Server Manager grows — with social features, voice chat, mod sync, and shared servers all queued for implementation — the codebase has accumulated several structural issues that will compound if left unaddressed. These include: a 5-line Zod validation block copy-pasted 25 times across route files, 76 service-layer functions throwing raw `Error` (making all service failures appear as HTTP 500 to the frontend), a duplicate fetch wrapper in the frontend API client, overlapping type definitions in the shared package, and missing input validation on several routes.\n\nNone of these are bugs that affect current users. They are maintenance debt that slows down every future spec. Fixing them now — before the next wave of features adds more routes, services, and shared types — reduces the cost of every subsequent implementation.\n\nThis spec is a focused cleanup pass. It adds no user-visible features and changes no external behavior. All fixes are internal refactors that preserve the existing API surface.\n\n## Alignment with Project Direction\n\nThis cleanup directly supports the product direction outlined in `product.md`. Four feature specs (friends-chat, shared-servers, voice-communication, mod-sync) are queued for implementation. Each will add new routes, services, shared types, and WebSocket messages. The patterns being cleaned up here (validation boilerplate, error handling inconsistency, type duplication) will be replicated in every new spec unless fixed at the source.\n\nSpecifically:\n- The validation utility (REQ-1) will be used by every new route file (friends, chat channels, voice rooms, shared server permissions)\n- The error class migration (REQ-2) will ensure new services follow the established pattern from day one\n- The shared type cleanup (REQ-4) prevents the type divergence from getting worse as launcher and server types continue to evolve\n- The frontend API client consolidation (REQ-3) establishes the pattern for all new API modules\n\n### Dependencies\n\n- **Depends on**: None. This is a standalone refactor with no feature dependencies.\n- **Depended on by**: All queued specs benefit from the cleaner patterns, but none strictly require this to proceed.\n\n---\n\n## Requirements\n\n### REQ-1: Extract Validation Utility\n\n**User Story:** As a developer implementing new route handlers, I want a single validation utility function so that I don't copy-paste the same 5-line Zod validation block into every route.\n\n#### Acceptance Criteria\n\n1. WHEN a route handler needs to validate `req.body`, `req.params`, or `req.query` against a Zod schema, THEN a single utility function SHALL accept the schema and input, return the parsed data on success, and throw a `ValidationError` with a formatted message on failure.\n2. WHEN the utility is introduced, THEN all 25 existing copy-pasted validation blocks across route files (`servers.ts`, `auth.ts`, `users.ts`, `mods.ts`, `modpacks.ts`, `launcher.ts`, `instance-mods.ts`, `invitations.ts`, `downloads.ts`) SHALL be replaced with calls to the utility.\n3. WHEN a Zod parse fails, THEN the thrown error SHALL produce the same HTTP 400 response body format as the current inline implementation (error message with `path: message` joined by `; `).\n4. WHEN the replacement is complete, THEN no file in `packages/backend/src/routes/` SHALL contain the pattern `parsed.error.issues.map`.\n\n### REQ-2: Migrate Service-Layer Errors to Custom Error Classes\n\n**User Story:** As a frontend developer, I want backend service errors to carry appropriate HTTP status codes so that the UI can display meaningful error messages instead of generic \"Internal Server Error.\"\n\n#### Acceptance Criteria\n\n1. WHEN a service function encounters a known error condition (e.g., resource not found, invalid input, external API failure), THEN it SHALL throw an appropriate `AppError` subclass (`NotFoundError`, `ValidationError`, `ConflictError`, or `AppError` with a specific status code) instead of a raw `Error`.\n2. WHEN a provider function fails due to an external API error (HTTP non-2xx from Mojang, Paper, Fabric, Forge, NeoForge, Modrinth, CurseForge), THEN it SHALL throw an `AppError` with status code 502 (Bad Gateway) and a descriptive message.\n3. WHEN a provider function receives an unexpected response format, THEN it SHALL throw an `AppError` with status code 502.\n4. WHEN a service throws for a cancellation reason (e.g., `signal.aborted`), THEN it SHALL remain a raw `Error` (these are caught and handled internally, not propagated to HTTP responses).\n5. WHEN all migrations are complete, THEN the only remaining `throw new Error(...)` calls in `packages/backend/src/` SHALL be: (a) cancellation throws in `download.ts` and `prepare-service.ts`, (b) the database-not-initialized guard in `database.ts`, and (c) the provider registry guards in `registry.ts`.\n6. WHEN the migration is complete, THEN existing route-level error handling SHALL continue to work unchanged — the Express error middleware already handles `AppError` subclasses.\n\n### REQ-3: Consolidate Frontend API Client\n\n**User Story:** As a frontend developer, I want a single fetch wrapper so that auth token handling and error formatting aren't duplicated across two nearly identical functions.\n\n#### Acceptance Criteria\n\n1. WHEN the consolidation is complete, THEN `packages/frontend/src/api/client.ts` SHALL export a single `request<T>()` function that handles auth headers, token refresh on 401, and error formatting.\n2. WHEN the `request()` function receives a 401 response AND is not already refreshing AND the request path is not `/api/auth/refresh`, THEN it SHALL attempt a token refresh and retry the original request.\n3. WHEN token refresh fails, THEN the function SHALL clear stored tokens, redirect to `/login`, and throw an `ApiError`.\n4. WHEN the consolidation is complete, THEN the separate `authFetch()` function SHALL be removed and all 15 import sites across `users.ts`, `invitations.ts`, and `auth.ts` SHALL be updated to use `request()` (or `api.*` methods).\n5. WHEN the old `request()` function (which lacked refresh logic) is removed, THEN all `api.*` methods SHALL automatically gain token refresh capability.\n\n### REQ-4: Clean Up Shared Type Duplication\n\n**User Story:** As a developer working across packages, I want each concept to have exactly one type definition so that I don't encounter confusing near-duplicates.\n\n#### Acceptance Criteria\n\n1. WHEN the cleanup is complete, THEN the shared package SHALL have exactly one version manifest type family: `MojangVersionManifest` and `MojangVersionEntry` SHALL be the canonical types, and `VersionManifest`/`MinecraftVersion` SHALL be removed or defined as derived types (e.g., `type MinecraftVersion = Omit<MojangVersionEntry, 'complianceLevel'>`).\n2. WHEN `VersionManifest`/`MinecraftVersion` are refactored, THEN all import sites in `packages/backend/src/services/version-service.ts` and `packages/frontend/` SHALL be updated to use the canonical types.\n3. WHEN the cleanup is complete, THEN `LoaderType` SHALL be defined in terms of `ModLoader` (e.g., `type LoaderType = ModLoader | \"quilt\"`) with a JSDoc comment explaining the distinction (server-side vs launcher-side, quilt is launcher-only).\n4. WHEN the cleanup is complete, THEN `VersionType` SHALL remain as-is (it is a distinct concept from `McVersion.type` which only has `release | snapshot`).\n\n### REQ-5: Add Missing Route Param/Query Validation\n\n**User Story:** As a backend developer, I want all route inputs to be validated so that invalid params don't bypass type checking via `as` casts.\n\n#### Acceptance Criteria\n\n1. WHEN a route handler reads `req.params` or `req.query`, THEN it SHALL validate the values using Zod before use. No `as ServerType`, `as string | undefined`, or similar casts SHALL remain in route files.\n2. WHEN `PATCH /api/system/settings` receives a request body, THEN it SHALL validate the body against a Zod schema before passing to `updateSettings()`.\n3. WHEN `GET /api/versions/:type` receives an invalid server type param, THEN it SHALL return HTTP 400 with a validation error message (not HTTP 500 from a downstream service).\n4. WHEN the validation is added, THEN it SHALL use the same utility function from REQ-1.\n\n### REQ-6: Fix `as unknown as` Type Casts\n\n**User Story:** As a developer, I want proper type narrowing instead of double-casts so that TypeScript's type system actually protects against runtime errors.\n\n#### Acceptance Criteria\n\n1. WHEN `services/settings.ts` returns `AppSettings`, THEN it SHALL build the result with proper typing (not `as unknown as AppSettings`). The function SHALL construct the object in a type-safe way that doesn't require double-casting.\n2. WHEN `ws/handlers.ts` processes an incoming WebSocket message, THEN it SHALL validate the message shape (e.g., confirm `serverId` is a string) before passing to handler functions. No `as unknown as WsClientMessage` casts SHALL remain.\n3. WHEN the casts are removed, THEN the build SHALL succeed with zero TypeScript errors.\n\n### REQ-7: Fix Electron BACKEND_PORT Propagation\n\n**User Story:** As a user running the Electron app with a custom PORT env var, I want the game launcher to communicate with the correct backend port so that game launching works regardless of port configuration.\n\n#### Acceptance Criteria\n\n1. WHEN the Electron main process starts the backend on a port, THEN it SHALL set `process.env.BACKEND_PORT` to the actual port used before any other modules read it.\n2. WHEN `launcher.ts` reads `process.env.BACKEND_PORT`, THEN it SHALL find the correct value that matches the running backend.\n3. IF `process.env.PORT` is not set, THEN the default port (3001) SHALL be used and `BACKEND_PORT` SHALL be set to `\"3001\"`.\n\n---\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility**: Each new file handles one domain (one model, one service, one route file, one component concern)\n- **Modular Design**: Components, services, and models are isolated and reusable across the app\n- **Transport Separation**: Business logic lives in services, not in route handlers or WebSocket handlers\n- **Clear Interfaces**: New modules export typed functions; Electron features flow through the contextBridge preload script\n\n### Performance\n- No performance-critical paths. All changes are refactors that preserve existing behavior. The validation utility adds one function call overhead per route handler, which is negligible.\n\n### Security\n- Feature inherits existing auth middleware. No additional security requirements.\n- The WebSocket validation improvement (REQ-6) marginally improves security by validating message shapes before processing.\n\n### Reliability\n- All existing API behavior SHALL be preserved. No HTTP response formats, status codes, or WebSocket message shapes change (except where service errors now correctly return 4xx instead of 500).\n- The existing test suite SHALL continue to pass after all changes.\n- The build (`npm run build`) SHALL succeed with zero errors.\n\n### Usability\n- No user-facing changes. All improvements are internal code quality.\n\n## Migration / Backward Compatibility\n\nThis spec changes only internal implementation. The external API contract is preserved with one intentional improvement: service-layer errors that previously returned HTTP 500 will now return appropriate 4xx/5xx codes. This is a strict improvement — no client code depends on receiving 500 for known error conditions.\n\nThe `VersionManifest`/`MinecraftVersion` type rename (REQ-4) is a compile-time change only. The runtime JSON shape from the Mojang API is unchanged.\n",
  "fileStats": {
    "size": 11651,
    "lines": 138,
    "lastModified": "2026-02-15T22:05:11.780Z"
  },
  "comments": []
}