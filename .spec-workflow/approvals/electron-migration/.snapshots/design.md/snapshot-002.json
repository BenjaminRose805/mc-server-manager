{
  "id": "snapshot_1771004604781_0gfdhicq2",
  "approvalId": "approval_1771004400779_wc33rqv88",
  "approvalTitle": "Design: Electron Migration (Remove Rust/Tauri)",
  "version": 2,
  "timestamp": "2026-02-13T17:43:24.781Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document -- Electron Migration (Remove Rust/Tauri)\n\n## Overview\n\nReplace all Rust/Tauri functionality (~1,320 lines across 7 `.rs` files) with TypeScript in the existing Electron package and backend. The Tauri layer provides three native capabilities not yet in Electron: Microsoft OAuth authentication with OS keychain storage, Java detection/download, and Minecraft client launching. After migration, `packages/desktop/` is deleted and Electron becomes the sole desktop implementation.\n\nThe migration follows a \"strangle fig\" pattern: build the replacements alongside the existing code, rewire the frontend, verify parity, then remove the old code.\n\n## Steering Document Alignment\n\nNo steering docs exist. This design follows the conventions established in AGENTS.md and the existing codebase.\n\n### Technical Standards\n- TypeScript strict mode, ES modules with `.js` extensions in backend imports\n- Express services as singletons, Electron modules as separate files\n- Zod for validation, Pino for logging, `better-sqlite3` for persistence\n- `contextBridge` + `contextIsolation` for secure Electron IPC\n\n### Project Structure\n- Electron code in `packages/electron/src/` (existing pattern)\n- Backend services in `packages/backend/src/services/` (existing pattern)\n- Frontend utilities in `packages/frontend/src/utils/` (existing pattern)\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`packages/electron/src/main.ts`**: Already handles window creation, backend lifecycle, tray setup, graceful shutdown. New IPC handlers register into this existing setup.\n- **`packages/electron/src/preload.ts`**: Currently exposes `{ platform }`. Will be extended with auth, launcher, and Java APIs.\n- **`packages/electron/src/tray.ts`**: System tray implementation — no changes needed.\n- **`packages/backend/src/services/java.ts`**: Existing Java detection (`detectJava`, `probeJava`, `parseJavaVersion`, `getJavaMajorVersion`). Will be extended with multi-installation scanning and Adoptium download.\n- **`packages/frontend/src/utils/tauri.ts`**: Contains `isTauri()`, `tauriInvoke()`, `getBackendBaseUrl()`. Will be replaced with `isElectron()` and `window.electronAPI.*` calls.\n- **`packages/frontend/src/api/client.ts`**: Uses `getBackendBaseUrlSync()` for URL resolution — will switch to Electron-aware detection.\n\n### Integration Points\n\n- **Electron IPC** replaces Tauri `invoke()` — same request/response pattern, different transport\n- **Backend REST API** unchanged — launcher routes (`/api/launcher/*`) stay as-is\n- **Shared types** unchanged — `MSAuthDeviceCode`, `MSAuthStatus`, `LauncherAccount`, `JavaInstallation`, `GameProcess` already defined\n- **SQLite database** — no schema changes needed\n\n## Architecture\n\n### Current Architecture (Dual Desktop)\n\n```\n┌─────────────────────────────┐    ┌─────────────────────────────┐\n│ Tauri App (Rust)            │    │ Electron App (TypeScript)    │\n│  - MS Auth (keyring crate)  │    │  - Window management         │\n│  - Java detect/download     │    │  - System tray               │\n│  - Game launching           │    │  - Backend lifecycle          │\n│  - System tray              │    │  - Preload (platform only)   │\n│  - Window management        │    │                              │\n│  - Backend sidecar          │    │                              │\n└──────────┬──────────────────┘    └──────────┬──────────────────┘\n           │ Tauri invoke()                   │ loadURL()\n           ▼                                  ▼\n┌─────────────────────────────────────────────────────────────┐\n│ Frontend (React) — uses isTauri() + tauriInvoke()           │\n└──────────────────────────┬──────────────────────────────────┘\n                           │ HTTP/WS\n                           ▼\n┌─────────────────────────────────────────────────────────────┐\n│ Backend (Express + WebSocket)                                │\n└─────────────────────────────────────────────────────────────┘\n```\n\n### Target Architecture (Electron Only)\n\n```\n┌─────────────────────────────────────────────┐\n│ Electron App (TypeScript)                    │\n│  ┌────────────────────────────────────────┐  │\n│  │ Main Process                           │  │\n│  │  - Window management (existing)        │  │\n│  │  - System tray (existing)              │  │\n│  │  - Backend lifecycle (existing)        │  │\n│  │  - MS Auth + safeStorage (NEW)         │  │\n│  │  - Game launcher (NEW)                 │  │\n│  └──────────┬─────────────────────────────┘  │\n│             │ contextBridge IPC              │\n│  ┌──────────▼─────────────────────────────┐  │\n│  │ Renderer (React SPA)                   │  │\n│  │  - Uses window.electronAPI.*           │  │\n│  │  - isElectron() detection              │  │\n│  └──────────┬─────────────────────────────┘  │\n└─────────────┼────────────────────────────────┘\n              │ HTTP/WS (same as before)\n              ▼\n┌─────────────────────────────────────────────┐\n│ Backend (Express + WebSocket)                │\n│  - Java detection + download (EXTENDED)      │\n│  - All existing services unchanged           │\n└─────────────────────────────────────────────┘\n```\n\n### Design Principles\n\n- **Single File Responsibility**: Each new file handles one domain — `auth.ts` for OAuth, `launcher.ts` for game launching, `secure-storage.ts` for credential encryption.\n- **Component Isolation**: Electron main-process modules don't import from each other (except `secure-storage` which is a utility). They register IPC handlers independently.\n- **Service Layer Separation**: Java detection/download lives in the backend (where it logically belongs as a service). Auth and game launching live in Electron main process (where they need OS-level access).\n- **Minimal Preload Surface**: The preload script exposes only the specific methods needed — no generic `invoke()` passthrough.\n\n## Components and Interfaces\n\n### Component 1: Secure Storage (`packages/electron/src/secure-storage.ts`)\n\n- **Purpose**: Encrypt/decrypt arbitrary strings using Electron's `safeStorage` API. Replaces Rust `keyring` crate.\n- **Interfaces**:\n  ```typescript\n  export function saveSecret(key: string, value: string): void\n  export function getSecret(key: string): string | null\n  export function deleteSecret(key: string): void\n  export function isEncryptionAvailable(): boolean\n  ```\n- **Dependencies**: `electron` (`safeStorage`, `app`), `node:fs`, `node:path`\n- **Storage mechanism**: Encrypted buffers stored as base64 strings in a JSON file at `{userData}/secure-storage.json`. The `safeStorage.encryptString()` API uses OS-level encryption (Keychain on macOS, DPAPI on Windows, libsecret on Linux).\n- **Reuses**: Electron's built-in `safeStorage` API — no additional dependencies.\n\n### Component 2: Microsoft Auth (`packages/electron/src/auth.ts`)\n\n- **Purpose**: Full Microsoft OAuth device code flow → Xbox Live → XSTS → Minecraft Services. Direct TypeScript port of `auth.rs` (360 lines of Rust).\n- **Interfaces**:\n  ```typescript\n  export async function msAuthStart(): Promise<MSAuthDeviceCode>\n  export async function msAuthPoll(): Promise<MSAuthStatus>\n  export async function msAuthRefresh(accountUuid: string): Promise<LauncherAccount>\n  export async function getMcAccessToken(accountUuid: string): Promise<string>\n  export async function removeAccount(accountUuid: string): Promise<void>\n  ```\n- **Dependencies**: `secure-storage.ts` (for token persistence), `node:fetch` (HTTP calls)\n- **State**: Module-level `pendingAuth: DeviceCodeResponse | null` (same as Rust's `AuthState`)\n- **Constants**: `MS_CLIENT_ID = \"c36a9fb6-4f2a-41ff-90bd-ae7cc92031eb\"` (same as Rust), `MS_TENANT = \"consumers\"`, `MS_SCOPE = \"XboxLive.signin offline_access\"`\n- **Reuses**: Shared types `MSAuthDeviceCode`, `MSAuthStatus`, `LauncherAccount` from `@mc-server-manager/shared`\n\n### Component 3: Game Launcher (`packages/electron/src/launcher.ts`)\n\n- **Purpose**: Spawn Minecraft as a Java child process with correct classpath and arguments. Direct TypeScript port of `launcher.rs` (279 lines of Rust).\n- **Interfaces**:\n  ```typescript\n  export async function launchGame(instanceId: string, accountId: string): Promise<GameProcess>\n  export function getRunningGames(): GameProcess[]\n  export async function killGame(instanceId: string): Promise<void>\n  ```\n- **Dependencies**: `auth.ts` (for `getMcAccessToken`), `node:child_process` (`spawn`), `node:fetch` (backend API calls)\n- **State**: Module-level `runningGames: GameProcess[]`\n- **Process**: Fetches instance from backend → gets MC token → calls backend `/api/launcher/prepare/:id` → resolves Java → builds JVM args (`-Xms`, `-Xmx`, `-Djava.library.path`, `-cp`) → builds game args (`--username`, `--uuid`, `--accessToken`, `--gameDir`, `--assetsDir`, `--assetIndex`, `--version`) → `spawn(java, args)` → tracks PID → monitors exit\n- **Reuses**: Shared type `GameProcess` from `@mc-server-manager/shared`. Backend's existing `/api/launcher/prepare/:id` endpoint for file download orchestration.\n\n### Component 4: IPC Registration (`packages/electron/src/ipc.ts`)\n\n- **Purpose**: Register all Electron IPC handlers in one place, keeping `main.ts` clean.\n- **Interfaces**:\n  ```typescript\n  export function registerIpcHandlers(): void\n  ```\n- **IPC Channels** (all via `ipcMain.handle` for async request/response):\n  | Channel | Maps to | Return type |\n  |---------|---------|-------------|\n  | `ms-auth-start` | `auth.msAuthStart()` | `MSAuthDeviceCode` |\n  | `ms-auth-poll` | `auth.msAuthPoll()` | `MSAuthStatus` |\n  | `ms-auth-refresh` | `auth.msAuthRefresh(uuid)` | `LauncherAccount` |\n  | `get-mc-access-token` | `auth.getMcAccessToken(uuid)` | `string` |\n  | `remove-account` | `auth.removeAccount(uuid)` | `void` |\n  | `get-java-installations` | backend `GET /api/launcher/java` | `JavaInstallation[]` |\n  | `download-java` | backend `POST /api/launcher/java/download` | `JavaInstallation` |\n  | `launch-game` | `launcher.launchGame(iId, aId)` | `GameProcess` |\n  | `get-running-games` | `launcher.getRunningGames()` | `GameProcess[]` |\n  | `kill-game` | `launcher.killGame(iId)` | `void` |\n- **Dependencies**: `auth.ts`, `launcher.ts`, `electron` (`ipcMain`)\n- **Reuses**: Existing IPC registration pattern from Electron's `contextBridge`\n\n### Component 5: Extended Preload (`packages/electron/src/preload.ts`)\n\n- **Purpose**: Expose typed `electronAPI` to the renderer process via `contextBridge`.\n- **Current state**: Only exposes `{ platform: process.platform }`.\n- **Extended API**:\n  ```typescript\n  contextBridge.exposeInMainWorld('electronAPI', {\n    platform: process.platform,\n    // Auth\n    msAuthStart: () => ipcRenderer.invoke('ms-auth-start'),\n    msAuthPoll: () => ipcRenderer.invoke('ms-auth-poll'),\n    msAuthRefresh: (uuid: string) => ipcRenderer.invoke('ms-auth-refresh', uuid),\n    getMcAccessToken: (uuid: string) => ipcRenderer.invoke('get-mc-access-token', uuid),\n    removeAccount: (uuid: string) => ipcRenderer.invoke('remove-account', uuid),\n    // Java\n    getJavaInstallations: () => ipcRenderer.invoke('get-java-installations'),\n    downloadJava: (version: number) => ipcRenderer.invoke('download-java', version),\n    // Launcher\n    launchGame: (instanceId: string, accountId: string) => ipcRenderer.invoke('launch-game', instanceId, accountId),\n    getRunningGames: () => ipcRenderer.invoke('get-running-games'),\n    killGame: (instanceId: string) => ipcRenderer.invoke('kill-game', instanceId),\n  })\n  ```\n- **Type definition**: A `global.d.ts` in the frontend will declare `window.electronAPI` with proper types.\n\n### Component 6: Extended Java Service (`packages/backend/src/services/java.ts`)\n\n- **Purpose**: Extend existing Java detection to match Rust's capabilities: multi-installation scanning (not just first-found) and Adoptium download with archive extraction.\n- **New interfaces** (added to existing file):\n  ```typescript\n  export async function detectAllJavaInstallations(): Promise<JavaInstallation[]>\n  export async function downloadJava(version: number, dataDir: string): Promise<JavaInstallation>\n  ```\n- **Dependencies**: `node:child_process`, `node:crypto` (SHA verification), `node:fs`, `node:path`, `tar` (existing dep for tar.gz extraction on Linux/macOS), `adm-zip` (existing dep for zip on Windows)\n- **Reuses**: Existing `probeJava()`, `parseJavaVersion()`, `getJavaMajorVersion()`, `findJavaOnPath()`, `getCommonJavaLocations()` functions. Extends them with directory-scanning logic matching `java.rs`.\n\n### Component 7: Frontend Environment Detection (`packages/frontend/src/utils/desktop.ts`)\n\n- **Purpose**: Replace `tauri.ts` with Electron-aware environment detection.\n- **Interfaces**:\n  ```typescript\n  export function isDesktop(): boolean  // true when running in Electron\n  export function getBackendBaseUrl(): string\n  export function getBackendBaseUrlSync(): string\n  ```\n- **Detection**: `'electronAPI' in window` instead of `'__TAURI_INTERNALS__' in window`\n- **Reuses**: Same pattern as current `tauri.ts`, just different detection key\n\n### Component 8: Frontend Component Updates\n\n- **`AccountManager.tsx`**: Replace `tauriInvoke('ms_auth_start')` → `window.electronAPI.msAuthStart()`, etc.\n- **`LaunchButton.tsx`**: Replace `tauriInvoke('launch_game', {...})` → `window.electronAPI.launchGame(instanceId, accountId)`\n- **`api/client.ts`**: Replace `getBackendBaseUrlSync()` import from `tauri.ts` → from `desktop.ts`\n- **`api/ws.ts`**: Replace `isTauri()` → `isDesktop()` for WebSocket URL resolution\n- **`api/auth.ts`**: Replace `getBackendBaseUrlSync()` import\n- **`main.tsx`**: Replace `isTauri()` → `isDesktop()` for backend readiness check\n- **Delete**: `packages/frontend/src/utils/tauri.ts`, `packages/frontend/src/utils/wait-for-backend.ts` (merge into `desktop.ts`)\n\n## Data Models\n\nNo new data models. All existing shared types are reused as-is:\n\n- `MSAuthDeviceCode` — device code + verification URI (from `shared/src/index.ts`)\n- `MSAuthStatus` — auth polling result (pending/complete/error)\n- `LauncherAccount` — authenticated Minecraft account\n- `JavaInstallation` — detected Java with version/path/vendor\n- `GameProcess` — running game with instance ID, PID, start time\n- `PrepareResponse` — classpath + mainClass + assets metadata from backend\n\n### Secure Storage Schema\n\nA new file `{userData}/secure-storage.json`:\n```json\n{\n  \"mc_access_token_{uuid}\": \"<base64-encoded encrypted buffer>\",\n  \"ms_refresh_token_{uuid}\": \"<base64-encoded encrypted buffer>\"\n}\n```\n\nThis mirrors the Rust keyring key naming convention exactly (`mc_access_token_{uuid}`, `ms_refresh_token_{uuid}`), just stored in an encrypted JSON file instead of the OS keyring.\n\n## Error Handling\n\n### Error Scenarios\n\n1. **safeStorage unavailable (Linux without secret store)**\n   - **Handling**: `isEncryptionAvailable()` check before any credential operation. If false, log a warning and refuse to store credentials.\n   - **User Impact**: \"Secure storage is not available on this system. Authentication requires a desktop environment with a secret store (GNOME Keyring, KWallet).\"\n\n2. **Microsoft auth token expired during poll**\n   - **Handling**: Return `{ status: 'expired', error: 'Device code expired' }` — same as Rust implementation.\n   - **User Impact**: Device code card shows \"Code expired. Please try again.\" with Retry button.\n\n3. **Java download fails mid-stream**\n   - **Handling**: Delete partial file, return error. Caller can retry.\n   - **User Impact**: Toast notification with error message and option to retry.\n\n4. **Game process crashes immediately**\n   - **Handling**: `child.on('exit', ...)` fires, removes from `runningGames`, logs exit code.\n   - **User Impact**: LaunchButton returns to \"Play\" state. Toast shows crash message.\n\n5. **Backend unreachable during game launch**\n   - **Handling**: `fetch` to backend fails, error propagated through IPC to renderer.\n   - **User Impact**: Toast shows \"Failed to prepare launch: Backend unavailable\".\n\n6. **IPC called in browser mode**\n   - **Handling**: `isDesktop()` returns false, component shows \"Requires desktop app\" message.\n   - **User Impact**: Same as current Tauri behavior — features gracefully disabled.\n\n## Testing Strategy\n\n### Manual Testing Checklist\n\nSince the project has no automated test framework (per AGENTS.md), verification is manual:\n\n1. **Auth flow**: Add Account → device code appears → complete MS login → account shows in list\n2. **Token persistence**: Restart Electron app → previously added accounts still listed → can launch without re-auth\n3. **Token refresh**: Wait for token expiry → launch game → auto-refresh succeeds transparently\n4. **Account removal**: Delete account → credentials removed from secure storage file\n5. **Java detection**: Java installations list matches `java -version` from terminal\n6. **Java download**: Download Java 21 → appears in installations list → can be used for launch\n7. **Game launch**: Select instance + account → Play → Minecraft starts with correct version/credentials\n8. **Kill game**: Running game → Kill → process terminates → Play button re-enabled\n9. **Browser mode**: Open `http://localhost:5173` in browser → auth/launch features show \"Requires desktop app\"\n10. **System tray**: Close window → tray icon visible → Show Window restores → Quit shuts down cleanly\n\n### Parity Verification\n\nFor each Rust function, verify the TypeScript replacement produces identical behavior:\n\n| Rust Function | TypeScript Replacement | Verify |\n|--------------|----------------------|--------|\n| `ms_auth_start()` | `auth.msAuthStart()` | Same device code response shape |\n| `ms_auth_poll()` | `auth.msAuthPoll()` | Same status/account/error fields |\n| `ms_auth_refresh()` | `auth.msAuthRefresh()` | Token refreshes transparently |\n| `get_mc_access_token()` | `auth.getMcAccessToken()` | Returns valid token string |\n| `remove_account()` | `auth.removeAccount()` | Credentials fully deleted |\n| `get_java_installations()` | `detectAllJavaInstallations()` | Same installations found |\n| `download_java()` | `downloadJava()` | Same Adoptium URL, same extraction |\n| `launch_game()` | `launcher.launchGame()` | Identical JVM args, game args, classpath |\n| `get_running_games()` | `launcher.getRunningGames()` | Same GameProcess shape |\n| `kill_game()` | `launcher.killGame()` | Process terminated, state cleaned |\n\n## Migration Order\n\nThe implementation order minimizes risk by building foundations first:\n\n1. **Secure storage** — Foundation for auth (no dependencies)\n2. **Auth module** — Depends on secure storage only\n3. **Java service extension** — Backend-only, no frontend changes\n4. **Game launcher** — Depends on auth module\n5. **IPC registration + preload** — Wires everything together\n6. **Frontend migration** — Switch from Tauri to Electron APIs\n7. **Cleanup** — Delete Tauri package, update configs\n\nEach step can be tested independently before proceeding to the next.\n",
  "fileStats": {
    "size": 20647,
    "lines": 329,
    "lastModified": "2026-02-13T17:39:53.493Z"
  },
  "comments": []
}