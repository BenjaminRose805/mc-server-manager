{
  "id": "snapshot_1770854388392_5ssnvkrnu",
  "approvalId": "approval_1770854344224_3j5emo86c",
  "approvalTitle": "EPIC-4 Client Mod Management - Tasks",
  "version": 2,
  "timestamp": "2026-02-11T23:59:48.392Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document -- Client Mod Management\n\n- [ ] 1. Add ModTarget type and extend InstalledMod with instanceId\n  - Files: `shared/src/index.ts` (modify)\n  - Add `ModTarget` interface: `{ type: 'server'|'instance', id: string, modsDir: string, mcVersion: string, loader: ModLoader|null, loaderVersion: string|null }`\n  - Extend `InstalledMod`: change `serverId` from `string` to `string | null`, add `instanceId: string | null`\n  - Add `InstallClientLoaderRequest` type\n  - Purpose: Foundation types for the ModTarget abstraction\n  - _Leverage: `shared/src/index.ts` for existing type patterns, `plans/EPIC-4-client-mods.md` Shared Types section_\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec client-mod-management, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: TypeScript Developer with expertise in shared type definitions | Task: Read `shared/src/index.ts` and add/modify types. (1) Add `ModTarget` interface with fields: `type: 'server' | 'instance'`, `id: string`, `modsDir: string`, `mcVersion: string`, `loader: ModLoader | null`, `loaderVersion: string | null`. (2) Modify the existing `InstalledMod` interface: change `serverId: string` to `serverId: string | null`, add `instanceId: string | null`. (3) Add `InstallClientLoaderRequest` interface: `{ loader: ModLoader, loaderVersion?: string }`. Reference `plans/EPIC-4-client-mods.md` Shared Types section and `.spec-workflow/specs/client-mod-management/design.md`. | Restrictions: Do NOT remove or rename any existing types. The `serverId` change from `string` to `string | null` may require downstream fixes -- note this but don't fix other files in this task. Do NOT add resource pack or shader pack types (those are stretch goals). | Success: All new types compile, existing types still compile, `ModTarget` is exported. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 2. Create database migration for instance_id column\n  - Files: `packages/backend/migrations/008_client_mods.sql` (new)\n  - Recreate `installed_mods` table with `instance_id` column (nullable, FK to `launcher_instances`)\n  - Add CHECK constraint: exactly one of `server_id` or `instance_id` must be non-null\n  - Migrate existing data, recreate indexes\n  - Purpose: Database support for tracking mods on both servers and instances\n  - _Leverage: `packages/backend/migrations/003_mods.sql` for existing table schema, `plans/EPIC-4-client-mods.md` Database Changes section_\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec client-mod-management, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Database Engineer with expertise in SQLite migrations and schema evolution | Task: Check existing migrations in `packages/backend/migrations/` to determine the next migration number. Create the migration SQL file. The migration must: (1) Create `installed_mods_new` table with all existing columns PLUS `instance_id TEXT REFERENCES launcher_instances(id) ON DELETE CASCADE`, (2) Add CHECK constraint `((server_id IS NOT NULL AND instance_id IS NULL) OR (server_id IS NULL AND instance_id IS NOT NULL))`, (3) Add UNIQUE constraints on both `(server_id, file_name)` and `(instance_id, file_name)`, (4) Copy all existing data from `installed_mods` (set `instance_id` to NULL for all existing rows), (5) DROP old table, ALTER TABLE RENAME new to `installed_mods`, (6) Recreate indexes: `idx_installed_mods_server`, `idx_installed_mods_instance`, `idx_installed_mods_hash`. Read existing `installed_mods` schema from migrations 003, 004, 005 to ensure all columns are preserved. Reference `plans/EPIC-4-client-mods.md` Database Changes. | Restrictions: Do NOT modify existing migration files. Must preserve ALL existing data. Use a transaction-safe approach. The INSERT INTO must copy all columns correctly including the ones added by migrations 004 and 005. | Success: Migration SQL is valid, preserves all existing data, CHECK constraint enforces mutual exclusivity, indexes are recreated. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 3. Refactor mod model for ModTarget support\n  - Files: Backend mod model file (modify)\n  - Add `getByInstanceId(instanceId)` method\n  - Add `deleteByInstanceId(instanceId)` method\n  - Update `create()` to accept `instanceId` field\n  - Update queries to handle nullable `server_id` / `instance_id`\n  - Purpose: Database layer supports both server and instance mods\n  - _Leverage: Existing mod model file (find via `packages/backend/src/models/`), `plans/EPIC-4-client-mods.md` Phase 4A.2_\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec client-mod-management, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer with expertise in SQLite models | Task: Find and read the existing mod model file in `packages/backend/src/`. It may be in `models/` or part of a service. Add instance-aware methods: (1) `getByInstanceId(instanceId: string): InstalledMod[]` -- query by `instance_id`, (2) `deleteByInstanceId(instanceId: string): void`, (3) Update the `create()` method to accept and insert `instanceId` (nullable), (4) Ensure `getByServerId` still works (backward compatible). The `create()` INSERT must set `server_id` OR `instance_id` based on input, with the other as NULL. Reference `plans/EPIC-4-client-mods.md` Phase 4A.2 and `.spec-workflow/specs/client-mod-management/design.md`. | Restrictions: Do NOT break existing server mod queries. Do NOT change method signatures for existing methods (add new methods instead). Follow the existing prepared statement pattern. | Success: New methods compile, existing `getByServerId` unchanged, `create()` handles both server_id and instance_id, queries match the new table schema. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 4. Refactor ModService to use ModTarget\n  - Files: `packages/backend/src/services/mod-manager.ts` (modify)\n  - Add `serverToModTarget()` and `instanceToModTarget()` helper functions\n  - Refactor all public methods from `serverId: string` to `target: ModTarget`\n  - Replace hardcoded path construction (`path.join(server.path, 'mods')`) with `target.modsDir`\n  - Replace `server.version` / `server.loader` with `target.mcVersion` / `target.loader`\n  - Update internal model calls to use `target.type` to choose server vs instance queries\n  - Purpose: Core mod business logic works with both servers and instances\n  - _Leverage: `packages/backend/src/services/mod-manager.ts` (existing), `plans/EPIC-4-client-mods.md` Phase 4A.1_\n  - _Requirements: REQ-1_\n  - _Prompt: Implement the task for spec client-mod-management, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer with expertise in service refactoring and abstraction patterns | Task: Read `packages/backend/src/services/mod-manager.ts` thoroughly. Refactor it to use `ModTarget` from `@mc-server-manager/shared`. (1) Add helper functions `serverToModTarget(server)` and `instanceToModTarget(instance)` that construct ModTarget from a server or instance record. (2) For each public method that takes `serverId`, change the parameter to `target: ModTarget`. Key methods to refactor: listing mods, installing mods, removing mods, toggling mods, checking updates, applying updates, syncing mods directory. (3) Replace all `path.join(server.path, 'mods')` with `target.modsDir`. (4) Replace `server.version` with `target.mcVersion`, `server.loader` with `target.loader`. (5) For model queries, use `target.type === 'server' ? model.getByServerId(target.id) : model.getByInstanceId(target.id)`. Reference `plans/EPIC-4-client-mods.md` Phase 4A.1 for the refactor pattern. | Restrictions: Do NOT change business logic (dependency resolution, hash verification, etc.) -- only change how the target is referenced. Do NOT break the dependency resolution algorithm. Do NOT remove any existing functionality. Keep helper functions in the same file. | Success: All methods accept ModTarget, server mods still work when passing serverToModTarget(server), instance mods work when passing instanceToModTarget(instance), no TypeScript errors. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 5. Update existing server mod routes to use ModTarget\n  - Files: `packages/backend/src/routes/mods.ts` (modify)\n  - Update route handlers to construct ModTarget from server record before calling ModService\n  - Add `side` query parameter to Modrinth search route for client-side filtering\n  - Purpose: Existing server mod routes work with refactored ModService\n  - _Leverage: `packages/backend/src/routes/mods.ts` (existing), `plans/EPIC-4-client-mods.md` Phase 4C.2_\n  - _Requirements: REQ-1, REQ-2_\n  - _Prompt: Implement the task for spec client-mod-management, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer with expertise in Express route refactoring | Task: Read `packages/backend/src/routes/mods.ts`. Update each route handler: (1) Fetch the server record by ID. (2) Call `serverToModTarget(server)` to construct a ModTarget. (3) Pass the ModTarget to ModService methods instead of the raw serverId. (4) Also find the Modrinth search route (may be in this file or a separate modrinth routes file) and add support for a `side` query parameter. When `side=client`, add facets `['client_side:required', 'client_side:optional']` to the Modrinth search. When `side=server`, add `['server_side:required', 'server_side:optional']`. When no side param, keep existing behavior. Reference `plans/EPIC-4-client-mods.md` Phase 4C.2 for the Modrinth filtering. | Restrictions: Do NOT change route paths or response shapes. Routes must be backward compatible. Do NOT add instance routes here (that's a separate task). | Success: All server mod routes still work identically, Modrinth search supports `side` filter, no TypeScript errors. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 6. Add client mod loader installation\n  - Files: Backend mod loader service (modify or find equivalent)\n  - Add `installClientLoader(instanceId, loader, loaderVersion?)` for Fabric client profile installation\n  - Fabric client flow: fetch profile JSON from Fabric Meta API, save to instance versions dir, download Maven libraries, update instance record\n  - Add `removeClientLoader(instanceId)` to revert to vanilla\n  - Purpose: Enable Fabric mod loading on client game instances\n  - _Leverage: Existing mod loader service for server-side patterns, `plans/EPIC-4-client-mods.md` Phase 4B_\n  - _Requirements: REQ-3_\n  - _Prompt: Implement the task for spec client-mod-management, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer with expertise in Fabric mod loader and Maven dependency resolution | Task: Find the existing mod loader service or equivalent in `packages/backend/src/services/`. Read it to understand the server-side Fabric installation. Add client-specific methods: (1) `installClientLoader(instanceId, loader, loaderVersion?)` -- For Fabric: fetch profile JSON from `https://meta.fabricmc.net/v2/versions/loader/{mcVersion}/{loaderVersion}/profile/json`, save to `{dataDir}/launcher/instances/{id}/versions/{profileId}/{profileId}.json`, download all libraries from the profile's `libraries[]` array to `{dataDir}/launcher/libraries/` (parse Maven coordinates `group:artifact:version` to file paths), update instance record with `loader='fabric'`, `loaderVersion`, and the profile version ID. (2) `getClientLoaderVersions(loader, mcVersion)` -- same API as server versions. (3) `removeClientLoader(instanceId)` -- delete profile JSON, revert instance loader fields to null. Reference `plans/EPIC-4-client-mods.md` Phases 4B.1-4B.3 for exact implementation. | Restrictions: Only implement Fabric for now. Forge/NeoForge client installation is deferred. Do NOT modify server loader methods. Maven library download: parse coordinates correctly (`net.fabricmc:fabric-loader:0.16.0` becomes `net/fabricmc/fabric-loader/0.16.0/fabric-loader-0.16.0.jar`). | Success: Fabric client profile downloads correctly, libraries are fetched from Maven, instance record updates, launcher can use the Fabric main class and classpath. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 7. Create instance mod CRUD routes\n  - Files: `packages/backend/src/routes/instance-mods.ts` (new), `packages/backend/src/app.ts` (modify)\n  - Routes: GET/POST/DELETE/PATCH `/api/launcher/instances/:id/mods/*`, POST `/api/launcher/instances/:id/mods/sync`, POST `/api/launcher/instances/:id/mods/check-updates`, POST `/api/launcher/instances/:id/mods/apply-updates`\n  - Add loader routes: POST/GET/DELETE `/api/launcher/instances/:id/loader`\n  - Mount in app.ts\n  - Purpose: REST API for instance mod operations\n  - _Leverage: `packages/backend/src/routes/mods.ts` for route handler pattern, `plans/EPIC-4-client-mods.md` Phase 4C.1_\n  - _Requirements: REQ-4_\n  - _Prompt: Implement the task for spec client-mod-management, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer with expertise in Express routing and REST API design | Task: (1) Create `packages/backend/src/routes/instance-mods.ts`. Read `packages/backend/src/routes/mods.ts` for the pattern. Implement routes: `GET /instances/:id/mods` (list), `POST /instances/:id/mods` (install), `DELETE /instances/:id/mods/:modId` (remove), `PATCH /instances/:id/mods/:modId` (toggle), `POST /instances/:id/mods/sync`, `POST /instances/:id/mods/check-updates`, `POST /instances/:id/mods/apply-updates`. Each handler: fetch instance by ID, construct ModTarget via `instanceToModTarget(instance)`, call ModService with target. Also add loader routes: `POST /instances/:id/loader` (install), `GET /instances/:id/loader` (detect), `DELETE /instances/:id/loader` (remove). Use same Zod schemas as server routes. (2) Mount in `packages/backend/src/app.ts` under `/api/launcher`. Reference `plans/EPIC-4-client-mods.md` Phase 4C.1. | Restrictions: Use `.js` extensions in imports. Follow exact same error handling pattern as server routes. Use NotFoundError for missing instances. Reuse existing Zod schemas from server routes. | Success: All routes compile, routes are mounted, instance mod operations work via REST API, loader routes work. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 8. Generalize frontend mod components for target support\n  - Files: `packages/frontend/src/components/ModList.tsx` (modify), `packages/frontend/src/pages/Mods.tsx` (modify), `packages/frontend/src/api/client.ts` (modify)\n  - Generalize `ModList` component to accept `targetType: 'server'|'instance'` and `targetId` props\n  - Generalize `Mods` page search to accept target context, auto-filter by `side=client` for instances\n  - Add instance mod API methods to client.ts\n  - Purpose: Reuse existing mod UI for both servers and instances\n  - _Leverage: `packages/frontend/src/components/ModList.tsx`, `packages/frontend/src/pages/Mods.tsx`, `plans/EPIC-4-client-mods.md` Phases 4C.3-4C.4_\n  - _Requirements: REQ-2, REQ-5_\n  - _Prompt: Implement the task for spec client-mod-management, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: React Frontend Developer with expertise in component generalization and API integration | Task: (1) Read `packages/frontend/src/components/ModList.tsx`. Add optional props `targetType?: 'server' | 'instance'` and `targetId?: string`. Default to `'server'` for backward compat. When `targetType === 'instance'`, use `/api/launcher/instances/{targetId}/mods` instead of `/api/servers/{serverId}/mods` for all API calls. (2) Read `packages/frontend/src/pages/Mods.tsx`. When searching for an instance context, pass `side=client` to the mod search API so server-only mods are filtered out. (3) Add instance mod API methods to `packages/frontend/src/api/client.ts`: `getInstanceMods(instanceId)`, `installInstanceMod(instanceId, data)`, `uninstallInstanceMod(instanceId, modId)`, `toggleInstanceMod(instanceId, modId)`, `installInstanceLoader(instanceId, data)`, `getInstanceLoader(instanceId)`, `removeInstanceLoader(instanceId)`. Follow the exact same pattern as existing server mod methods. Reference `plans/EPIC-4-client-mods.md` Phases 4C.3-4C.4. | Restrictions: Do NOT break existing server mod UI. Default behavior must remain unchanged. Do NOT duplicate entire components -- generalize with props. Keep changes minimal and focused. | Success: ModList works for both servers and instances, Mods search filters by client side for instances, API client has instance mod methods, existing server functionality unchanged. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n\n- [ ] 9. Add Mods tab to instance detail page\n  - Files: Instance detail page (find in `packages/frontend/src/pages/`), potentially new\n  - Add a \"Mods\" tab to the instance/launcher detail page\n  - Wire up generalized ModList and Mods components with `targetType='instance'`\n  - Show loader setup prompt if no mod loader installed\n  - Purpose: Users can manage mods from the instance detail view\n  - _Leverage: `packages/frontend/src/pages/ServerDetail.tsx` for tab pattern, `plans/EPIC-4-client-mods.md` Phase 4C.3_\n  - _Requirements: REQ-5_\n  - _Prompt: Implement the task for spec client-mod-management, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: React Frontend Developer with expertise in tabbed UI patterns | Task: Find the launcher instance detail page (may be in `packages/frontend/src/pages/Launcher.tsx` or a separate file). Read `packages/frontend/src/pages/ServerDetail.tsx` for the tab pattern. Add a \"Mods\" tab to the instance detail view. The tab should: (1) Check if a mod loader is installed (`instance.loader`). If not, show a loader setup prompt with buttons to install Fabric (call `installInstanceLoader` API). (2) If loader is installed, render the generalized `ModList` component with `targetType='instance'` and `targetId={instance.id}`. (3) Include a \"Browse Mods\" button that opens the Mods search page in instance context. Reference `plans/EPIC-4-client-mods.md` Phase 4C.3. | Restrictions: Follow existing tab pattern from ServerDetail. Do NOT create a completely new page if an instance detail view already exists -- add to it. Use Tailwind CSS, lucide-react icons, sonner toasts consistent with existing pages. | Success: Instance detail has Mods tab, loader setup shows when needed, mod list shows installed mods, search works with client-side filtering. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._\n",
  "fileStats": {
    "size": 19488,
    "lines": 94,
    "lastModified": "2026-02-11T23:58:58.123Z"
  },
  "comments": []
}