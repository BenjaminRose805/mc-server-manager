{
  "id": "snapshot_1770853137502_ftbbsv2nd",
  "approvalId": "approval_1770852882464_83sdptnua",
  "approvalTitle": "EPIC-3 Minecraft Client Launcher - Design",
  "version": 2,
  "timestamp": "2026-02-11T23:38:57.502Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document -- Minecraft Client Launcher\n\n## Overview\n\nAdd a full Minecraft client launcher to the desktop application. The launcher spans three layers: Tauri Rust core (authentication, Java management, game process spawning), Express backend (instance CRUD, version/asset/library downloads, SQLite storage), and React frontend (launcher UI). The architecture splits security-sensitive operations (auth tokens) to Rust, heavy file I/O to the backend, and presentation to the frontend.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\nNo steering docs exist. This design follows project conventions:\n- TypeScript strict mode for all backend/frontend code\n- Rust stable (edition 2021) for Tauri core modules\n- ES modules, Zod validation on routes, Pino logging\n- SQLite via better-sqlite3 for instance/account metadata\n\n### Project Structure (structure.md)\nNew code follows the existing monorepo pattern:\n- Backend services: `packages/backend/src/services/`\n- Backend models: `packages/backend/src/models/`\n- Backend routes: `packages/backend/src/routes/`\n- Rust modules: `packages/desktop/src-tauri/src/`\n- Frontend pages: `packages/frontend/src/pages/`\n- Frontend components: `packages/frontend/src/components/launcher/`\n- Shared types: `shared/src/index.ts`\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **`packages/backend/src/services/java.ts`**: Already detects Java installations. The Rust `java.rs` module provides the same capability natively for the Tauri context, but the backend service can still be used for server-side Java detection.\n- **`packages/backend/src/services/versions.ts`**: Already fetches Mojang version manifest with caching for server JAR versions. The new `VersionService` extends this pattern for client versions.\n- **`packages/backend/src/services/download.ts`**: Existing download service with progress tracking and SHA1 verification. Pattern reused for asset/library downloads.\n- **`packages/backend/src/models/server.ts`**: Existing model pattern (prepared statements, snake_case mapping) reused for instance model.\n- **`packages/frontend/src/pages/CreateServer.tsx`**: Multi-step wizard pattern reused for instance creation wizard.\n- **`packages/backend/src/utils/errors.ts`**: Custom error classes (NotFoundError, etc.) reused in launcher routes.\n\n### Integration Points\n- **Tauri IPC**: Frontend calls Rust commands via `@tauri-apps/api/core` for auth (`ms_auth_start`, `ms_auth_poll`) and launching (`launch_game`). These are new integration points.\n- **Express REST API**: Frontend calls backend for instance CRUD, version listing, download orchestration -- same HTTP pattern as existing server management.\n- **SQLite**: New tables (`launcher_instances`, `launcher_accounts`) alongside existing `servers` and `settings` tables.\n- **OS Keychain**: Rust core uses `tauri-plugin-keychain` for token storage -- completely new integration, no existing equivalent.\n\n## Architecture\n\n### Three-Layer Split\n\n```\n┌──────────────────────────────────────────────────────────┐\n│  Frontend (React)                                        │\n│  ├── LauncherPage         → Instance grid, play button   │\n│  ├── CreateInstanceWizard → Version/loader/config steps  │\n│  ├── AccountManager       → MS auth UI, account list     │\n│  └── DownloadProgress     → File download progress       │\n│       │                         │                        │\n│       │ Tauri IPC               │ HTTP/REST              │\n│       ▼                         ▼                        │\n│  ┌─────────────┐   ┌──────────────────────────────┐     │\n│  │ Rust Core   │   │ Express Backend               │     │\n│  │ (Tauri)     │   │                               │     │\n│  │ ┌─────────┐ │   │ ┌────────────────────────┐   │     │\n│  │ │ auth.rs │ │   │ │ instance-service.ts    │   │     │\n│  │ │ java.rs │ │   │ │ version-service.ts     │   │     │\n│  │ │launcher │ │   │ │ asset-service.ts       │   │     │\n│  │ │  .rs    │ │   │ │ library-service.ts     │   │     │\n│  │ └─────────┘ │   │ └────────────────────────┘   │     │\n│  │      │      │   │            │                  │     │\n│  │  OS Keychain│   │        SQLite DB              │     │\n│  └─────────────┘   └──────────────────────────────┘     │\n└──────────────────────────────────────────────────────────┘\n```\n\n### Authentication Architecture\n\nThe MS authentication chain runs entirely in Rust for security. The frontend only receives non-sensitive data (device code, username, UUID).\n\n```\nFrontend                    Rust Core                    External APIs\n   │                           │                              │\n   ├─ invoke(ms_auth_start) ──►│                              │\n   │                           ├─ POST /devicecode ──────────►│ Microsoft\n   │◄── device_code, url ──────┤◄── device_code ─────────────┤\n   │                           │                              │\n   │  (user visits URL)        │                              │\n   │                           │                              │\n   ├─ invoke(ms_auth_poll) ───►│                              │\n   │                           ├─ POST /token ───────────────►│ Microsoft\n   │                           ├─ POST /user/authenticate ───►│ Xbox Live\n   │                           ├─ POST /xsts/authorize ──────►│ XSTS\n   │                           ├─ POST /login_with_xbox ─────►│ MC Services\n   │                           ├─ GET /minecraft/profile ────►│ MC Services\n   │                           ├─ keychain.set(tokens) ──────►│ OS Keychain\n   │◄── account info ──────────┤                              │\n```\n\n### Game Launch Sequence\n\n```\n1. Frontend: invoke(launch_game, { instanceId, accountId })\n2. Rust: Verify/refresh MC access token (keychain)\n3. Rust: Call backend GET /api/launcher/instances/:id\n4. Rust: Call backend POST /api/launcher/prepare/:id\n   → Backend downloads: version JSON, game JAR, libraries, assets\n   → Backend returns: classpath, mainClass, assetIndex, paths\n5. Rust: Extract native libraries to temp dir\n6. Rust: Build JVM args + game args\n7. Rust: Spawn java process with full command line\n8. Rust: Track process, monitor exit\n9. Rust: On exit → call backend PATCH /api/launcher/instances/:id (update playtime)\n```\n\n### Directory Structure (Data)\n\n```\n{appDataDir}/\n└── launcher/\n    ├── instances/                  # Per-instance (isolated)\n    │   └── {nanoid}/\n    │       ├── saves/\n    │       ├── mods/\n    │       ├── resourcepacks/\n    │       ├── shaderpacks/\n    │       ├── options.txt\n    │       └── servers.dat\n    ├── versions/                   # Shared game JARs\n    │   └── {version}/\n    │       ├── {version}.json\n    │       └── {version}.jar\n    ├── libraries/                  # Shared libraries\n    │   └── {group}/{artifact}/{ver}/{artifact}-{ver}.jar\n    ├── assets/                     # Shared assets\n    │   ├── indexes/{assetIndex}.json\n    │   └── objects/{hash[:2]}/{hash}\n    ├── runtime/                    # Downloaded JVMs\n    │   └── java-{major}/\n    └── natives/                    # Temp native extraction\n        └── {instanceId}-{timestamp}/\n```\n\n### Modular Design Principles\n- **Single File Responsibility**: Each Rust module (`auth.rs`, `java.rs`, `launcher.rs`) handles one concern. Each backend service (`version-service.ts`, `asset-service.ts`, `library-service.ts`, `instance-service.ts`) handles one domain.\n- **Component Isolation**: Frontend launcher components are in their own `components/launcher/` directory, not mixed with server management components.\n- **Service Layer Separation**: Backend services handle business logic and file I/O. Rust core handles OS-level operations (keychain, process spawn). Routes are thin HTTP adapters.\n- **Utility Modularity**: Version inference (`mcVersion -> javaVersion`) is a pure function reusable across backend and Rust.\n\n## Components and Interfaces\n\n### Component 1: Auth Module (`packages/desktop/src-tauri/src/auth.rs`)\n- **Purpose**: Microsoft OAuth2 device code flow, Xbox Live/XSTS auth chain, Minecraft token management, OS keychain storage\n- **Interfaces**:\n  - `ms_auth_start() -> DeviceCodeResponse` -- initiate device code flow\n  - `ms_auth_poll() -> MSAuthStatus` -- poll for auth completion\n  - `ms_auth_refresh(account_uuid) -> ()` -- refresh expired tokens\n  - `get_mc_access_token(account_uuid) -> String` -- retrieve token from keychain\n  - `remove_account(account_uuid) -> ()` -- delete tokens from keychain\n- **Dependencies**: `reqwest`, `tauri-plugin-keychain`, `serde_json`\n- **Reuses**: Pattern from `packages/electron/src/main.ts` (but auth was not implemented in Electron)\n\n### Component 2: Java Manager (`packages/desktop/src-tauri/src/java.rs`)\n- **Purpose**: Detect installed Java versions, download from Adoptium\n- **Interfaces**:\n  - `get_java_installations() -> Vec<JavaInstallation>` -- scan system for JVMs\n  - `download_java(version: u32) -> JavaInstallation` -- download from Adoptium API\n- **Dependencies**: `reqwest`, `std::process::Command`\n- **Reuses**: Detection logic from `packages/backend/src/services/java.ts`\n\n### Component 3: Game Launcher (`packages/desktop/src-tauri/src/launcher.rs`)\n- **Purpose**: Construct and spawn Minecraft game process\n- **Interfaces**:\n  - `launch_game(instance_id, account_id) -> GameProcess` -- full launch sequence\n  - `get_running_games() -> Vec<GameProcess>` -- list active processes\n  - `kill_game(instance_id) -> ()` -- force-stop a running game\n- **Dependencies**: `std::process::Command`, auth module, java module\n- **Reuses**: Process spawning pattern from `packages/backend/src/services/process.ts` (but for Java game client instead of Java server)\n\n### Component 4: Version Service (`packages/backend/src/services/version-service.ts`)\n- **Purpose**: Fetch Mojang version manifest, download/cache version JSONs and client JARs\n- **Interfaces**:\n  - `getManifest() -> VersionManifest` -- cached manifest\n  - `getVersions(type?) -> MinecraftVersion[]` -- filtered version list\n  - `downloadVersionJson(versionId) -> VersionJson` -- download + verify\n  - `downloadGameJar(versionId) -> string` -- download client JAR\n- **Dependencies**: `fetch`, `crypto` (SHA1), `fs`\n- **Reuses**: Caching pattern from existing `packages/backend/src/services/versions.ts`\n\n### Component 5: Asset Service (`packages/backend/src/services/asset-service.ts`)\n- **Purpose**: Download Minecraft assets (textures, sounds, etc.)\n- **Interfaces**:\n  - `downloadAssetIndex(versionJson) -> AssetIndex` -- download index JSON\n  - `downloadAssets(versionJson, onProgress?) -> void` -- download all assets with progress\n- **Dependencies**: `fetch`, `crypto`, `fs`\n- **Reuses**: Download pattern from `packages/backend/src/services/download.ts`\n\n### Component 6: Library Service (`packages/backend/src/services/library-service.ts`)\n- **Purpose**: Download Java libraries, filter by platform rules, extract natives\n- **Interfaces**:\n  - `downloadLibraries(versionJson, onProgress?) -> string[]` -- download + return classpath\n  - `extractNatives(versionJson, nativesDir) -> void` -- extract native libs\n- **Dependencies**: `fetch`, `crypto`, `fs`, `adm-zip`\n- **Reuses**: Platform detection from `os` module\n\n### Component 7: Instance Service (`packages/backend/src/services/instance-service.ts`)\n- **Purpose**: CRUD for game instances, directory management\n- **Interfaces**:\n  - `listInstances() -> LauncherInstance[]`\n  - `createInstance(request) -> LauncherInstance`\n  - `updateInstance(id, updates) -> LauncherInstance`\n  - `deleteInstance(id) -> void`\n- **Dependencies**: Instance model, Version service\n- **Reuses**: Pattern from existing server CRUD service\n\n### Component 8: Instance Model (`packages/backend/src/models/instance.ts`)\n- **Purpose**: SQLite CRUD for `launcher_instances` table\n- **Interfaces**: `getAll()`, `getById()`, `create()`, `update()`, `delete()`\n- **Dependencies**: `better-sqlite3`, `nanoid`\n- **Reuses**: Pattern from `packages/backend/src/models/server.ts`\n\n## Data Models\n\n### launcher_instances (SQLite)\n```sql\nCREATE TABLE launcher_instances (\n  id              TEXT PRIMARY KEY,\n  name            TEXT NOT NULL,\n  mc_version      TEXT NOT NULL,\n  version_type    TEXT NOT NULL DEFAULT 'release',\n  loader          TEXT,\n  loader_version  TEXT,\n  java_version    INTEGER NOT NULL,\n  java_path       TEXT,\n  ram_min         INTEGER NOT NULL DEFAULT 2,\n  ram_max         INTEGER NOT NULL DEFAULT 4,\n  resolution_width  INTEGER,\n  resolution_height INTEGER,\n  jvm_args        TEXT,          -- JSON array\n  game_args       TEXT,          -- JSON array\n  icon            TEXT,\n  last_played     TEXT,\n  total_playtime  INTEGER NOT NULL DEFAULT 0,\n  created_at      TEXT NOT NULL DEFAULT (datetime('now')),\n  updated_at      TEXT NOT NULL DEFAULT (datetime('now'))\n);\n```\n\n### launcher_accounts (SQLite -- metadata only, tokens in keychain)\n```sql\nCREATE TABLE launcher_accounts (\n  id              TEXT PRIMARY KEY,\n  uuid            TEXT NOT NULL UNIQUE,\n  username        TEXT NOT NULL,\n  account_type    TEXT NOT NULL DEFAULT 'msa',\n  last_used       TEXT,\n  created_at      TEXT NOT NULL DEFAULT (datetime('now'))\n);\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Microsoft auth timeout / user cancels**\n   - **Handling**: Device code expires after 15 minutes. Rust returns `MSAuthStatus { status: \"expired\" }`.\n   - **User Impact**: \"Authentication expired. Please try again.\" with retry button.\n\n2. **User doesn't own Minecraft**\n   - **Handling**: GET `/minecraft/profile` returns 404. Rust returns error status.\n   - **User Impact**: \"This Microsoft account does not own Minecraft Java Edition.\"\n\n3. **Token refresh fails (revoked/expired refresh token)**\n   - **Handling**: Rust deletes stale tokens, returns error. Frontend prompts re-authentication.\n   - **User Impact**: \"Session expired. Please sign in again.\"\n\n4. **Asset/library download fails**\n   - **Handling**: Retry once. If still fails, report specific failed files. Partial downloads are cleaned up.\n   - **User Impact**: \"Failed to download 3 files. [Retry] [Details]\"\n\n5. **Wrong Java version / Java not found**\n   - **Handling**: Rust checks Java version before launch. If wrong or missing, returns error with required version.\n   - **User Impact**: \"Minecraft 1.21.4 requires Java 21. [Download Java 21] [Select Java Path]\"\n\n6. **Game crashes on launch**\n   - **Handling**: Rust monitors process exit code. Non-zero exit logged. Playtime still updated.\n   - **User Impact**: \"Minecraft exited unexpectedly.\" with link to game logs.\n\n7. **OS keychain unavailable**\n   - **Handling**: Rust falls back to encrypted file in app data dir. Warning logged.\n   - **User Impact**: Yellow banner: \"Secure storage unavailable. Tokens stored with reduced security.\"\n\n## File Structure\n\n### New Files\n```\npackages/desktop/src-tauri/src/\n├── auth.rs                        # MS OAuth2 + Xbox + MC auth chain\n├── java.rs                        # Java detection + Adoptium download\n└── launcher.rs                    # Game process construction + spawning\n\npackages/backend/src/services/\n├── version-service.ts             # Mojang manifest + version JSON/JAR\n├── asset-service.ts               # Asset index + objects download\n├── library-service.ts             # Library download + native extraction\n└── instance-service.ts            # Instance CRUD + directory management\n\npackages/backend/src/models/\n└── instance.ts                    # launcher_instances SQLite model\n\npackages/backend/src/routes/\n└── launcher.ts                    # /api/launcher/* routes\n\npackages/backend/migrations/\n├── 00X_launcher_instances.sql\n└── 00X_launcher_accounts.sql\n\npackages/frontend/src/pages/\n└── Launcher.tsx                   # Main launcher page\n\npackages/frontend/src/components/launcher/\n├── InstanceGrid.tsx               # Instance card grid\n├── InstanceCard.tsx               # Single instance card\n├── CreateInstanceWizard.tsx       # Multi-step instance creation\n├── AccountManager.tsx             # MS auth + account list\n├── DownloadProgress.tsx           # File download progress overlay\n└── LaunchButton.tsx               # Play button with status states\n\nshared/src/index.ts                # LauncherInstance, LauncherAccount, etc. types\n```\n\n### Modified Files\n```\npackages/desktop/src-tauri/src/lib.rs     # Register auth, java, launcher commands\npackages/desktop/src-tauri/Cargo.toml     # Add reqwest, keychain plugin, chrono\npackages/backend/src/app.ts               # Mount /api/launcher routes\nshared/src/index.ts                       # Add launcher types\n```\n\n## Testing Strategy\n\n### Unit Testing\n- No automated test framework exists. Manual testing is the current approach.\n- Auth chain can be tested by running the device code flow manually.\n- Java detection can be tested by running on machines with different Java setups.\n- Version/asset/library services can be tested by downloading a known version.\n\n### Integration Testing\n- **Auth flow**: Sign in with MS account -> verify account appears in list -> verify tokens in keychain\n- **Instance lifecycle**: Create instance -> verify directory created -> update settings -> delete -> verify cleanup\n- **Version downloads**: Create instance with 1.21.4 -> verify version JSON, JAR, libraries, assets downloaded -> verify hashes\n- **Java management**: Detect installed Java -> download Java 21 from Adoptium -> verify installation\n\n### End-to-End Testing\n- **Full launch**: Sign in -> create instance (1.21.4 vanilla) -> click Play -> Minecraft launches -> play briefly -> quit -> verify playtime updated\n- **Mod loader instance**: Create Fabric instance -> verify Fabric loader installed -> launch -> verify Fabric loads\n- **Multi-account**: Sign in with two accounts -> switch between them -> launch with each\n- **Missing Java**: Create instance requiring Java 21 (not installed) -> system offers download -> download -> launch succeeds\n- **Offline resilience**: Launch previously-downloaded version without internet -> game starts (assets cached)\n",
  "fileStats": {
    "size": 19386,
    "lines": 354,
    "lastModified": "2026-02-11T23:34:36.029Z"
  },
  "comments": []
}