{
  "id": "snapshot_1771029096671_l3e1zd2cl",
  "approvalId": "approval_1771029096642_4otfsu6r5",
  "approvalTitle": "Application Logging - Requirements Document",
  "version": 1,
  "timestamp": "2026-02-14T00:31:36.671Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nMC Server Manager currently uses Pino for structured logging across the backend, but all output goes to stdout with no persistence, no request tracing, and no HTTP access logs. In development, `pino-pretty` provides human-readable output, but in production the raw JSON stream is ephemeral — if the process restarts or crashes, all log history is lost.\n\nAs the application grows from a single-user tool into a multi-user community platform (with auth, friends, chat, voice), proper application-level logging becomes essential for debugging production issues, auditing user actions, and understanding system behavior. This spec addresses structured log output to files, HTTP request logging, request correlation across log entries, and log level management — without touching the existing Minecraft server log viewing functionality (which already works well via `LogViewer.tsx` and `logs.ts`).\n\n## Alignment with Project Direction\n\nThis feature directly supports MC Server Manager's growth into a self-hosted community platform. As multi-user features (auth, friends, shared servers) are deployed, operators need visibility into what the application is doing — failed login attempts, permission denials, WebSocket connection issues, and service errors need to be diagnosable without being physically present at the console when they occur.\n\nThis is an infrastructure improvement that benefits all current and future features. It aligns with the \"self-hosted simplicity\" principle: operators shouldn't need external logging infrastructure (ELK stack, Datadog) — the app should handle its own log files responsibly.\n\n### Dependencies\n\n- **Depends on**: None (builds on existing Pino logger)\n- **Depended on by**: No specs depend on this directly, but all future specs benefit from better debugging capabilities\n\n---\n\n## Requirements\n\n### REQ-1: Log File Persistence\n\n**User Story:** As a server operator, I want application logs written to files on disk, so that I can review what happened after a restart, crash, or when I wasn't watching the console.\n\n#### Acceptance Criteria\n\n1. WHEN the backend starts THEN the system SHALL write all log output to a file in a configurable log directory in addition to stdout.\n2. WHEN writing log files THEN the system SHALL use structured JSON format (one JSON object per line, i.e., NDJSON) regardless of whether `pino-pretty` is active for stdout.\n3. WHEN the backend is running in development mode THEN the system SHALL still write to both stdout (with `pino-pretty` formatting) and log files (with JSON formatting) simultaneously.\n4. IF no custom log directory is configured THEN the system SHALL default to `{DATA_DIR}/logs/` for application log files.\n5. WHEN writing log files THEN the system SHALL name them with a date-based pattern (e.g., `app-2026-02-13.log`) so that each day gets its own file.\n\n### REQ-2: Log Rotation and Retention\n\n**User Story:** As a server operator, I want log files to be automatically managed so they don't fill up my disk over time.\n\n#### Acceptance Criteria\n\n1. WHEN a log file exceeds a configurable maximum size (default: 50 MB) THEN the system SHALL rotate to a new file.\n2. WHEN log files are older than a configurable retention period (default: 14 days) THEN the system SHALL automatically delete them.\n3. WHEN the application starts THEN the system SHALL run a cleanup pass to remove expired log files from previous runs.\n4. WHEN log rotation or cleanup occurs THEN the system SHALL log the rotation/cleanup event itself (to the new file) so operators can verify it's working.\n\n### REQ-3: HTTP Request Logging\n\n**User Story:** As a server operator, I want to see which API requests are being made to my server, so that I can debug issues and understand usage patterns.\n\n#### Acceptance Criteria\n\n1. WHEN an HTTP request completes THEN the system SHALL log the method, URL path, response status code, and response time in milliseconds.\n2. WHEN logging HTTP requests THEN the system SHALL include the authenticated user's ID and username (if the request was authenticated) in the log entry.\n3. WHEN logging HTTP requests THEN the system SHALL NOT log request bodies or authorization header values (to avoid logging sensitive data like passwords and tokens).\n4. WHEN an HTTP request results in a 4xx or 5xx response THEN the system SHALL log at `warn` level (4xx) or `error` level (5xx). Successful responses SHALL be logged at `info` level.\n5. WHEN logging HTTP requests THEN the system SHALL exclude health-check or high-frequency polling endpoints (e.g., download progress polling) from `info`-level logging to reduce noise. These SHALL be logged at `debug` level instead.\n\n### REQ-4: Request ID Correlation\n\n**User Story:** As a server operator debugging an issue, I want to trace all log entries related to a single request, so that I can follow the full execution path of a failing operation.\n\n#### Acceptance Criteria\n\n1. WHEN an HTTP request is received THEN the system SHALL generate a unique request ID and attach it to all log entries produced during that request's lifecycle.\n2. WHEN the system generates a request ID THEN it SHALL also include the request ID in the HTTP response headers (e.g., `X-Request-Id`) so that frontend error reports can reference it.\n3. WHEN a WebSocket message is processed THEN the system SHALL generate a message-level correlation ID and attach it to all log entries produced during that message's handling.\n4. IF an incoming HTTP request includes an `X-Request-Id` header THEN the system SHALL use that value instead of generating a new one (to support distributed tracing if a reverse proxy is in front).\n\n### REQ-5: Log Level Configuration\n\n**User Story:** As a server operator, I want to change the application log level at runtime without restarting the server, so that I can temporarily enable debug logging when troubleshooting an issue.\n\n#### Acceptance Criteria\n\n1. WHEN the operator sends a request to change the log level THEN the system SHALL update the active log level immediately without requiring a restart.\n2. WHEN the log level is changed THEN the system SHALL support the standard Pino levels: `fatal`, `error`, `warn`, `info`, `debug`, `trace`.\n3. WHEN the log level is changed at runtime THEN the system SHALL log the change event (at the `info` level, regardless of the new level) including the old and new level values.\n4. WHEN the backend restarts THEN the system SHALL revert to the configured log level (from `LOG_LEVEL` env var or default `info`), not persist runtime changes.\n\n### REQ-6: Sensitive Data Protection\n\n**User Story:** As a server operator, I want to be confident that log files don't contain passwords, tokens, or other secrets, so that I can safely share logs for debugging without worrying about credential leakage.\n\n#### Acceptance Criteria\n\n1. WHEN logging request data THEN the system SHALL redact or omit fields named `password`, `token`, `refreshToken`, `accessToken`, `authorization`, `cookie`, and `secret` from log output.\n2. WHEN logging error stack traces THEN the system SHALL include the full stack trace but SHALL NOT include the error's `cause` chain if it contains request body data.\n3. WHEN a new redaction path is identified (e.g., a new auth-related field) THEN it SHALL be added to a centralized redaction configuration rather than scattered across individual log calls.\n\n---\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility**: Each new file handles one domain (one model, one service, one route file, one component concern)\n- **Modular Design**: Components, services, and models are isolated and reusable across the app\n- **Transport Separation**: Business logic lives in services, not in route handlers or WebSocket handlers\n- **Clear Interfaces**: New modules export typed functions; Electron features flow through the contextBridge preload script\n\n### Performance\n- Log file writes SHALL NOT block the request/response cycle. Asynchronous file I/O or Pino's built-in transport mechanism SHALL be used.\n- The request logging middleware SHALL add less than 2ms of overhead to request processing.\n- Log rotation SHALL happen without interrupting log output (no dropped entries during rotation).\n\n### Security\n- Log files SHALL be created with restrictive file permissions (owner read/write only, `0600`).\n- The log level change endpoint SHALL require authentication and the `owner` or `admin` role.\n- Log file contents SHALL NOT be exposed through any API endpoint (operators access them via filesystem/SSH).\n\n### Reliability\n- IF the log file cannot be written (e.g., disk full, permission denied) THEN the system SHALL continue operating and log a warning to stderr. The application SHALL NOT crash due to logging failures.\n- WHEN the application receives SIGINT/SIGTERM THEN it SHALL flush all pending log writes before exiting.\n- Existing server management functionality SHALL be unaffected by logging changes.\n\n### Usability\n- The existing `LOG_LEVEL` environment variable SHALL continue to work as before.\n- New configuration options (log directory, retention, rotation size) SHALL be configurable via environment variables and/or the existing settings API.\n- No frontend UI changes are required for this spec. Operators manage application logs via the filesystem.\n\n## Migration / Backward Compatibility\n\n- The existing Pino logger singleton (`utils/logger.ts`) is the integration point. All 43+ files importing it will automatically benefit from file persistence and rotation without code changes.\n- The `LOG_LEVEL` environment variable retains its existing behavior.\n- The existing Minecraft server log viewer (`LogViewer.tsx`, `routes/logs.ts`) is **not affected** — it reads from MC server `logs/` directories, which are separate from application log files.\n- No database schema changes are required.\n",
  "fileStats": {
    "size": 9893,
    "lines": 127,
    "lastModified": "2026-02-14T00:31:32.012Z"
  },
  "comments": []
}