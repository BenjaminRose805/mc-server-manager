{
  "id": "snapshot_1771041532753_9pqq6fopo",
  "approvalId": "approval_1771041532738_ypmqv5gti",
  "approvalTitle": "Application Logging - Design",
  "version": 1,
  "timestamp": "2026-02-14T03:58:52.753Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis spec adds consistent, structured logging across the backend and frontend to close the observability gaps identified in the logging audit. On the backend, this means enhancing the existing Pino logger usage: enriching the error middleware with request context, adding logging to silent catch blocks, and instrumenting auth/session/rate-limit middleware. On the frontend, this means creating a lightweight logger utility and replacing silent catch blocks and toast-only error handling with structured log calls.\n\nNo new API endpoints, database tables, WebSocket events, or npm dependencies are introduced. This is purely additive — every change adds logging alongside existing behavior without modifying control flow.\n\n## Steering Document Alignment\n\nPer `tech.md`: Pino 9.x is the established logging library. The design extends its usage to currently-unlogged areas rather than introducing alternatives. Per `structure.md`: new utilities follow the existing pattern — backend utilities in `packages/backend/src/utils/`, frontend utilities in `packages/frontend/src/utils/`. Per `product.md`: self-hosted operators need visibility into their instance without external services, so all logging goes to stdout/console (no SaaS dependencies).\n\n## Code Reuse Analysis\n\n### Existing Code to Leverage\n\n- **`packages/backend/src/utils/logger.ts`**: Existing Pino logger instance. All backend logging additions import from here. No changes needed to this file.\n- **`packages/backend/src/utils/errors.ts`**: `AppError` base class with `statusCode` and `code` properties. The error middleware enhancement reads these fields.\n- **`packages/backend/src/middleware/rate-limit.ts`**: Existing `authRateLimit` using `express-rate-limit`. Will add a `handler` callback for logging rejections.\n- **`packages/backend/src/middleware/auth.ts`**: Existing auth middleware (`requireAuth`, `requireRole`, etc.). Will add `logger.warn` on rejection paths.\n- **`packages/backend/src/ws/handlers.ts`**: Existing WebSocket handlers. Will add logging to auth success/failure and disconnect paths.\n- **`packages/backend/src/services/brute-force.ts`**: Existing brute-force service. Will add logging to lockout detection and attempt recording.\n- **`packages/backend/src/services/session.ts`**: Existing session service. Will add logging to session lifecycle operations.\n- **`packages/frontend/src/components/ErrorBoundary.tsx`**: Existing error boundary. Will replace `console.error` with the new frontend logger.\n\n### Integration Points\n\n- **Express error middleware** (`app.ts:79-101`): Enhanced to log all errors with request context.\n- **Rate limit middleware** (`rate-limit.ts`): `handler` option added to log rejections.\n- **Auth middleware** (`middleware/auth.ts`): Logger calls added to each rejection branch.\n- **WebSocket handlers** (`ws/handlers.ts`, `ws/index.ts`): Logger calls added to auth and disconnect events.\n- **All frontend catch blocks**: Updated to call the new logger before/alongside existing toast/error-state handling.\n\n### Shared Types Already Available\n\nNo new shared types needed. This spec uses only logging — no cross-package interfaces.\n\n## Architecture\n\n```\nBACKEND (Pino logger — already exists)\n├── app.ts error middleware ─── enhanced with req context logging\n├── middleware/\n│   ├── auth.ts ────────────── add warn logs on rejection\n│   └── rate-limit.ts ─────── add handler callback for rejection logging\n├── services/\n│   ├── brute-force.ts ─────── add logger import + lockout/attempt logging\n│   ├── session.ts ─────────── add logger import + session lifecycle logging\n│   ├── auth.ts ────────────── add debug log for argon2 failures\n│   ├── jwt.ts ─────────────── add debug log for verification failures\n│   ├── server-manager.ts ──── add warn logs in shutdown catch blocks\n│   └── process.ts ─────────── add warn log for stdin write failure\n├── ws/\n│   └── handlers.ts ────────── add auth success/fail + disconnect logging\n└── providers/ + other services ── upgrade empty catches to logger.debug\n\nFRONTEND (new logger utility)\n├── utils/logger.ts ────────── NEW: structured browser logger\n├── components/ErrorBoundary.tsx ── replace console.error with logger\n├── contexts/AuthContext.tsx ────── add logger to silent catch blocks\n├── api/ws.ts ──────────────────── add logger to connection/parse errors\n├── api/client.ts ──────────────── add logger to error paths (optional debug)\n├── pages/*.tsx ─────────────────── add logger to catch blocks\n└── components/*.tsx ────────────── add logger alongside toast notifications\n```\n\n### Design Principles Applied\n\n- **Single File Responsibility**: The frontend logger is a standalone utility. Each file's logging additions are self-contained.\n- **Transport Separation**: No business logic changes. Logging is orthogonal to control flow.\n- **Minimal Surface Area**: No new APIs, no new IPC channels, no new dependencies.\n\n## Components and Interfaces\n\n### Component 1: Frontend Logger (`packages/frontend/src/utils/logger.ts`)\n\n- **Purpose**: Structured browser logging utility with level filtering and consistent output format.\n- **Interfaces**:\n  ```typescript\n  type LogLevel = 'debug' | 'info' | 'warn' | 'error';\n\n  interface LogContext {\n    [key: string]: unknown;\n  }\n\n  interface Logger {\n    debug(message: string, context?: LogContext): void;\n    info(message: string, context?: LogContext): void;\n    warn(message: string, context?: LogContext): void;\n    error(message: string, context?: LogContext): void;\n  }\n\n  export const logger: Logger;\n  ```\n- **Behavior**:\n  - In development: outputs to `console.debug/info/warn/error` with `[LEVEL] message` prefix and context object.\n  - In production: same output (console), but `debug` level is suppressed unless `localStorage.getItem('debug') === 'true'`.\n  - Context objects are passed as the second argument to console methods so they're expandable in DevTools.\n- **Dependencies**: None (zero-dependency utility).\n- **Reuses**: Pattern mirrors the backend's Pino logger interface (level methods with context object).\n\n### Component 2: Enhanced Error Middleware (`packages/backend/src/app.ts`)\n\n- **Purpose**: Log all API errors with request context for debugging.\n- **Changes**:\n  ```typescript\n  // AppError (4xx) — currently not logged at all\n  if (err instanceof AppError) {\n    logger.warn(\n      { statusCode: err.statusCode, code: err.code, method: req.method, path: req.path, userId: req.user?.id },\n      err.message\n    );\n    res.status(err.statusCode).json({ error: err.message, code: err.code });\n    return;\n  }\n\n  // Unexpected errors (5xx) — currently logged but with minimal context\n  logger.error(\n    { err, method: req.method, path: req.path, query: req.query, userId: req.user?.id },\n    \"Unhandled error\"\n  );\n  ```\n- **Dependencies**: Existing `logger` import.\n- **Reuses**: Existing `AppError` class, existing `req.user` from auth middleware.\n\n### Component 3: Rate Limit Logging (`packages/backend/src/middleware/rate-limit.ts`)\n\n- **Purpose**: Log when rate limits reject requests.\n- **Changes**: Add `handler` callback to the `authRateLimit` configuration.\n  ```typescript\n  import { logger } from \"../utils/logger.js\";\n\n  export const authRateLimit = rateLimit({\n    // ...existing config...\n    handler: (req, res) => {\n      logger.warn(\n        { ip: req.ip, path: req.path, method: req.method },\n        \"Auth rate limit exceeded\"\n      );\n      res.status(429).json({ error: \"Too many authentication attempts, please try again later\" });\n    },\n  });\n  ```\n- **Dependencies**: Existing `logger`.\n\n### Component 4: Auth Middleware Logging (`packages/backend/src/middleware/auth.ts`)\n\n- **Purpose**: Log authentication and authorization rejections.\n- **Changes**: Add `logger.warn` calls to each rejection path in `requireAuth`, `requireRole`, `requireOwner`, `requireAdminOrOwner`, `requireServerPermission`.\n  ```typescript\n  // Example in requireAuth:\n  if (!payload) {\n    logger.warn({ path: req.path, method: req.method }, \"Invalid or expired access token\");\n    throw new UnauthorizedError(\"Invalid or expired access token\");\n  }\n  ```\n- **Dependencies**: Existing `logger`.\n\n### Component 5: Session & Brute-Force Logging (`packages/backend/src/services/session.ts`, `packages/backend/src/services/brute-force.ts`)\n\n- **Purpose**: Audit trail for security-sensitive operations.\n- **Changes to `session.ts`**:\n  ```typescript\n  import { logger } from \"../utils/logger.js\";\n\n  // In createSession:\n  logger.info({ userId, sessionId: id }, \"Session created\");\n\n  // In revokeSession:\n  logger.info({ sessionId }, \"Session revoked\");\n\n  // In revokeAllUserSessions:\n  logger.info({ userId, revokedCount: result.changes }, \"All user sessions revoked\");\n\n  // In cleanupExpiredSessions:\n  logger.info({ cleanedUp: result.changes }, \"Expired sessions cleaned up\");\n  ```\n- **Changes to `brute-force.ts`**:\n  ```typescript\n  import { logger } from \"../utils/logger.js\";\n\n  // In isLockedOut, when returning true:\n  logger.warn({ username, ipAddress }, \"Login lockout triggered\");\n\n  // In cleanupOldAttempts:\n  logger.info({ cleanedUp: result.changes }, \"Old login attempts cleaned up\");\n  ```\n\n### Component 6: WebSocket Lifecycle Logging (`packages/backend/src/ws/handlers.ts`)\n\n- **Purpose**: Log WebSocket auth events and disconnections.\n- **Changes**:\n  ```typescript\n  // On successful auth (after authenticatedClients.set):\n  logger.info({ userId: payload.sub, username: payload.username }, \"WebSocket client authenticated\");\n\n  // On failed auth:\n  logger.warn(\"WebSocket auth failed: invalid token\");\n\n  // On auth timeout:\n  logger.warn(\"WebSocket auth timeout — closing connection\");\n\n  // In handleDisconnect:\n  const user = authenticatedClients.get(ws);\n  const subs = clientSubscriptions.get(ws);\n  logger.debug({ userId: user?.id, subscriptionCount: subs?.size ?? 0 }, \"WebSocket client disconnected\");\n  ```\n\n### Component 7: Silent Catch Block Remediation (multiple files)\n\n- **Purpose**: Make currently-silent failures visible in logs.\n- **Files and changes**:\n\n  | File | Lines | Change |\n  |------|-------|--------|\n  | `services/java.ts` | 105, 122, 230, 266, 301, 355, 375, 479, 499 | Add `logger.debug` with probed path/command |\n  | `services/server-manager.ts` | 329 | Add `logger.warn({ serverId: id }, \"Error during graceful stop\")` |\n  | `services/server-manager.ts` | 341 | Add `logger.warn({ serverId: id }, \"Error during force-kill\")` |\n  | `services/process.ts` | 244 | Add `logger.warn({ serverId: this.serverId }, \"Failed to write stop command to stdin\")` |\n  | `services/auth.ts` | 20 | Add `logger.debug(\"Password verification failed — argon2 error\")` |\n  | `services/jwt.ts` | 53 | Add `logger.debug(\"JWT verification failed\")` |\n  | `middleware/cors-config.ts` | 17 | Add `logger.debug({ origin }, \"CORS origin parse failed\")` |\n  | `ws/handlers.ts` | 88 | Add `logger.warn({ raw: raw.slice(0, 200) }, \"Failed to parse WebSocket message as JSON\")` |\n  | `providers/forge.ts` | 131, 400, 410 | Add `logger.debug` for installer/cleanup errors |\n  | `providers/neoforge.ts` | 355, 368 | Add `logger.debug` for installer/cleanup errors |\n\n### Component 8: Frontend Catch Block Remediation (multiple files)\n\n- **Purpose**: Replace silent catches and toast-only catches with structured logging.\n- **Pattern**: Every existing catch block gets a `logger.warn` or `logger.error` call **before** the existing behavior (toast, error state, etc.).\n  ```typescript\n  // BEFORE:\n  } catch (err) {\n    toast.error(\"Failed to load\");\n  }\n\n  // AFTER:\n  } catch (err) {\n    logger.warn(\"Failed to load resource\", {\n      error: err instanceof Error ? err.message : String(err),\n      status: err && typeof err === 'object' && 'status' in err ? (err as { status: number }).status : undefined,\n    });\n    toast.error(\"Failed to load\");\n  }\n  ```\n- **Files**:\n\n  | File | Catch blocks | Change |\n  |------|-------------|--------|\n  | `contexts/AuthContext.tsx` | 106, 139, 160, 204 | Add `logger.warn` for token refresh, logout, status check failures |\n  | `api/ws.ts` | 73 | Add `logger.warn` for JSON parse errors |\n  | `api/ws.ts` | 86 (onerror) | Add `logger.warn` for connection errors |\n  | `api/ws.ts` | 78 (onclose) | Add `logger.debug` for reconnect events with attempt count |\n  | `pages/CreateServer.tsx` | 130, 134, 440 | Add `logger.warn` for silently-caught fetch failures |\n  | `pages/Mods.tsx` | 886, 890, 900 | Add `logger.warn` for silently-caught category/settings failures |\n  | `components/ErrorBoundary.tsx` | 24 | Replace `console.error` with `logger.error` including component stack and route |\n  | `pages/ServerDetail.tsx` | 129, 152 | Add `logger.error` alongside error state |\n  | `pages/Login.tsx` | 33 | Add `logger.warn` for login failures |\n  | `pages/Launcher.tsx` | 24, 43, 59 | Add `logger.warn` alongside toast |\n  | `pages/AppSettings.tsx` | 85, 115 | Add `logger.warn` alongside toast |\n  | `pages/InstanceDetail.tsx` | 75, 89, 238, 466, 491 | Add `logger.warn` alongside toast |\n  | `components/ModList.tsx` | 103, 124, 146, 171, 196, 226 | Add `logger.warn` alongside toast |\n  | `components/ServerControls.tsx` | 71 | Add `logger.warn` alongside toast |\n  | `components/PropertiesForm.tsx` | 63, 147 | Add `logger.warn` alongside toast |\n\n## Data Models\n\nNo new data models. This spec is purely additive logging — no database changes.\n\n## API Endpoints\n\nNo new API endpoints. All changes are internal logging additions.\n\n## WebSocket Events\n\nNo new WebSocket events. Logging is added to existing connection/auth lifecycle.\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Logger itself fails (backend — disk full, stdout broken)**\n   - **Handling**: Pino handles this internally — write failures don't crash the process. No additional handling needed.\n   - **User Impact**: None. The application continues functioning; only log output is lost.\n\n2. **Logger itself fails (frontend — console overridden or unavailable)**\n   - **Handling**: The frontend logger wraps console calls in a try-catch to prevent logging from breaking the app.\n   - **User Impact**: None. Logging is best-effort.\n\n## Verification Strategy\n\n### Build Verification\n\n- `npm run build` must pass with zero errors after implementation.\n- `npm run build -w shared && npm run build -w backend` must compile cleanly.\n- `npm run build -w frontend` must compile cleanly (frontend logger has no type errors).\n\n### Manual Testing Checklist\n\n1. **Backend error middleware**: Send a request to a nonexistent endpoint → server logs show 404 with method, path, and error code.\n2. **Backend error middleware**: Trigger a 500 (e.g., corrupt DB) → server logs show full error with stack, method, path, and query.\n3. **Rate limit logging**: Rapidly POST to `/api/auth/login` 30+ times → server logs show \"Auth rate limit exceeded\" with IP and path.\n4. **Auth middleware logging**: Send a request with an expired/invalid token → server logs show \"Invalid or expired access token\" with path.\n5. **Brute-force logging**: Fail login 5 times → server logs show \"Login lockout triggered\" with username and IP.\n6. **Session logging**: Log in → server logs show \"Session created\" with userId. Log out → \"Session revoked\".\n7. **WebSocket logging**: Connect with valid token → server logs show \"WebSocket client authenticated\". Connect with invalid token → \"WebSocket auth failed\".\n8. **Frontend logger**: Open browser DevTools console. Navigate the app. Trigger an error (e.g., stop the backend and try to navigate) → structured log output appears in console with level, message, and context.\n9. **Frontend AuthContext**: Stop the backend while logged in, wait for token refresh → browser console shows \"Token refresh failed\" with context.\n10. **Frontend ErrorBoundary**: Introduce a temporary rendering error → browser console shows structured error log with component stack.\n\n## Implementation Order\n\n1. **Frontend logger utility** (`packages/frontend/src/utils/logger.ts`) — No dependencies. Foundation for all frontend logging tasks.\n2. **Backend error middleware enhancement** (`app.ts`) — No dependencies on other tasks. Highest-value single change.\n3. **Backend rate-limit + auth middleware logging** (`rate-limit.ts`, `middleware/auth.ts`) — Independent of other tasks.\n4. **Backend session + brute-force logging** (`session.ts`, `brute-force.ts`) — Independent; adds logger import and calls.\n5. **Backend WebSocket lifecycle logging** (`ws/handlers.ts`) — Independent.\n6. **Backend silent catch block remediation** (multiple services/providers) — Independent; touches many files but each change is isolated.\n7. **Frontend silent catch block remediation** (AuthContext, ws.ts, pages, components) — Depends on step 1 (logger utility).\n8. **Frontend ErrorBoundary enhancement** — Depends on step 1 (logger utility).\n\nSteps 1-6 are independent of each other and can be implemented in any order. Steps 7-8 depend on step 1.\n",
  "fileStats": {
    "size": 17489,
    "lines": 323,
    "lastModified": "2026-02-14T03:58:47.281Z"
  },
  "comments": []
}