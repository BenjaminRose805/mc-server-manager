# Tasks Document -- Tauri Desktop App Migration

- [x] 1. Scaffold Tauri desktop workspace
  - Files: `packages/desktop/package.json`, `packages/desktop/src-tauri/tauri.conf.json`, `packages/desktop/src-tauri/Cargo.toml`, `packages/desktop/src-tauri/capabilities/default.json`, `packages/desktop/src-tauri/src/main.rs`, `packages/desktop/src-tauri/src/lib.rs`
  - Create `packages/desktop/` workspace with Tauri 2.0 dependencies
  - Initialize `src-tauri/` with configuration, Cargo.toml, capabilities, and minimal Rust entry points
  - Configure `tauri.conf.json`: window size (1280x800, min 900x600), CSP for localhost:3001, `externalBin` for sidecar, `beforeDevCommand`/`devUrl` pointing to Vite, `frontendDist` pointing to `../../frontend/dist`
  - Configure security capabilities: `shell:allow-execute` for sidecar, `shell:allow-open`, `process:default`
  - Update root `package.json`: add `desktop` to workspaces array
  - Purpose: Establish the Tauri project structure that all subsequent tasks build upon
  - _Leverage: `packages/electron/package.json` for reference on workspace patterns, `plans/EPIC-1-tauri-desktop.md` Phase 1A for exact config values_
  - _Requirements: REQ-1, REQ-7_
  - _Prompt: Implement the task for spec tauri-desktop-migration, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Rust/Tauri Developer with expertise in Tauri 2.0 project setup and monorepo configuration | Task: Scaffold the `packages/desktop/` workspace with Tauri 2.0 project structure. Create `package.json` with `@tauri-apps/api`, `@tauri-apps/plugin-shell`, `@tauri-apps/plugin-process` dependencies and `@tauri-apps/cli` devDep. Initialize `src-tauri/` with `tauri.conf.json` (see design.md for exact config), `Cargo.toml` with tauri 2 + plugins, `capabilities/default.json` for security permissions, and minimal `main.rs`/`lib.rs` stubs. Update root `package.json` to include `packages/desktop` in workspaces. Reference `packages/electron/package.json` for workspace naming pattern (`@mc-server-manager/desktop`). Reference `.spec-workflow/specs/tauri-desktop-migration/design.md` and `plans/EPIC-1-tauri-desktop.md` Phase 1A for exact configuration values. | Restrictions: Do NOT modify any existing packages (backend, frontend, electron, shared). Do NOT install Rust toolchain or run `cargo build` -- just create the files. Do NOT add any Tauri IPC commands beyond what capabilities specify. Use the exact CSP from the EPIC-1 plan. | Success: `packages/desktop/package.json` exists with correct deps, `src-tauri/tauri.conf.json` has correct window config + CSP + externalBin + build commands, `Cargo.toml` has tauri 2 deps, `capabilities/default.json` grants only sidecar + open + process permissions, `main.rs` and `lib.rs` compile-ready stubs exist, root `package.json` includes desktop workspace. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 2. Create backend packaging script
  - Files: `packages/desktop/scripts/package-backend.ts`, `packages/desktop/package.json` (modify)
  - Implement the script that compiles the Express backend into a standalone binary using `@yao-pkg/pkg`
  - Script should: detect current platform via `rustc -Vv`, map to pkg target, build shared + backend, run pkg, copy `better-sqlite3` native addon alongside the binary
  - Output binary named with Rust target triple: `mc-server-backend-{target}{ext}`
  - Add `@yao-pkg/pkg` and `tsx` to desktop devDependencies
  - Add `"package-backend": "tsx scripts/package-backend.ts"` script
  - Purpose: Enable the backend to be bundled as a sidecar binary inside the Tauri app
  - _Leverage: `plans/EPIC-1-tauri-desktop.md` Phase 1B for exact script implementation, `packages/backend/package.json` for build commands_
  - _Requirements: REQ-3_
  - _Prompt: Implement the task for spec tauri-desktop-migration, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Node.js Build Engineer with expertise in `@yao-pkg/pkg` binary packaging and native module bundling | Task: Create `packages/desktop/scripts/package-backend.ts` that packages the Express backend into a standalone Node.js binary. The script must: (1) detect the current platform's Rust target triple via `rustc -Vv`, (2) map it to a pkg target string (node22-linux-x64, node22-macos-arm64, etc.), (3) build shared types and backend, (4) run `npx @yao-pkg/pkg dist/index.js --target {target} --output {binariesDir}/{name}`, (5) copy `better-sqlite3/build/Release/better_sqlite3.node` alongside the binary. Add `@yao-pkg/pkg` (^6.0.0) and `tsx` (^4.0.0) to `packages/desktop/package.json` devDependencies. Add `package-backend` script. Reference `plans/EPIC-1-tauri-desktop.md` Phase 1B for the complete implementation. | Restrictions: Do NOT run the script -- just create it. Do NOT modify backend source code in this task. Do NOT add any platform-specific logic beyond the target mapping table. The script must work on Linux, macOS, and Windows. | Success: Script file exists at `packages/desktop/scripts/package-backend.ts` with correct target mapping for 5 platforms, pkg command is correct, native module copy logic is present, devDependencies are updated. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 3. Implement Rust core -- sidecar lifecycle management
  - Files: `packages/desktop/src-tauri/src/lib.rs`, `packages/desktop/src-tauri/Cargo.toml` (verify deps)
  - Implement `spawn_backend()` function that uses `tauri-plugin-shell` to spawn the sidecar with `TAURI_DATA_DIR`, `NODE_ENV`, and `PORT` env vars
  - Implement `AppState` struct with `Mutex<Option<CommandChild>>` for sidecar handle
  - Wire sidecar stdout/stderr to Rust logging
  - Handle `CommandEvent::Terminated` with exit code/signal logging
  - Add dev-mode check: skip sidecar spawn if `TAURI_DEV_BACKEND_EXTERNAL` env var is set
  - Wire `setup()` to call `spawn_backend()`
  - Add `on_window_event` for close-to-tray (hide window, prevent close)
  - Purpose: Core Rust code that manages the backend sidecar process lifecycle
  - _Leverage: `packages/electron/src/main.ts` for equivalent logic patterns, `plans/EPIC-1-tauri-desktop.md` Phase 1C for Rust implementation_
  - _Requirements: REQ-2, REQ-5_
  - _Prompt: Implement the task for spec tauri-desktop-migration, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Rust Developer with expertise in Tauri 2.0 plugin system and process management | Task: Implement the full Rust core in `packages/desktop/src-tauri/src/lib.rs`. This is the heart of the Tauri app. Implement: (1) `AppState` struct with `backend_child: Mutex<Option<CommandChild>>`, (2) `spawn_backend(app: &AppHandle) -> Result<()>` that spawns `binaries/mc-server-backend` sidecar with env vars `TAURI_DATA_DIR` (from `app.path().app_data_dir()`), `NODE_ENV=production`, `PORT=3001`, (3) async task that reads sidecar stdout/stderr and logs via `log::info!`/`log::warn!`, (4) `CommandEvent::Terminated` handler that logs exit code and signal, (5) dev-mode gate: skip spawn if `TAURI_DEV_BACKEND_EXTERNAL` env var is set, (6) `on_window_event` that hides window on `CloseRequested` and calls `api.prevent_close()`, (7) Tauri builder chain with `tauri_plugin_shell::init()` and `tauri_plugin_process::init()`. Reference `plans/EPIC-1-tauri-desktop.md` Phase 1C for the exact Rust code and `.spec-workflow/specs/tauri-desktop-migration/design.md` for architecture. Also reference `packages/electron/src/main.ts` for the equivalent Electron patterns being replicated. | Restrictions: Do NOT add any Tauri IPC commands (no `#[tauri::command]`). Do NOT implement auto-restart of the sidecar. Do NOT add system tray yet (that's task 4). Keep `lib.rs` focused on sidecar + window management only. | Success: `lib.rs` compiles (syntax-correct Rust), sidecar is spawned with correct env vars, stdout/stderr are forwarded to logs, terminated events are logged, dev-mode skip works, window hides on close instead of quitting. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 4. Implement system tray with context menu
  - Files: `packages/desktop/src-tauri/src/lib.rs` (modify)
  - Add system tray icon with "MC Server Manager" tooltip
  - Add context menu: "Show Window" and "Quit" items
  - "Show Window" / left-click: restore and focus main window
  - "Quit": kill backend sidecar child, then exit app
  - Integrate tray setup into the existing Tauri builder chain from task 3
  - Purpose: Allow the app to run in background with tray access while MC servers are running
  - _Leverage: `packages/electron/src/tray.ts` for equivalent tray logic, `plans/EPIC-1-tauri-desktop.md` Phase 1E for Rust tray implementation_
  - _Requirements: REQ-5_
  - _Prompt: Implement the task for spec tauri-desktop-migration, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Rust/Tauri Developer with expertise in system tray integration and menu building | Task: Add system tray to the existing `lib.rs` from task 3. Implement: (1) `TrayIconBuilder` with app default icon, "MC Server Manager" tooltip, (2) context menu with `MenuItem::with_id` for "show" and "quit" items separated by a menu separator, (3) `on_menu_event` handler -- "show" gets webview window "main" and calls `show()` + `set_focus()`, "quit" takes the backend child from `AppState` mutex, kills it, then calls `app.exit(0)`, (4) `on_tray_icon_event` handler -- left click shows and focuses window. Reference `plans/EPIC-1-tauri-desktop.md` Phase 1E for exact Rust code. Reference `packages/electron/src/tray.ts` for the equivalent Electron tray being replicated. Read `.spec-workflow/specs/tauri-desktop-migration/design.md` for component details. | Restrictions: Do NOT add status indicators to the tray icon (no dynamic icon changes). Do NOT add server-specific menu items. Keep the tray minimal: Show + Quit only. Do NOT modify the sidecar management code from task 3 -- only add tray on top. | Success: Tray icon appears with correct tooltip, right-click shows menu with Show Window and Quit, Show restores window, Quit gracefully kills sidecar and exits, left-click on tray restores window. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 5. Add Tauri environment detection to frontend
  - Files: `packages/frontend/src/utils/tauri.ts` (new), `packages/frontend/src/api/ws.ts` (modify)
  - Create `isTauri()` utility that checks `'__TAURI_INTERNALS__' in window`
  - Modify `WsClient.getUrl()` in `ws.ts` to return `ws://localhost:3001/ws` when `isTauri()` is true, otherwise keep existing `window.location`-based URL
  - Purpose: Frontend works correctly in both Tauri WebView (direct URLs) and browser (proxy URLs)
  - _Leverage: `packages/frontend/src/api/ws.ts` (existing WsClient class), `plans/EPIC-1-tauri-desktop.md` Phase 1D_
  - _Requirements: REQ-4_
  - _Prompt: Implement the task for spec tauri-desktop-migration, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Frontend TypeScript Developer with expertise in environment detection and WebSocket configuration | Task: (1) Create `packages/frontend/src/utils/tauri.ts` exporting `isTauri(): boolean` that returns `'__TAURI_INTERNALS__' in window`. (2) Modify `packages/frontend/src/api/ws.ts` -- update the `getUrl()` method in `WsClient` class to check `isTauri()` first. If true, return `'ws://localhost:3001/ws'`. Otherwise keep the existing `window.location`-based URL logic. Import `isTauri` from `../utils/tauri`. Read the current `ws.ts` file first to understand the existing `getUrl()` implementation. Reference `plans/EPIC-1-tauri-desktop.md` Phase 1D for the exact changes. | Restrictions: Do NOT modify the `WsClient` class interface (public methods must stay the same). Do NOT import `@tauri-apps/api` -- detection must be zero-dependency (just window property check). Do NOT modify `api/client.ts` -- it already uses relative URLs which work with both proxy and direct. Do NOT add any conditional imports or dynamic imports. | Success: `tauri.ts` exports `isTauri()`, `ws.ts` imports and uses it in `getUrl()`, WebSocket connects to `ws://localhost:3001/ws` in Tauri and uses location-based URL in browser, no TypeScript errors, existing browser functionality unchanged. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 6. Add backend readiness check and loading screen
  - Files: `packages/frontend/src/utils/wait-for-backend.ts` (new), `packages/frontend/src/main.tsx` (modify), `packages/frontend/index.html` (modify)
  - Create `waitForBackend()` async function that polls `http://localhost:3001/api/system/info` (30 attempts, 500ms interval, 2s fetch timeout)
  - Modify `main.tsx`: wrap render in async `init()` function, call `waitForBackend()` if `isTauri()` before rendering
  - Add loading screen placeholder in `index.html` inside `#root` div (dark background, "MC Server Manager" title, "Starting..." subtitle)
  - Purpose: Smooth startup experience while backend sidecar initializes
  - _Leverage: `packages/electron/src/main.ts` `waitForServer()` function, `packages/frontend/src/main.tsx` (current render), `plans/EPIC-1-tauri-desktop.md` Phase 1D and 1G_
  - _Requirements: REQ-2, REQ-6_
  - _Prompt: Implement the task for spec tauri-desktop-migration, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Frontend Developer with expertise in React app initialization and progressive loading | Task: (1) Create `packages/frontend/src/utils/wait-for-backend.ts` exporting `waitForBackend(url?: string, maxAttempts?: number, intervalMs?: number): Promise<void>`. Default URL: `http://localhost:3001/api/system/info`, default 30 attempts, 500ms interval. Uses `fetch` with `AbortSignal.timeout(2000)`. Throws Error if timeout exceeded. (2) Modify `packages/frontend/src/main.tsx`: wrap the existing `createRoot().render()` call in an async `init()` function. Before rendering, check `isTauri()` -- if true, `await waitForBackend()`. Call `init()` at module level. (3) Modify `packages/frontend/index.html`: add a loading screen inside the `#root` div with inline styles: dark background (#0f172a), centered text, "MC Server Manager" heading, "Starting..." subtitle. React's render replaces this automatically. Read current `main.tsx` and `index.html` first. Reference `plans/EPIC-1-tauri-desktop.md` Phases 1D and 1G. Reference `packages/electron/src/main.ts` `waitForServer()` for equivalent pattern. | Restrictions: Do NOT add any npm dependencies. Do NOT use Tailwind in the loading screen (it's in index.html, before CSS loads) -- use inline styles only. Do NOT block browser-mode startup (only wait in Tauri mode). Do NOT catch the waitForBackend error -- let it propagate to ErrorBoundary. | Success: `wait-for-backend.ts` exports the polling function, `main.tsx` awaits backend in Tauri mode before render, `index.html` shows loading screen that gets replaced by React, browser mode is unaffected (no waiting). Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 7. Add Tauri-aware path resolution to backend config
  - Files: `packages/backend/src/config.ts` (modify)
  - Add `TAURI_DATA_DIR` as an additional env var check in `resolveDataDir()`, checked before `MC_DATA_DIR`
  - Add `TAURI_RESOURCE_DIR` support for migrations directory resolution (if/when needed)
  - Purpose: Backend works correctly as a Tauri sidecar with Tauri-set environment variables
  - _Leverage: `packages/backend/src/config.ts` (current implementation), `plans/EPIC-1-tauri-desktop.md` Phase 1B_
  - _Requirements: REQ-3_
  - _Prompt: Implement the task for spec tauri-desktop-migration, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer with expertise in configuration management and environment-based path resolution | Task: Modify `packages/backend/src/config.ts` to support Tauri sidecar execution. Read the current file first. In the `resolveDataDir()` function, add a check for `TAURI_DATA_DIR` env var -- it should be checked AFTER `DATA_DIR` but BEFORE `MC_DATA_DIR` (priority: DATA_DIR > TAURI_DATA_DIR > MC_DATA_DIR > default). This env var is set by the Tauri Rust core when spawning the sidecar. The Tauri Rust code sets it to `app.path().app_data_dir()`. Reference `plans/EPIC-1-tauri-desktop.md` Phase 1B for the design. Reference `.spec-workflow/specs/tauri-desktop-migration/design.md` for architecture context. | Restrictions: Do NOT remove or reorder existing env var checks (DATA_DIR and MC_DATA_DIR must continue working). Do NOT add any new dependencies. Do NOT modify the config object shape -- only change the internal resolution logic. Keep the change minimal. | Success: `resolveDataDir()` checks `TAURI_DATA_DIR` in correct priority order, existing `DATA_DIR` and `MC_DATA_DIR` still work, no TypeScript errors, backend continues to work identically in dev mode (no env vars set). Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 8. Add dev and build scripts for desktop workflow
  - Files: `package.json` (root, modify)
  - Add `dev:desktop` script using `concurrently` to run backend + Tauri dev
  - Add `build:desktop` script that builds shared -> packages backend -> builds Tauri app
  - Keep existing `dev`, `dev:electron`, `build`, and `build:electron` scripts unchanged
  - Purpose: Developer can run Tauri desktop app with a single command
  - _Leverage: `package.json` (root, existing scripts), `plans/EPIC-1-tauri-desktop.md` Phase 1F_
  - _Requirements: REQ-1, REQ-7_
  - _Prompt: Implement the task for spec tauri-desktop-migration, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: DevOps/Build Engineer with expertise in npm workspaces and monorepo build orchestration | Task: Modify the root `package.json` to add Tauri desktop development and build scripts. Read the current file first. Add: (1) `"dev:desktop": "concurrently -n backend,desktop -c blue,magenta \"npm run dev -w @mc-server-manager/backend\" \"npm run dev -w @mc-server-manager/desktop\""` -- runs backend and Tauri dev in parallel, (2) `"build:desktop": "npm run build -w @mc-server-manager/shared && npm run package-backend -w @mc-server-manager/desktop && npm run build -w @mc-server-manager/desktop"` -- builds in correct dependency order. Reference `plans/EPIC-1-tauri-desktop.md` Phase 1F for exact script definitions. Reference existing `dev:electron` and `build:electron` scripts for naming conventions. | Restrictions: Do NOT modify or remove any existing scripts. Do NOT change the workspaces array (that was done in task 1). Do NOT add any new devDependencies to root. Keep script naming consistent with existing `dev:electron` pattern. | Success: `dev:desktop` starts backend + Tauri concurrently, `build:desktop` builds in correct order (shared -> package-backend -> tauri build), all existing scripts still work, no JSON syntax errors. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 9. Generate app icons and add loading screen branding
  - Files: `packages/desktop/src-tauri/icons/` (new directory with generated icons)
  - Generate platform-specific icons using `@tauri-apps/cli icon` from a source image
  - Required outputs: `32x32.png`, `128x128.png`, `128x128@2x.png`, `icon.icns`, `icon.ico`, `icon.png`
  - Place in `packages/desktop/src-tauri/icons/`
  - Purpose: Professional app appearance in OS taskbar, dock, tray, and installers
  - _Leverage: `plans/EPIC-1-tauri-desktop.md` Phase 1G_
  - _Requirements: REQ-6_
  - _Prompt: Implement the task for spec tauri-desktop-migration, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Desktop App Developer with expertise in app icon generation and Tauri bundling | Task: Generate app icons for the Tauri desktop application. If a source icon exists in the project (check `packages/electron/assets/` or project root for any .png/.svg icon), use `npx @tauri-apps/cli icon {source}` to generate all required sizes. If no source icon exists, create placeholder icons. Required outputs in `packages/desktop/src-tauri/icons/`: `32x32.png`, `128x128.png`, `128x128@2x.png`, `icon.icns` (macOS), `icon.ico` (Windows), `icon.png` (Linux). Verify the `tauri.conf.json` from task 1 references these icon paths correctly in the `bundle.icon` array. Reference `plans/EPIC-1-tauri-desktop.md` Phase 1G. | Restrictions: Do NOT modify `tauri.conf.json` icon paths if they already match (they should from task 1). Do NOT spend time on custom icon design -- use existing project icon or Tauri defaults. Do NOT add icon generation to the build pipeline -- this is a one-time generation step. | Success: `packages/desktop/src-tauri/icons/` directory exists with all required icon files, `tauri.conf.json` bundle.icon paths match the generated files. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 10. Create GitHub Actions CI workflow for desktop builds
  - Files: `.github/workflows/build-desktop.yml` (new)
  - Create CI workflow triggered on `v*` tags
  - Build matrix: Linux (x86_64), macOS (aarch64), Windows (x86_64)
  - Steps: checkout, setup Node 22, setup Rust stable, install Linux deps (libwebkit2gtk, libappindicator3), npm ci, build:desktop, upload artifacts
  - Purpose: Automated cross-platform builds for distribution
  - _Leverage: `plans/EPIC-1-tauri-desktop.md` Phase 1H for exact workflow YAML_
  - _Requirements: REQ-7_
  - _Prompt: Implement the task for spec tauri-desktop-migration, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: DevOps/CI Engineer with expertise in GitHub Actions and cross-platform build pipelines | Task: Create `.github/workflows/build-desktop.yml` for automated Tauri desktop builds. The workflow should: (1) trigger on push of `v*` tags, (2) use a build matrix with 3 entries: ubuntu-latest/x86_64-unknown-linux-gnu, macos-latest/aarch64-apple-darwin, windows-latest/x86_64-pc-windows-msvc, (3) steps: checkout, setup-node@v4 (node 22), dtolnay/rust-toolchain@stable, install Linux WebKitGTK deps (ubuntu only), npm ci, npm run build:desktop, upload-artifact@v4 for the bundle output. Reference `plans/EPIC-1-tauri-desktop.md` Phase 1H for the exact YAML. Check if `.github/workflows/` directory already exists. | Restrictions: Do NOT add secrets or signing configuration. Do NOT add auto-release/publish steps. Do NOT trigger on pull requests (tags only for now). Do NOT modify any existing workflow files. | Success: `.github/workflows/build-desktop.yml` exists with correct trigger, 3-platform matrix, all required steps, Linux-specific dep installation, artifact upload from `packages/desktop/src-tauri/target/release/bundle/`. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._
