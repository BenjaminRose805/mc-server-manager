# Tasks Document

- [x] 1. Clean up shared type duplication
  - Files: `shared/src/index.ts` (modify)
  - Replace `MinecraftVersion` interface with an Omit type alias that excludes `complianceLevel` from `MojangVersionEntry`. Replace `VersionManifest` to use the new `MinecraftVersion` type. Change `LoaderType` to `ModLoader | "quilt"` with JSDoc. Update all downstream import sites in backend and frontend.
  - Purpose: Eliminate duplicate version manifest types and clarify loader type relationship (REQ-4)
  - _Leverage: `shared/src/index.ts` lines 764-856 for current type definitions, `packages/backend/src/services/version-service.ts` and `packages/backend/src/services/versions.ts` for usage of both manifest type families_
  - _Requirements: REQ-4_
  - _Prompt: Implement the task for spec codebase-cleanup, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: TypeScript Developer | Task: Read `shared/src/index.ts` fully. Find these types and make these changes: (1) `MinecraftVersion` (around line 841): Replace the interface with a type alias: `export type MinecraftVersion = Omit` of `MojangVersionEntry` excluding `"complianceLevel"` (standard TypeScript Omit utility type) and add JSDoc: `/** Launcher-side version entry (subset of MojangVersionEntry, no complianceLevel) */`. (2) `VersionManifest` (around line 850): Keep the interface as-is (it already uses `MinecraftVersion[]` — the Omit change is sufficient). (3) `LoaderType` (around line 784): Change from `export type LoaderType = "fabric" | "forge" | "neoforge" | "quilt";` to `export type LoaderType = ModLoader | "quilt";` and add JSDoc: `/** Launcher supports all server mod loaders plus Quilt (client-side only) */`. Then verify all import sites still compile: run `npm run build` from the project root. The key downstream files are `packages/backend/src/services/version-service.ts` (imports `MinecraftVersion`, `VersionManifest`, `VersionType`), `packages/backend/src/models/instance.ts` (imports `LoaderType`), `packages/frontend/src/api/client.ts` (imports `MinecraftVersion`), `packages/frontend/src/components/launcher/CreateInstanceWizard.tsx` (imports `LoaderType`, `MinecraftVersion`). | Restrictions: Do NOT remove any exported type names — existing imports must continue to work. Do NOT change `MojangVersionManifest` or `MojangVersionEntry`. Do NOT change `ModLoader`. Do NOT change `VersionType`. Only modify the three types listed above. | Success: `npm run build` passes with zero errors. `MinecraftVersion` is now a type alias derived from `MojangVersionEntry`. `LoaderType` is derived from `ModLoader`. All downstream packages compile. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 2. Create validation utility and replace boilerplate
  - Files: `packages/backend/src/utils/validation.ts` (new), `packages/backend/src/routes/servers.ts` (modify), `packages/backend/src/routes/auth.ts` (modify), `packages/backend/src/routes/users.ts` (modify), `packages/backend/src/routes/mods.ts` (modify), `packages/backend/src/routes/modpacks.ts` (modify), `packages/backend/src/routes/launcher.ts` (modify), `packages/backend/src/routes/instance-mods.ts` (modify), `packages/backend/src/routes/invitations.ts` (modify), `packages/backend/src/routes/downloads.ts` (modify)
  - Create a `validate()` utility function. Replace all 25 inline Zod validation blocks across 9 route files with calls to it.
  - Purpose: Eliminate DRY violation — 25 identical 5-line blocks (REQ-1)
  - _Leverage: `packages/backend/src/utils/errors.ts` for `ValidationError` class, `packages/backend/src/routes/servers.ts` lines 83-89 for the existing inline pattern_
  - _Requirements: REQ-1_
  - _Prompt: Implement the task for spec codebase-cleanup, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer | Task: (1) Create `packages/backend/src/utils/validation.ts` with this exact function: a generic `validate` function that takes a Zod schema and data, calls `safeParse`, and if it fails, formats the issues as `path: message` joined by `"; "` and throws `new ValidationError(message)`. On success it returns `result.data`. The function signature is `validate(schema: z.ZodSchema, data: unknown)` with a generic type parameter for the return type. Import `z` from `"zod"` and `ValidationError` from `"./errors.js"`. (2) In EVERY route file listed below, find EVERY occurrence of the pattern `const parsed = someSchema.safeParse(req.body); if (!parsed.success) { const message = parsed.error.issues.map(...).join(...); throw new AppError(message, 400, "VALIDATION_ERROR"); } const body/data = parsed.data;` and replace it with `const body/data = validate(someSchema, req.body);`. Add `import { validate } from "../utils/validation.js";` to each file. Remove the `AppError` import if it's no longer used in that file (check all usages first). Route files to update: `routes/servers.ts` (4 occurrences), `routes/auth.ts` (5 occurrences), `routes/users.ts` (3 occurrences), `routes/mods.ts` (2 occurrences), `routes/modpacks.ts` (2 occurrences), `routes/launcher.ts` (4 occurrences), `routes/instance-mods.ts` (3 occurrences), `routes/invitations.ts` (1 occurrence), `routes/downloads.ts` (1 occurrence). Total: 25 replacements. | Restrictions: Do NOT change the validation error message format — it must produce the same `"path: message; path2: message2"` output. Do NOT change any route behavior beyond the validation pattern. The `validate()` function must throw `ValidationError` (which already sets status 400 and code `VALIDATION_ERROR`). Keep each file's existing non-validation `AppError` usages intact. Use `.js` extension in all imports. | Success: `npm run build` passes. `npm test` passes. Zero occurrences of `parsed.error.issues.map` remain in `packages/backend/src/routes/`. All 25 validation blocks replaced. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 3. Add route param and query validation
  - Files: `packages/backend/src/routes/versions.ts` (modify), `packages/backend/src/routes/system.ts` (modify), `packages/backend/src/routes/users.ts` (modify)
  - Replace `as ServerType`, `as string | undefined`, and other unsafe param/query casts with Zod validation using the `validate()` utility from task 2.
  - Purpose: Validate all route inputs, not just request bodies (REQ-5)
  - _Leverage: `packages/backend/src/utils/validation.ts` (from task 2), `packages/backend/src/routes/validation.ts` for existing Zod schema patterns_
  - _Requirements: REQ-5_
  - _Prompt: Implement the task for spec codebase-cleanup, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer | Task: Read each file and replace unsafe casts with Zod validation. (1) `routes/versions.ts`: Find `req.params.type as ServerType` (appears ~3 times). Create a `const serverTypeSchema = z.enum(["vanilla", "paper", "fabric", "forge", "neoforge"]);` at the top of the file. Replace each cast with `const serverType = validate(serverTypeSchema, req.params.type);`. Also validate `req.params.mcVersion` where used: `const mcVersion = validate(z.string().min(1), req.params.mcVersion);`. Also validate `req.query.snapshots` where used: parse it as an optional string. (2) `routes/system.ts`: Find `req.query.path as string | undefined` (line ~31). Replace with `const querySchema = z.object({ path: z.string().optional() }); const { path: customPath } = validate(querySchema, req.query);`. Find `updateSettings(req.body)` (line ~58) — add validation: create a `const settingsUpdateSchema = z.object({ javaPath: z.string().optional(), dataDir: z.string().optional(), defaultJvmArgs: z.string().optional(), maxConsoleLines: z.number().optional(), curseforgeApiKey: z.string().optional(), showOverridePreview: z.boolean().optional() });` and validate req.body before passing to `updateSettings()`. (3) `routes/users.ts`: Find `req.query.role as "owner" | "admin" | "member"` and replace with Zod validation: `z.enum(["owner", "admin", "member"]).optional()`. Also find `const id = Array.isArray(req.params.id) ? req.params.id[0] : req.params.id;` and simplify to `const id = req.params.id;` (Express params are never arrays). Import `validate` from `../utils/validation.js` and `z` from `zod` in each file. | Restrictions: Do NOT change any route behavior beyond replacing unsafe casts with validation. Do NOT change response formats. Keep existing error handling for business logic. Use `.js` extension in imports. | Success: `npm run build` passes. `npm test` passes. No `as ServerType`, `as string | undefined` casts remain in route files. All params and queries are validated via Zod. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 4. Migrate provider errors to AppError (external API providers)
  - Files: `packages/backend/src/providers/vanilla.ts` (modify), `packages/backend/src/providers/paper.ts` (modify), `packages/backend/src/providers/fabric.ts` (modify), `packages/backend/src/providers/forge.ts` (modify), `packages/backend/src/providers/neoforge.ts` (modify)
  - Replace all `throw new Error(...)` with appropriate `AppError` subclasses. External API failures → `AppError(msg, 502, "UPSTREAM_ERROR")`. Type mismatch guards → `AppError(msg, 400, "VALIDATION_ERROR")`.
  - Purpose: Service errors carry proper HTTP status codes instead of always 500 (REQ-2, providers)
  - _Leverage: `packages/backend/src/utils/errors.ts` for error classes, `packages/backend/src/providers/vanilla.ts` for the existing provider pattern_
  - _Requirements: REQ-2_
  - _Prompt: Implement the task for spec codebase-cleanup, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer | Task: In each provider file, replace `throw new Error(...)` with the appropriate custom error class. Rules for classification: (a) "X can only handle Y downloads" type guards → `throw new AppError(msg, 400, "INVALID_PROVIDER")` (b) External API HTTP failures ("Failed to fetch X: status") → `throw new AppError(msg, 502, "UPSTREAM_ERROR")` (c) Integrity failures ("SHA mismatch") → `throw new AppError(msg, 502, "INTEGRITY_ERROR")` (d) "No versions found" → `throw new NotFoundError("versions", mcVersion)`. Add `import { AppError, NotFoundError } from "../utils/errors.js";` to each file. Files and counts: `providers/vanilla.ts` (4 throws), `providers/paper.ts` (6 throws), `providers/fabric.ts` (4 throws), `providers/forge.ts` (6 throws), `providers/neoforge.ts` (5 throws). Total: 25 replacements. Do NOT touch `providers/registry.ts` — its throws are guards that should remain raw Error. | Restrictions: Do NOT change any function signatures. Do NOT change the error messages — only wrap them in AppError. Do NOT modify `registry.ts`. Use `.js` extension in imports. | Success: `npm run build` passes. Zero `throw new Error` in the 5 provider files listed. `registry.ts` still uses raw Error. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 5. Migrate service errors to AppError (core services)
  - Files: `packages/backend/src/services/versions.ts` (modify), `packages/backend/src/services/process.ts` (modify), `packages/backend/src/services/java.ts` (modify), `packages/backend/src/services/download.ts` (modify), `packages/backend/src/services/mod-sources/modrinth.ts` (modify), `packages/backend/src/services/mod-sources/curseforge.ts` (modify), `packages/backend/src/services/modpack-parser.ts` (modify)
  - Replace `throw new Error(...)` with appropriate `AppError` subclasses in core service files (not launcher services — those are task 6).
  - Purpose: Service errors carry proper HTTP status codes (REQ-2, core services)
  - _Leverage: `packages/backend/src/utils/errors.ts` for error classes_
  - _Requirements: REQ-2_
  - _Prompt: Implement the task for spec codebase-cleanup, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer | Task: In each service file listed, replace `throw new Error(...)` with appropriate custom error classes. Classification rules: (a) External API failures → `throw new AppError(msg, 502, "UPSTREAM_ERROR")` (b) Resource not found → `throw new NotFoundError(resource, id)` (c) Invalid input/state → `throw new ValidationError(msg)` (d) Integrity errors → `throw new AppError(msg, 502, "INTEGRITY_ERROR")` (e) Cancellation throws (`signal.aborted`, "Cancelled") → LEAVE AS `throw new Error("Cancelled")` — these are caught internally. Files: `services/versions.ts` (2 throws — both upstream errors), `services/process.ts` (4 throws — state guards like "server already running" should be `ConflictError`), `services/java.ts` (5 throws — "Unsupported OS" = ValidationError, API failures = AppError 502), `services/download.ts` (2 throws — both are cancellation, LEAVE AS-IS), `services/mod-sources/modrinth.ts` (1 throw — upstream error), `services/mod-sources/curseforge.ts` (4 throws — "API key not configured" = ValidationError, API failures = AppError 502), `services/modpack-parser.ts` (2 throws — "index not found" = ValidationError). Add necessary imports from `../utils/errors.js`. | Restrictions: Do NOT change `throw new Error("Cancelled")` in download.ts — these are intentional cancellation signals caught by the job runner. Do NOT change function signatures. Do NOT change `database.ts` — its "Database not initialized" guard should remain raw Error. Use `.js` extension in imports. | Success: `npm run build` passes. `npm test` passes. Only cancellation throws and `database.ts` guard remain as raw Error in these files. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 6. Migrate service errors to AppError (launcher services)
  - Files: `packages/backend/src/services/version-service.ts` (modify), `packages/backend/src/services/library-service.ts` (modify), `packages/backend/src/services/asset-service.ts` (modify), `packages/backend/src/services/prepare-service.ts` (modify), `packages/backend/src/services/mod-loader-service.ts` (modify)
  - Replace `throw new Error(...)` with appropriate `AppError` subclasses in launcher-related service files.
  - Purpose: Service errors carry proper HTTP status codes (REQ-2, launcher services)
  - _Leverage: `packages/backend/src/utils/errors.ts` for error classes_
  - _Requirements: REQ-2_
  - _Prompt: Implement the task for spec codebase-cleanup, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer | Task: In each launcher service file, replace `throw new Error(...)` with appropriate custom error classes. Classification rules: (a) External API failures → `throw new AppError(msg, 502, "UPSTREAM_ERROR")` (b) Resource not found ("Version X not found") → `throw new NotFoundError(resource, id)` (c) Missing data in response ("missing libraries field") → `throw new AppError(msg, 502, "UPSTREAM_ERROR")` (d) Cancellation throws (`signal.aborted`, "Cancelled") → LEAVE AS `throw new Error("Cancelled")`. Files: `services/version-service.ts` (8 throws — "Version not found" = NotFoundError, API failures = AppError 502, "No client download" = NotFoundError), `services/library-service.ts` (2 throws — "missing libraries" = AppError 502, download failure = AppError 502), `services/asset-service.ts` (6 throws — "missing assetIndex" = AppError 502, download failures = AppError 502, "No response body" = AppError 502), `services/prepare-service.ts` (5 throws — ALL are `signal.aborted` cancellation checks, LEAVE ALL AS-IS), `services/mod-loader-service.ts` (7 throws — "No loader versions" = NotFoundError, API failures = AppError 502, download failures = AppError 502). Add imports from `../../utils/errors.js` or `../utils/errors.js` as appropriate. | Restrictions: Do NOT change any `throw new Error("Cancelled")` or `signal.aborted` throws in prepare-service.ts. Do NOT change function signatures. Use `.js` extension in imports. | Success: `npm run build` passes. Only cancellation throws remain as raw Error in these files. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 7. Fix type casts in settings.ts and ws/handlers.ts
  - Files: `packages/backend/src/services/settings.ts` (modify), `packages/backend/src/ws/handlers.ts` (modify)
  - Remove `as unknown as AppSettings` double-cast by building result with proper types. Remove `as unknown as WsClientMessage` casts by reading individual message fields with type checks.
  - Purpose: Proper type narrowing instead of unsafe double-casts (REQ-6)
  - _Leverage: `packages/backend/src/services/settings.ts` for current implementation, `packages/backend/src/ws/handlers.ts` lines 152-173 for current switch statement_
  - _Requirements: REQ-6_
  - _Prompt: Implement the task for spec codebase-cleanup, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: TypeScript Developer | Task: (1) In `packages/backend/src/services/settings.ts`: Replace the `getAllSettings()` function body. Instead of building a generic record of mixed types and casting to `AppSettings`, construct the result object directly field by field: `return { javaPath: stored.javaPath ?? DEFAULTS.javaPath, dataDir: stored.dataDir ?? DEFAULTS.dataDir, defaultJvmArgs: stored.defaultJvmArgs ?? DEFAULTS.defaultJvmArgs, maxConsoleLines: stored.maxConsoleLines ? parseInt(stored.maxConsoleLines, 10) || DEFAULTS.maxConsoleLines : DEFAULTS.maxConsoleLines, curseforgeApiKey: stored.curseforgeApiKey ?? DEFAULTS.curseforgeApiKey, showOverridePreview: stored.showOverridePreview ? stored.showOverridePreview === "true" : DEFAULTS.showOverridePreview };`. Keep the `stored` string-to-string record lookup unchanged. Remove the `SETTING_KEYS` iteration loop and the `as unknown as AppSettings` cast. You can also remove the `SETTING_KEYS` constant if it's no longer used elsewhere in the file (check `updateSettings` first — it uses `validKeys` from `SETTING_KEYS`; if so, keep `SETTING_KEYS`). (2) In `packages/backend/src/ws/handlers.ts`: In the switch statement (around line 152), replace the three `as unknown as WsClientMessage` casts with direct field access. Change: `case "subscribe": handleSubscribe(ws, (msg as unknown as WsClientMessage).serverId);` to `case "subscribe": handleSubscribe(ws, typeof msg.serverId === "string" ? msg.serverId : "");`. Same pattern for "unsubscribe". For "command": `handleCommand(ws, typeof msg.serverId === "string" ? msg.serverId : "", typeof msg.command === "string" ? msg.command : "");`. Remove the import of `WsClientMessage` from shared if no longer used in the file. | Restrictions: Do NOT change the behavior of either function. The settings function must return the same values. The WS handlers must pass the same arguments. Do NOT change `updateSettings()`. Use `.js` extension in imports. | Success: `npm run build` passes. Zero `as unknown as` casts remain in these two files. Settings still load correctly. WS message handling still works. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 8. Consolidate frontend API client
  - Files: `packages/frontend/src/api/client.ts` (modify), `packages/frontend/src/api/users.ts` (modify), `packages/frontend/src/api/invitations.ts` (modify), `packages/frontend/src/api/auth.ts` (modify)
  - Merge `request()` and `authFetch()` into a single `request()` with token refresh. Update all `authFetch` import sites.
  - Purpose: Eliminate duplicate fetch wrappers (REQ-3)
  - _Leverage: `packages/frontend/src/api/client.ts` for both current implementations, `packages/frontend/src/api/users.ts` for authFetch usage pattern_
  - _Requirements: REQ-3_
  - _Prompt: Implement the task for spec codebase-cleanup, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: React Frontend Developer | Task: (1) In `packages/frontend/src/api/client.ts`: Merge the two fetch functions into one. Remove the current `request()` (lines 54-83). Rename `authFetch()` to `request()` and remove its `export` keyword (it should be module-private, used only by the `api` object and re-exported for direct use). Add a third parameter `skipRefresh?: boolean` that, when true, skips the 401 refresh logic (used for the refresh endpoint itself). Update the 401 check to: `if (res.status === 401 && !isRefreshing && !skipRefresh && path !== "/api/auth/refresh")`. Export `request` as a named export so other API modules can import it: `export { request }`. Remove the old `export async function authFetch` entirely. (2) In `packages/frontend/src/api/users.ts`: Change `import { authFetch } from "./client.js";` to `import { request } from "./client.js";`. Replace all `authFetch` calls with `request` (preserving generic type parameters). (3) In `packages/frontend/src/api/invitations.ts`: Same change — replace `authFetch` import and calls with `request`. (4) In `packages/frontend/src/api/auth.ts`: Change `import { authFetch } from "./client.js";` to `import { request } from "./client.js";`. Replace the `authFetch` call with `request`. | Restrictions: Do NOT change the `ApiError` class. Do NOT change the `api` object methods — they already call the internal `request()`. Do NOT change `localStorage` key names. The merged `request()` must handle both the simple case (no 401) and the refresh case (401 → refresh → retry) identically to how `authFetch` does today. | Success: `npm run build` passes. Zero occurrences of `authFetch` in the codebase. All API modules use `request()`. Token refresh still works (login, wait for expiry, make API call — should auto-refresh). Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 9. Fix Electron BACKEND_PORT propagation
  - Files: `packages/electron/src/main.ts` (modify)
  - Set `process.env.BACKEND_PORT` after determining the port so `launcher.ts` reads the correct value.
  - Purpose: Game launcher connects to correct backend port (REQ-7)
  - _Leverage: `packages/electron/src/main.ts` line 21 for BACKEND_PORT const, `packages/electron/src/launcher.ts` lines 13-15 for how it reads the env var_
  - _Requirements: REQ-7_
  - _Prompt: Implement the task for spec codebase-cleanup, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Electron Developer | Task: Read `packages/electron/src/main.ts`. Find the `main()` function. After the `setElectronEnv()` call (which sets other env vars), add the line: `process.env.BACKEND_PORT = String(BACKEND_PORT);`. This ensures that when `launcher.ts` reads `process.env.BACKEND_PORT` (at line 13-15), it gets the correct value matching the actual backend port. Place it inside `setElectronEnv()` function body, after the existing env var assignments, OR right after the `setElectronEnv()` call in `main()` — either location works. | Restrictions: Do NOT change the BACKEND_PORT const declaration. Do NOT change launcher.ts. Do NOT change how the port is determined. Just propagate the already-determined value to the environment. | Success: `npm run build` passes. `process.env.BACKEND_PORT` is set before `registerIpcHandlers()` is called. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._

- [x] 10. Verification and final build check
  - Files: Various (read-only verification, fix only if build fails)
  - Run full build and test suite. Verify all cleanup targets are met. Confirm no regressions.
  - Purpose: Ensure everything compiles and integrates correctly
  - _Leverage: Root `package.json` build and test scripts_
  - _Requirements: All_
  - _Prompt: Implement the task for spec codebase-cleanup, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Senior Developer | Task: (1) Run `npm run build` from project root — must succeed with zero errors. (2) Run `npm test` from project root — all existing tests must pass. (3) Verify cleanup targets: (a) Grep for `parsed.error.issues.map` in `packages/backend/src/routes/` — must find zero occurrences. (b) Grep for `as unknown as` in `packages/backend/src/services/settings.ts` and `packages/backend/src/ws/handlers.ts` — must find zero. (c) Grep for `authFetch` in `packages/frontend/src/` — must find zero. (d) Grep for `throw new Error` in `packages/backend/src/providers/` — must find zero (except registry.ts). (e) Grep for `throw new Error` in `packages/backend/src/services/` — only cancellation throws in download.ts and prepare-service.ts, plus the database guard in database.ts, should remain. (f) Verify `shared/src/index.ts` has `LoaderType = ModLoader | "quilt"` (not a standalone union). (g) Verify `MinecraftVersion` is a type alias derived from `MojangVersionEntry` via Omit (excluding complianceLevel). If any check fails, fix the specific issue. | Restrictions: Do NOT make functional changes beyond fixing build/verification failures. This is a verification task. | Success: `npm run build` passes with zero errors. `npm test` passes. All 7 grep checks pass. Mark task as [-] in-progress before starting, log implementation with log-implementation tool after completion, then mark [x] complete._
