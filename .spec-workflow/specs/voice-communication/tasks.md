# Tasks Document -- Voice Communication

- [ ] 1. Add shared voice communication types
  - Files: `shared/src/index.ts` (modify)
  - Add types: `VoiceChannel`, `CreateVoiceChannelRequest`, `UpdateVoiceChannelRequest`, `VoiceTokenRequest`, `VoiceTokenResponse`, `VoiceParticipant`
  - Purpose: Foundation types for the voice communication system
  - _Leverage: `shared/src/index.ts` for existing type patterns, `.spec-workflow/specs/voice-communication/design.md` Data Models section_
  - _Requirements: REQ-1, REQ-2, REQ-6, REQ-8_
   - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: TypeScript Developer with expertise in shared type definitions for monorepo packages | Task: Read `shared/src/index.ts` to understand existing type patterns and exports. Add all voice-related types from `.spec-workflow/specs/voice-communication/design.md` Data Models section: (1) `VoiceChannel` interface with fields: id (string), name (string), description (string or null), maxParticipants (number), position (number), createdBy (string), createdAt (string). (2) `CreateVoiceChannelRequest` interface: name (string), description (optional string), maxParticipants (optional number), position (optional number). (3) `UpdateVoiceChannelRequest` interface: name (optional string), description (optional string), maxParticipants (optional number), position (optional number). (4) `VoiceTokenRequest` interface: channelId (string). (5) `VoiceTokenResponse` interface: token (string), wsUrl (string). (6) `VoiceParticipant` interface: identity (string), name (string), isSpeaking (boolean), isMuted (boolean), audioLevel (number). Export all types. | Restrictions: Do NOT remove or rename any existing types. Do NOT modify existing exports. Follow existing naming and style conventions in the file. | Success: All types compile, all are exported, existing types unchanged, `npm run build -w shared` succeeds._

- [ ] 2. Create database migration for voice channels and LiveKit settings
   - Files: `packages/backend/migrations/012_voice_channels.sql` (new)
  - Create table: `voice_channels` with all columns and foreign key to users
  - Insert default LiveKit settings into settings table
  - Purpose: Database schema for voice communication
   - _Leverage: `packages/backend/migrations/` for existing migration patterns (001-011), `.spec-workflow/specs/voice-communication/design.md` Data Models section, `plans/EPIC-8-voice.md` Phase 8A.3_
  - _Requirements: REQ-1, REQ-7_
   - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Database Engineer with expertise in SQLite schema design | Task: Check existing migrations in `packages/backend/migrations/` to confirm the next number is 012 (006-008 are launcher/client mods, 009 is multi-user, 010 is friends-chat, 011 is shared-servers). Create `012_voice_channels.sql` with: (1) `voice_channels` table: id TEXT PRIMARY KEY, name TEXT NOT NULL, description TEXT, max_participants INTEGER NOT NULL DEFAULT 50, position INTEGER NOT NULL DEFAULT 0, created_by TEXT NOT NULL, created_at TEXT NOT NULL DEFAULT (datetime('now')), FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE. (2) Insert default LiveKit settings into the existing settings table using INSERT OR IGNORE: livekit_api_key (empty string), livekit_api_secret (empty string), livekit_port ('7880'), livekit_rtc_tcp_port ('7881'), livekit_rtc_port_range_start ('50000'), livekit_rtc_port_range_end ('60000'). Reference `plans/EPIC-8-voice.md` Phase 8A.3 for exact schema. | Restrictions: Do NOT modify existing migrations. Use TEXT with DEFAULT (datetime('now')) for created_at (ISO 8601 string, matching existing migration conventions). Foreign key references users table from a prior migration. | Success: SQL is valid, voice_channels table created with correct constraints, LiveKit settings inserted._

- [ ] 3. Create LiveKit binary download script
  - Files: `packages/electron/scripts/download-livekit.ts` (new), `packages/electron/package.json` (modify)
  - Download platform-specific LiveKit server binary for Electron app bundling
  - Purpose: Build-time script to fetch the LiveKit Go binary
  - _Leverage: `plans/EPIC-8-voice.md` Phase 8A.1 for exact implementation_
  - _Requirements: REQ-7_
  - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: DevOps Engineer with expertise in cross-platform build scripts | Task: Create `packages/electron/scripts/download-livekit.ts`. The script detects the current platform via `process.platform` and `process.arch`, maps it to the correct LiveKit release binary name (LIVEKIT_VERSION = '1.7.2'), downloads the binary from GitHub releases, saves it to `packages/electron/binaries/` with the naming convention (`livekit-server-{platform}-{arch}`), and sets executable permissions on Unix. Platform mappings: linux-x64 maps to livekit_1.7.2_linux_amd64, linux-arm64 to linux_arm64, darwin-x64 to darwin_amd64, darwin-arm64 to darwin_arm64, win32-x64 to windows_amd64.exe. Add a `download-livekit` script to `packages/electron/package.json` that runs `tsx scripts/download-livekit.ts`. Reference `plans/EPIC-8-voice.md` Phase 8A.1. | Restrictions: Use Node built-in fetch (no axios). Handle download errors gracefully. Add .exe extension on Windows only. Create binaries directory if it does not exist. | Success: Script downloads correct binary for current platform, saves with correct name, is executable on Unix, npm script registered._

- [ ] 4. Create LiveKit config service and credential management
  - Files: `packages/backend/src/services/livekit-config.ts` (new), `packages/backend/src/services/settings.ts` (modify)
  - Generate LiveKit YAML config, auto-generate API credentials on first run
  - Purpose: LiveKit server configuration and credential lifecycle
  - _Leverage: `plans/EPIC-8-voice.md` Phases 8A.2 and 8A.4 for exact implementation, existing settings service_
  - _Requirements: REQ-7_
  - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer with expertise in service configuration | Task: (A) Create `packages/backend/src/services/livekit-config.ts`. Define `LiveKitConfig` interface with fields: port (number), rtcTcpPort (number), rtcPortRangeStart (number), rtcPortRangeEnd (number), apiKey (string), apiSecret (string), domain (optional string). Implement `generateLiveKitConfig(config: LiveKitConfig, outputPath: string): void` that writes a YAML config file with port, rtc settings (tcp_port, port_range_start, port_range_end, use_external_ip: true), turn settings (enabled if domain provided), keys section mapping apiKey to apiSecret, and logging level info. Implement `generateApiCredentials()` that returns an object with apiKey (format: api_ followed by 16 random hex bytes) and apiSecret (32 random bytes, base64 encoded). (B) Read `packages/backend/src/services/settings.ts`. Add `ensureLiveKitCredentials(): Promise<void>` that checks if livekit_api_key is empty, and if so generates new credentials and stores them via setSetting. Reference `plans/EPIC-8-voice.md` Phases 8A.2 and 8A.4. | Restrictions: Use Node crypto.randomBytes for credential generation. Use fs.writeFileSync for config file. Use `.js` extension in imports. Follow existing settings service patterns. | Success: Config YAML is valid, credentials auto-generated on first run, idempotent on subsequent runs._

- [ ] 5. Create voice channel database model
  - Files: `packages/backend/src/models/voice-channel.ts` (new)
  - Functions: getAllVoiceChannels, getVoiceChannelById, createVoiceChannel, updateVoiceChannel, deleteVoiceChannel
  - Purpose: Data access layer for voice channels
  - _Leverage: Existing model files in `packages/backend/src/models/` for patterns, `plans/EPIC-8-voice.md` Phase 8C.1_
  - _Requirements: REQ-1_
   - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer with expertise in SQLite models | Task: Read existing model files in `packages/backend/src/models/` to understand the pattern (database access, prepared statements). Create `packages/backend/src/models/voice-channel.ts` with functions: (1) `getAllVoiceChannels(): VoiceChannel[]` -- SELECT all ordered by position ASC, created_at ASC. (2) `getVoiceChannelById(id: string): VoiceChannel | null` -- SELECT by id. (3) `createVoiceChannel(name: string, createdBy: string, options?: object with description, maxParticipants, position)` -- INSERT with nanoid for id, let the DB default handle created_at (ISO 8601 string via datetime('now')). Return the created channel. (4) `updateVoiceChannel(id: string, updates: object with optional name, description, maxParticipants, position)` -- dynamic UPDATE building SET clause from provided fields only. Skip if no fields. (5) `deleteVoiceChannel(id: string): void` -- DELETE by id. Map snake_case DB columns to camelCase TypeScript. Reference `plans/EPIC-8-voice.md` Phase 8C.1. | Restrictions: Use prepared statements. Follow existing model patterns exactly. Use `.js` extension in imports. Use nanoid for ID generation. Do NOT set created_at in code — let the DB default handle it. | Success: All CRUD operations compile and work, column mapping correct, dynamic update handles partial updates, created_at is ISO 8601 string._

- [ ] 6. Create voice token generation service
  - Files: `packages/backend/src/services/voice-token.ts` (new)
  - Generate LiveKit JWT tokens with room-scoped grants
  - Purpose: Secure token generation for LiveKit room access
  - _Leverage: `plans/EPIC-8-voice.md` Phase 8C.2 token generation section, livekit-server-sdk docs_
  - _Requirements: REQ-8_
   - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Security Engineer with expertise in JWT and LiveKit | Task: Install livekit-server-sdk: `npm install livekit-server-sdk -w backend`. Create `packages/backend/src/services/voice-token.ts`. Implement `generateVoiceToken(userId: string, username: string, channelId: string): Promise<object with token and wsUrl>`. The function: (1) Reads livekit_api_key and livekit_api_secret from the settings table. (2) Throws an Error with message 'LiveKit credentials not configured' if either is empty. (3) Creates an AccessToken from livekit-server-sdk with identity set to userId, name set to username, and ttl set to '6h'. (4) Adds a grant with roomJoin: true, room: channelId, canPublish: true, canSubscribe: true. (5) Generates the JWT via at.toJwt(). (6) Returns an object with the token string and wsUrl derived from the server's configured address. Read the server's domain/host from config or settings (the same address remote users use to reach the Express API). Use 'wss://' when TLS is enabled, 'ws://' otherwise. Format: '{protocol}://{serverAddress}:{livekitPort}'. Do NOT hardcode 'localhost' — remote users must be able to connect. Reference `plans/EPIC-8-voice.md` Phase 8C.2 token generation code. | Restrictions: Never expose API key/secret to the client. Token must be scoped to the specific room (channelId). Use `.js` extension in imports. Follow existing service patterns. | Success: Token generation produces valid JWT, grants are room-scoped, wsUrl includes correct port and server address, missing credentials throw clear error._

- [ ] 7. Create voice channel REST routes
  - Files: `packages/backend/src/routes/voice.ts` (new), `packages/backend/src/app.ts` (modify)
  - Endpoints: GET/POST /api/voice/channels, PATCH/DELETE /api/voice/channels/:id, POST /api/voice/token
  - Purpose: REST API for voice channel management and token generation
  - _Leverage: Existing route files for patterns, `plans/EPIC-8-voice.md` Phase 8C.2, Zod validation_
  - _Requirements: REQ-1, REQ-8_
   - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer with expertise in Express routing and Zod validation | Task: Read existing route files in `packages/backend/src/routes/` for patterns. (A) Create `packages/backend/src/routes/voice.ts`. All routes require `requireAuth` middleware. Endpoints: (1) `GET /channels` -- return all voice channels via getAllVoiceChannels(). (2) `POST /channels` -- Zod validate body (name: string 1-100 chars, description: optional string max 500, maxParticipants: optional int 2-100, position: optional int). Create channel with req.user.id as createdBy. Return 201. (3) `PATCH /channels/:id` -- check channel exists (404 if not). Zod validate body (partial of create schema). Update and return updated channel. (4) `DELETE /channels/:id` -- check channel exists (404 if not). Delete. Return 204. (5) `POST /token` -- Zod validate body (channelId: string). Check channel exists (404 if not). Verify the requesting user's `is_active` flag is 1 (return 403 if deactivated). Before generating a token, check the channel's `maxParticipants` limit — if enforcement is possible (via LiveKit API query or local tracking), return 409 Conflict if the channel is full. Call generateVoiceToken with req.user.id, req.user.username, channelId. Return token and wsUrl. (B) Read `packages/backend/src/app.ts`. Import voice routes and mount at `/api/voice`. Reference `plans/EPIC-8-voice.md` Phase 8C.2-8C.3. | Restrictions: Use Zod for ALL request body validation. Follow existing route handler try/catch/next pattern. Use `.js` extension in imports. Use requireAuth from auth middleware. | Success: All endpoints compile, Zod validates inputs, auth required on all, channel existence checked before token generation, is_active check enforced, maxParticipants limit checked, routes mounted in app.ts._

- [ ] 8. Wire LiveKit config generation into backend startup
  - Files: `packages/backend/src/index.ts` (modify)
  - Generate LiveKit config YAML and ensure credentials on backend startup
  - Purpose: Backend writes config file that LiveKit sidecar reads
  - _Leverage: `plans/EPIC-8-voice.md` Phase 8B.2, existing startup sequence in index.ts_
  - _Requirements: REQ-7_
  - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Backend Node.js Developer | Task: Read `packages/backend/src/index.ts` to understand the startup sequence. Add LiveKit initialization after database setup: (1) Import ensureLiveKitCredentials from settings service. Call it to auto-generate credentials if needed. (2) Import generateLiveKitConfig from livekit-config service. Import getSetting from settings. (3) Read all LiveKit settings (port, rtcTcpPort, rtcPortRangeStart, rtcPortRangeEnd, apiKey, apiSecret, domain) from the settings table. Parse numeric values with parseInt. (4) Call generateLiveKitConfig with the assembled config object and output path. The path should be `join(process.env.MC_DATA_DIR or './data', 'livekit-config.yaml')`. (5) Log that the config was written. Reference `plans/EPIC-8-voice.md` Phase 8B.2. | Restrictions: Do NOT break existing startup sequence. Add LiveKit init after database initialization but before server listen. Use `.js` extension in imports. Handle missing settings gracefully with defaults. | Success: Backend writes valid livekit-config.yaml on startup, credentials generated on first run, existing startup unaffected._

- [ ] 9. Create frontend voice API client
  - Files: `packages/frontend/src/api/voice.ts` (new)
  - Functions: getVoiceChannels, createVoiceChannel, deleteVoiceChannel, getVoiceToken
  - Purpose: Frontend API layer for voice endpoints
  - _Leverage: `packages/frontend/src/api/client.ts` for existing patterns, `plans/EPIC-8-voice.md` Phase 8D.3_
  - _Requirements: REQ-1, REQ-2, REQ-8_
  - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: React Frontend Developer with expertise in API client design | Task: Read `packages/frontend/src/api/client.ts` for existing fetch wrapper patterns (BASE_URL, headers, error handling, credentials). Create `packages/frontend/src/api/voice.ts` with functions: (1) `getVoiceChannels(): Promise<VoiceChannel[]>` -- GET /api/voice/channels with credentials include. (2) `createVoiceChannel(name: string, options?: object with description and maxParticipants): Promise<VoiceChannel>` -- POST /api/voice/channels. (3) `deleteVoiceChannel(id: string): Promise<void>` -- DELETE /api/voice/channels/:id. (4) `getVoiceToken(channelId: string): Promise<VoiceTokenResponse>` -- POST /api/voice/token with channelId in body. All functions include credentials: 'include' and Content-Type: 'application/json' where needed. Throw on non-ok responses. Reference `plans/EPIC-8-voice.md` Phase 8D.3. | Restrictions: Use the same fetch pattern as existing API clients. Include Authorization bearer token if the existing client pattern uses it. Do NOT duplicate auth header logic. | Success: All API functions compile, match backend endpoint signatures, include auth headers, error handling follows existing patterns._

- [ ] 10. Create voice Zustand store with LiveKit room management
  - Files: `packages/frontend/src/stores/voiceStore.ts` (new)
  - State: channels, currentChannelId, room, participants, localMuted, localDeafened, isConnecting, error
  - Actions: setChannels, joinChannel, leaveChannel, toggleMute, toggleDeafen
  - Purpose: State management for voice features with LiveKit room lifecycle
  - _Leverage: `packages/frontend/src/stores/serverStore.ts` for Zustand patterns, `plans/EPIC-8-voice.md` Phase 8D.2_
  - _Requirements: REQ-2, REQ-3, REQ-5, REQ-6_
  - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: React Frontend Developer with expertise in Zustand state management and WebRTC | Task: Install livekit-client: `npm install livekit-client -w frontend`. Read `packages/frontend/src/stores/serverStore.ts` for the Zustand store pattern. Create `packages/frontend/src/stores/voiceStore.ts`. State fields: channels (VoiceChannel array), currentChannelId (string or null), room (Room or null from livekit-client), participants (Map of string to VoiceParticipant), localMuted (boolean), localDeafened (boolean), isConnecting (boolean), error (string or null). Actions: (1) `setChannels(channels)` -- set channels array. (2) `joinChannel(channelId, token, wsUrl)` -- disconnect existing room if any. Set isConnecting true. Create new Room with adaptiveStream, dynacast, echo cancellation, noise suppression, auto gain control. Register event handlers: TrackSubscribed (attach audio element to body), TrackUnsubscribed (detach elements), ActiveSpeakersChanged (update participant speaking state), ParticipantConnected (add to map), ParticipantDisconnected (remove from map), Disconnected (reset state). Connect to room. Enable microphone. Set room and currentChannelId. Catch errors and set error state. (3) `leaveChannel()` -- disconnect room, reset state. (4) `toggleMute()` -- toggle localMuted, call room.localParticipant.setMicrophoneEnabled. (5) `toggleDeafen()` -- toggle localDeafened, mute all remote audio track elements. Reference `plans/EPIC-8-voice.md` Phase 8D.2. | Restrictions: Follow existing Zustand patterns exactly. Do NOT use immer. Handle Map immutability correctly (create new Map on updates). Clean up audio elements on track unsubscribe. | Success: Store compiles, joinChannel creates LiveKit room with all event handlers, leaveChannel cleans up, mute/deafen toggle correctly._

- [ ] 11. Create VoiceChannelList UI component
  - Files: `packages/frontend/src/components/voice/VoiceChannelList.tsx` (new)
  - Voice channel sidebar with join/leave, participant list, mute/deafen controls
  - Purpose: Primary voice channel UI
  - _Leverage: `plans/EPIC-8-voice.md` Phase 8E.1, Tailwind dark theme patterns, lucide-react icons_
  - _Requirements: REQ-1, REQ-2, REQ-5, REQ-6_
  - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: React Frontend Developer with expertise in chat UIs and Tailwind CSS | Task: Create `packages/frontend/src/components/voice/VoiceChannelList.tsx`. Import voiceStore, voice API client, sonner toast, and lucide-react icons (Volume2, VolumeX, Headphones, Mic, MicOff, PhoneOff, Plus). The component: (1) On mount, fetch voice channels via getVoiceChannels() and call setChannels. (2) Render a sidebar with header "Voice Channels" and a Plus icon button for creating channels. (3) For each channel, show a Volume2 icon, channel name, and a Join button (green bg) or Leave button (PhoneOff icon, red on hover) depending on whether currentChannelId matches. (4) When currentChannelId matches, show the participant list below the channel: each participant as a row with a colored dot (green pulsing if speaking via animate-pulse, gray if not), participant name, and MicOff icon if muted. (5) At the bottom when connected: a control bar with Mute button (Mic/MicOff icon, red bg when muted) and Deafen button (Headphones/VolumeX icon, red bg when deafened). Both call toggleMute/toggleDeafen. (6) handleJoin function: call getVoiceToken(channelId), then joinChannel(channelId, token, wsUrl). Catch and toast errors. Use Tailwind dark theme: bg-slate-900 container, bg-slate-800 active states, slate-700 borders, slate-200 text, green-600 join button, red-600 hover states. Reference `plans/EPIC-8-voice.md` Phase 8E.1. | Restrictions: Use Tailwind classes only (no CSS modules). Use lucide-react for all icons. Use sonner toast for errors. Export as named export. | Success: Component renders channel list, join/leave works, participant list shows with speaking indicators, mute/deafen controls visible when connected._

- [ ] 12. Create VoiceSettings component for audio device selection
  - Files: `packages/frontend/src/components/voice/VoiceSettings.tsx` (new)
  - Input and output device dropdowns using LiveKit Room.getLocalDevices
  - Purpose: Audio device selection UI
  - _Leverage: `plans/EPIC-8-voice.md` Phase 8G.1, existing Tailwind form patterns_
  - _Requirements: REQ-9_
  - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: React Frontend Developer with expertise in audio device management | Task: Create `packages/frontend/src/components/voice/VoiceSettings.tsx`. Import Room from livekit-client and voiceStore. The component: (1) State: inputDevices (MediaDeviceInfo array), outputDevices (MediaDeviceInfo array), selectedInput (string), selectedOutput (string). (2) On mount, call Room.getLocalDevices('audioinput') and Room.getLocalDevices('audiooutput') to populate device lists. Set defaults to first device in each list. (3) handleInputChange: set selectedInput state, if room exists call room.switchActiveDevice('audioinput', deviceId). (4) handleOutputChange: set selectedOutput state, if room exists call room.switchActiveDevice('audiooutput', deviceId). (5) Render two labeled select dropdowns: "Input Device" with input devices, "Output Device" with output devices. Each option shows device.label or "Unknown Device" as fallback. Tailwind dark theme: bg-slate-800 selects, slate-700 borders, slate-200 text. Reference `plans/EPIC-8-voice.md` Phase 8G.1. | Restrictions: Pure component with local state for device selection. Use Tailwind classes only. Do NOT disconnect from room on device change. Export as named export. | Success: Component enumerates audio devices, switching input/output works without disconnection, "Unknown Device" shown for unlabeled devices._

- [ ] 13. Create push-to-talk hook via Electron global shortcuts
  - Files: `packages/frontend/src/hooks/usePushToTalk.ts` (new), `packages/electron/src/ipc.ts` (modify), `packages/electron/src/main.ts` (modify)
  - Global Ctrl+Space shortcut that unmutes on keydown, re-mutes on keyup
  - Purpose: Push-to-talk even when app is not focused
  - _Leverage: `plans/EPIC-8-voice.md` Phases 8F.1-8F.3, Electron globalShortcut module_
  - _Requirements: REQ-4_
  - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Full-stack Developer with expertise in Electron desktop integration | Task: (A) Read `packages/electron/src/main.ts`. Register a global shortcut for "Ctrl+Space" using Electron's `globalShortcut` module. On shortcut event, send a "push-to-talk" IPC event to the renderer with the event type (KeyDown/KeyUp) as payload. (B) Update `packages/electron/src/ipc.ts` to register a push-to-talk IPC handler and expose it in the preload. (C) Create `packages/frontend/src/hooks/usePushToTalk.ts`. Import `isDesktop` from `@/utils/desktop` and voiceStore. The hook: listens for "push-to-talk" Electron IPC events via `window.electronAPI`. On KeyDown payload, call room.localParticipant.setMicrophoneEnabled(true). On KeyUp payload, if localMuted was true before, call room.localParticipant.setMicrophoneEnabled(false). Only active when room exists. Cleanup listener on unmount. Return cleanup function from useEffect. Reference `plans/EPIC-8-voice.md` Phases 8F.1-8F.3. | Restrictions: Global shortcut must work when app is NOT focused. Clean up event listener on component unmount. Do NOT modify existing Electron code beyond adding the shortcut registration. Use `.js` extension in TS imports where needed. | Success: Ctrl+Space unmutes while held, re-mutes on release, works even when app unfocused, cleanup on unmount._

- [ ] 14. Add LiveKit sidecar management to Electron
  - Files: `packages/electron/src/main.ts` (modify), `packages/electron/src/ipc.ts` (modify)
  - Spawn LiveKit server sidecar, graceful shutdown, config polling
  - Purpose: Electron manages LiveKit process lifecycle alongside backend
  - _Leverage: `plans/EPIC-8-voice.md` Phases 8B.1, 8B.3, 8B.4, existing backend lifecycle pattern in `packages/electron/src/main.ts`_
  - _Requirements: REQ-7_
  - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: Electron Developer with expertise in child process management | Task: (A) Read `packages/electron/src/main.ts` to understand the existing backend process spawn pattern (startBackend, graceful shutdown). Make these changes: (1) Add a module-level `livekitProcess` variable to track the LiveKit child process. (2) Create `spawnLiveKit()` function: get the app data dir, build the config path (data_dir/livekit-config.yaml), poll for the config file to exist (check every 500ms for up to 10 seconds -- the backend writes it on startup), spawn the livekit-server binary with args `["--config", config_path]` using `child_process.spawn`, store the child process, forward stdout/stderr to console with "[livekit]" prefix, handle exit event by logging exit code. (3) In app.whenReady(), call spawnLiveKit after starting the backend. (4) In quit/before-quit handler, kill livekitProcess BEFORE killing the backend (LiveKit first, then backend which stops MC servers). (B) Configure electron-builder to include the LiveKit binary in extraResources. Reference `plans/EPIC-8-voice.md` Phases 8B.1, 8B.3, 8B.4. | Restrictions: Do NOT break existing backend process management. LiveKit must start AFTER backend (needs config file). Kill order: LiveKit first, then backend. Config polling must have a timeout (do not block forever). | Success: LiveKit spawned after backend, config polling works, graceful shutdown kills LiveKit before backend, binary bundled in Electron app._

- [ ] 15. Integrate voice UI into application layout and routing
  - Files: `packages/frontend/src/App.tsx` (modify) or main layout component
  - Add VoiceChannelList to the application layout, wire usePushToTalk hook
  - Purpose: Voice UI accessible from main application
  - _Leverage: `plans/EPIC-8-voice.md` Phase 8E.2, existing layout structure_
  - _Requirements: REQ-2, REQ-4_
  - _Prompt: Implement the task for spec voice-communication, first run spec-workflow-guide to get the workflow guide then implement the task: | Role: React Frontend Developer with expertise in application layout composition | Task: Read `packages/frontend/src/App.tsx` and any layout components to understand the current page structure (sidebar, main content area). Make these changes: (1) Import VoiceChannelList from components/voice/VoiceChannelList. Add it to the layout as a right sidebar (w-64 fixed width) or integrate it into an existing sidebar. It should be visible on all authenticated pages. (2) Import usePushToTalk from hooks/usePushToTalk. Call it in the top-level App component or a layout wrapper so push-to-talk is active globally. (3) Optionally add a route or modal for VoiceSettings component, accessible from the voice controls area. Reference `plans/EPIC-8-voice.md` Phase 8E.2. | Restrictions: Do NOT restructure existing routes or layouts. Voice sidebar should not interfere with existing content. VoiceChannelList only renders for authenticated users. Match existing styling conventions. | Success: Voice channel list visible in app layout, push-to-talk active globally, voice settings accessible, existing pages unaffected._
